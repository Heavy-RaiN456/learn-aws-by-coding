<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.10">
<meta name="author" content="真野 智之 (Tomoyuki Mano) &lt;tomoyukimano@gmail.com&gt;">
<title>コードで学ぶAWS入門</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/* Asciidoctor default stylesheet | MIT License | https://asciidoctor.org */
/* Uncomment @import statement to use as custom stylesheet */
/*@import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700";*/
article,aside,details,figcaption,figure,footer,header,hgroup,main,nav,section{display:block}
audio,video{display:inline-block}
audio:not([controls]){display:none;height:0}
html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}
a{background:none}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
abbr[title]{border-bottom:1px dotted}
b,strong{font-weight:bold}
dfn{font-style:italic}
hr{-moz-box-sizing:content-box;box-sizing:content-box;height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type="button"],input[type="reset"],input[type="submit"]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type="checkbox"],input[type="radio"]{box-sizing:border-box;padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,*::before,*::after{-moz-box-sizing:border-box;-webkit-box-sizing:border-box;box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;font-weight:400;font-style:normal;line-height:1;position:relative;cursor:auto;tab-size:4;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0;direction:ltr}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:0}
p{font-family:inherit;font-weight:400;font-size:1em;line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #dddddf;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em;height:0}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{font-size:1em;line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0;font-size:1em}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
abbr,acronym{text-transform:uppercase;font-size:90%;color:rgba(0,0,0,.8);border-bottom:1px dotted #ddd;cursor:help}
abbr{text-transform:none}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote cite{display:block;font-size:.9375em;color:rgba(0,0,0,.6)}
blockquote cite::before{content:"\2014 \0020"}
blockquote cite a,blockquote cite a:visited{color:rgba(0,0,0,.6)}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:solid 1px #dedede}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt{background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{display:table-cell;line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
:not(pre):not([class^=L])>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background:#f7f7f8;-webkit-border-radius:4px;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed;word-wrap:break-word}
:not(pre)>code.nobreak{word-wrap:normal}
:not(pre)>code.nowrap{white-space:nowrap}
pre{color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;line-height:1.45;text-rendering:optimizeSpeed}
pre code,pre pre{color:inherit;font-size:inherit;line-height:inherit}
pre>code{display:block}
pre.nowrap,pre.nowrap pre{white-space:pre;word-wrap:normal}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background:#f7f7f7;border:1px solid #ccc;-webkit-border-radius:3px;border-radius:3px;-webkit-box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em white inset;box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em #fff inset;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin-left:auto;margin-right:auto;margin-top:0;margin-bottom:0;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #dddddf}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #dddddf;padding-bottom:8px}
#header .details{border-bottom:1px solid #dddddf;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:-ms-flexbox;display:-webkit-flex;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #dddddf;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #e7e7e9;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #e7e7e9;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #e7e7e9;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:100%;background:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:rgba(255,255,255,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #e7e7e9}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
details,.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
details>summary:first-of-type{cursor:pointer;display:list-item;outline:none;margin-bottom:.75em}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
table.tableblock #preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:inherit}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #dddddf;color:rgba(0,0,0,.6)}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border-style:solid;border-width:1px;border-color:#e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;-webkit-border-radius:4px;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border-style:solid;border-width:1px;border-color:#dbdbd6;margin-bottom:1.25em;padding:1.25em;background:#f3f3f2;-webkit-border-radius:4px;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock>.content>pre{-webkit-border-radius:4px;border-radius:4px;word-wrap:break-word;overflow-x:auto;padding:1em;font-size:.8125em}
@media screen and (min-width:768px){.literalblock pre,.listingblock>.content>pre{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.listingblock>.content>pre{font-size:1em}}
.literalblock pre,.listingblock>.content>pre:not(.highlight),.listingblock>.content>pre[class="highlight"],.listingblock>.content>pre[class^="highlight "]{background:#f7f7f8}
.literalblock.output pre{color:#f7f7f8;background:rgba(0,0,0,.9)}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:inherit;opacity:.5}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:inherit;opacity:.5}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;-webkit-border-radius:4px;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.prettyprint{background:#f7f7f8}
pre.prettyprint .linenums{line-height:1.45;margin-left:2em}
pre.prettyprint li{background:none;list-style-type:inherit;padding-left:0}
pre.prettyprint li code[data-lang]::before{opacity:1}
pre.prettyprint li:not(:first-child) code[data-lang]::before{display:none}
table.linenotable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.linenotable td[class]{color:inherit;vertical-align:top;padding:0;line-height:inherit;white-space:normal}
table.linenotable td.code{padding-left:.75em}
table.linenotable td.linenos{border-right:1px solid currentColor;opacity:.35;padding-right:.5em}
pre.pygments .lineno{border-right:1px solid currentColor;opacity:.35;display:inline-block;margin-right:.75em}
pre.pygments .lineno::before{content:"";margin-right:-.125em}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock:not(.excerpt)>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.75em;margin-right:.5ex;text-align:right}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract blockquote::before,.quoteblock.excerpt blockquote::before,.quoteblock .quoteblock blockquote::before{display:none}
.quoteblock.abstract blockquote,.quoteblock.abstract p,.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{line-height:1.6;word-spacing:0}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.excerpt>blockquote,.quoteblock .quoteblock{padding:0 0 .25em 1em;border-left:.25em solid #dddddf}
.quoteblock.excerpt,.quoteblock .quoteblock{margin-left:0}
.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{color:inherit;font-size:1.0625rem}
.quoteblock.excerpt .attribution,.quoteblock .quoteblock .attribution{color:inherit;text-align:left;margin-right:0}
table.tableblock{max-width:100%;border-collapse:separate}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content>:last-child{margin-bottom:-1.25em}
td.tableblock>.content>:last-child.sidebarblock{margin-bottom:0}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>thead>tr>.tableblock,table.grid-all>tbody>tr>.tableblock{border-width:0 1px 1px 0}
table.grid-all>tfoot>tr>.tableblock{border-width:1px 1px 0 0}
table.grid-cols>*>tr>.tableblock{border-width:0 1px 0 0}
table.grid-rows>thead>tr>.tableblock,table.grid-rows>tbody>tr>.tableblock{border-width:0 0 1px}
table.grid-rows>tfoot>tr>.tableblock{border-width:1px 0 0}
table.grid-all>*>tr>.tableblock:last-child,table.grid-cols>*>tr>.tableblock:last-child{border-right-width:0}
table.grid-all>tbody>tr:last-child>.tableblock,table.grid-all>thead:last-child>tr>.tableblock,table.grid-rows>tbody>tr:last-child>.tableblock,table.grid-rows>thead:last-child>tr>.tableblock{border-bottom-width:0}
table.frame-all{border-width:1px}
table.frame-sides{border-width:0 1px}
table.frame-topbot,table.frame-ends{border-width:1px 0}
table.stripes-all tr,table.stripes-odd tr:nth-of-type(odd),table.stripes-even tr:nth-of-type(even),table.stripes-hover tr:hover{background:#f8f8f7}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{display:table-cell;line-height:1.6;background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
ol>li p,ul>li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
ul.checklist{margin-left:.625em}
ul.checklist li>p:first-child>.fa-square-o:first-child,ul.checklist li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist li>p:first-child>input[type="checkbox"]:first-child{margin-right:.25em}
ul.inline{display:-ms-flexbox;display:-webkit-box;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:solid 4px #fff;-webkit-box-shadow:0 0 0 1px #ddd;box-shadow:0 0 0 1px #ddd}
.imageblock.left{margin:.25em .625em 1.25em 0}
.imageblock.right{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
.gist .file-data>table{border:0;background:#fff;width:100%;margin-bottom:0}
.gist .file-data>table td.line-data{width:99%}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background:#00fafa}
.black{color:#000}
.black-background{background:#000}
.blue{color:#0000bf}
.blue-background{background:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background:#fa00fa}
.gray{color:#606060}
.gray-background{background:#7d7d7d}
.green{color:#006000}
.green-background{background:#007d00}
.lime{color:#00bf00}
.lime-background{background:#00fa00}
.maroon{color:#600000}
.maroon-background{background:#7d0000}
.navy{color:#000060}
.navy-background{background:#00007d}
.olive{color:#606000}
.olive-background{background:#7d7d00}
.purple{color:#600060}
.purple-background{background:#7d007d}
.red{color:#bf0000}
.red-background{background:#fa0000}
.silver{color:#909090}
.silver-background{background:#bcbcbc}
.teal{color:#006060}
.teal-background{background:#007d7d}
.white{color:#bfbfbf}
.white-background{background:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background:rgba(0,0,0,.8);-webkit-border-radius:100px;border-radius:100px;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background:#fffef7;border-color:#e0e0dc;-webkit-box-shadow:0 1px 4px #e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{-webkit-box-shadow:none!important;box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #dddddf!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media print,amzn-kf8{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
</head>
<body class="article toc2 toc-left">
<div id="header">
<h1>コードで学ぶAWS入門</h1>
<div class="details">
<span id="author" class="author">真野 智之 (Tomoyuki Mano) &lt;tomoyukimano@gmail.com&gt;</span><br>
<span id="revnumber">version 1.0,</span>
<span id="revdate">2021-06-14</span>
</div>
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#_はじめに">1. はじめに</a>
<ul class="sectlevel2">
<li><a href="#_本講義の目的内容">1.1. 本講義の目的・内容</a></li>
<li><a href="#_本講義のフィロソフィー">1.2. 本講義のフィロソフィー</a></li>
<li><a href="#aws_account">1.3. AWSアカウント</a></li>
<li><a href="#environments">1.4. 必要な計算機環境</a></li>
<li><a href="#_前提知識">1.5. 前提知識</a></li>
<li><a href="#_講義に関連する資料">1.6. 講義に関連する資料</a></li>
<li><a href="#_本書で使用するノーテーションなど">1.7. 本書で使用するノーテーションなど</a></li>
</ul>
</li>
<li><a href="#chap_cloud_basics">2. クラウド概論</a>
<ul class="sectlevel2">
<li><a href="#_クラウドとは">2.1. クラウドとは？</a></li>
<li><a href="#_なぜクラウドを使うのか">2.2. なぜクラウドを使うのか？</a></li>
<li><a href="#_どうやってクラウドを使うのか">2.3. どうやってクラウドを使うのか？</a></li>
</ul>
</li>
<li><a href="#_aws入門">3. AWS入門</a>
<ul class="sectlevel2">
<li><a href="#_awsとは">3.1. AWSとは？</a></li>
<li><a href="#_awsの機能サービス">3.2. AWSの機能・サービス</a></li>
<li><a href="#_awsでクラウドを作るときの基本となる部品">3.3. AWSでクラウドを作るときの基本となる部品</a></li>
<li><a href="#_region_と_availability_zone">3.4. Region と Availability Zone</a></li>
<li><a href="#_awsでのクラウド開発">3.5. AWSでのクラウド開発</a></li>
<li><a href="#_cloudformation_と_aws_cdk">3.6. CloudFormation と AWS CDK</a></li>
</ul>
</li>
<li><a href="#sec_first_ec2">4. Hands-on #1: 初めてのEC2インスタンスを起動する</a>
<ul class="sectlevel2">
<li><a href="#handson_01_prep">4.1. 準備</a></li>
<li><a href="#_ssh">4.2. SSH</a></li>
<li><a href="#_アプリケーションの説明">4.3. アプリケーションの説明</a></li>
<li><a href="#_プログラムを実行する">4.4. プログラムを実行する</a></li>
<li><a href="#_講義第一回目のまとめ">4.5. 講義第一回目のまとめ</a></li>
</ul>
</li>
<li><a href="#sec_scientific_computing">5. クラウドで行う科学計算・機械学習</a>
<ul class="sectlevel2">
<li><a href="#_なぜ機械学習をクラウドで行うのか">5.1. なぜ機械学習をクラウドで行うのか？</a></li>
<li><a href="#_gpu_による機械学習の高速化">5.2. GPU による機械学習の高速化</a></li>
</ul>
</li>
<li><a href="#sec_jupyter_and_deep_learning">6. Hands-on #2: AWSでディープラーニングの計算を走らせる</a>
<ul class="sectlevel2">
<li><a href="#_準備">6.1. 準備</a></li>
<li><a href="#_アプリケーションの説明_2">6.2. アプリケーションの説明</a></li>
<li><a href="#_スタックのデプロイ">6.3. スタックのデプロイ</a></li>
<li><a href="#_ログイン">6.4. ログイン</a></li>
<li><a href="#_jupyter_notebook_の起動">6.5. Jupyter notebook の起動</a></li>
<li><a href="#_pytorchはじめの一歩">6.6. PyTorchはじめの一歩</a></li>
<li><a href="#_cpu_vs_gpu_の簡易ベンチマーク">6.7. CPU vs GPU の簡易ベンチマーク</a></li>
<li><a href="#sec_mnist_using_jupyter">6.8. 実践ディープラーニング! MNIST手書き数字認識タスク</a></li>
<li><a href="#_スタックの削除">6.9. スタックの削除</a></li>
</ul>
</li>
<li><a href="#_docker_入門">7. Docker 入門</a>
<ul class="sectlevel2">
<li><a href="#_機械学習の大規模化">7.1. 機械学習の大規模化</a></li>
<li><a href="#_docker_とは">7.2. Docker とは</a></li>
<li><a href="#_docker_チュートリアル">7.3. Docker チュートリアル</a></li>
<li><a href="#_elastic_container_service_ecs">7.4. Elastic Container Service (ECS)</a></li>
</ul>
</li>
<li><a href="#sec_fargate_qabot">8. Hands-on #3: AWSで自動質問回答ボットを走らせる</a>
<ul class="sectlevel2">
<li><a href="#_fargate">8.1. Fargate</a></li>
<li><a href="#_準備_2">8.2. 準備</a></li>
<li><a href="#_transformer_を用いた_question_answering_プログラム">8.3. Transformer を用いた question-answering プログラム</a></li>
<li><a href="#_アプリケーションの説明_3">8.4. アプリケーションの説明</a></li>
<li><a href="#_スタックのデプロイ_2">8.5. スタックのデプロイ</a></li>
<li><a href="#_タスクの実行">8.6. タスクの実行</a></li>
<li><a href="#_タスクの同時実行">8.7. タスクの同時実行</a></li>
<li><a href="#_スタックの削除_2">8.8. スタックの削除</a></li>
<li><a href="#_講義第二回目のまとめ">8.9. 講義第二回目のまとめ</a></li>
</ul>
</li>
<li><a href="#sec_aws_batch">9. Hands-on #4: AWS Batch を使って機械学習のハイパーパラメータサーチを並列化する</a>
<ul class="sectlevel2">
<li><a href="#_auto_scaling_groups_asg">9.1. Auto scaling groups (ASG)</a></li>
<li><a href="#_aws_batch">9.2. AWS Batch</a></li>
<li><a href="#_準備_3">9.3. 準備</a></li>
<li><a href="#_mnist_手書き文字認識_再訪">9.4. MNIST 手書き文字認識 (再訪)</a></li>
<li><a href="#sec_run_mnist_docker_local">9.5. ローカルで Docker を実行</a></li>
<li><a href="#_アプリケーションの説明_4">9.6. アプリケーションの説明</a></li>
<li><a href="#_スタックのデプロイ_3">9.7. スタックのデプロイ</a></li>
<li><a href="#_docker_image_を_ecr_に配置する">9.8. Docker image を ECR に配置する</a></li>
<li><a href="#_job_を実行する_まずはひとつだけ">9.9. Job を実行する (まずはひとつだけ)</a></li>
<li><a href="#_並列にたくさんの_job_を実行する">9.10. 並列にたくさんの Job を実行する</a></li>
<li><a href="#_スタックの削除_3">9.11. スタックの削除</a></li>
</ul>
</li>
<li><a href="#_web_サービスの作り方">10. Web サービスの作り方</a>
<ul class="sectlevel2">
<li><a href="#_ウェブサービスの仕組みtwitter_を例に">10.1. ウェブサービスの仕組み&#8201;&#8212;&#8201;Twitter を例に</a></li>
<li><a href="#sec_rest_api">10.2. REST API</a></li>
</ul>
</li>
<li><a href="#sec_serverless">11. Serverless architecture</a>
<ul class="sectlevel2">
<li><a href="#chap_serverful_cloud">11.1. Serverful クラウド (従来型)</a></li>
<li><a href="#_serverless_クラウドへ">11.2. Serverless クラウドへ</a></li>
<li><a href="#_lambda">11.3. Lambda</a></li>
<li><a href="#_サーバーレスストレージ_s3">11.4. サーバーレスストレージ: S3</a></li>
<li><a href="#_サーバーレスデータベース_dynamodb">11.5. サーバーレスデータベース: DynamoDB</a></li>
<li><a href="#_その他のサーバーレスクラウドの構成要素">11.6. その他のサーバーレスクラウドの構成要素</a></li>
</ul>
</li>
<li><a href="#_hands_on_4_サーバーレス入門">12. Hands-on #4: サーバーレス入門</a>
<ul class="sectlevel2">
<li><a href="#_lambda_ハンズオン">12.1. Lambda ハンズオン</a></li>
<li><a href="#_dynamodb_ハンズオン">12.2. DynamoDB ハンズオン</a></li>
</ul>
</li>
<li><a href="#_hands_on_5_bashoutter">13. Hands-on #5: Bashoutter</a>
<ul class="sectlevel2">
<li><a href="#_準備_4">13.1. 準備</a></li>
<li><a href="#_アプリケーションの説明_5">13.2. アプリケーションの説明</a></li>
<li><a href="#_アプリケーションのデプロイ">13.3. アプリケーションのデプロイ</a></li>
<li><a href="#_api_を送信する">13.4. API を送信する</a></li>
<li><a href="#_大量の_api_リクエストをシミュレートする">13.5. 大量の API リクエストをシミュレートする</a></li>
<li><a href="#_bashoutter_gui_を動かしてみる">13.6. Bashoutter GUI を動かしてみる</a></li>
<li><a href="#_アプリケーションの削除">13.7. アプリケーションの削除</a></li>
<li><a href="#_講義第三回目のまとめ">13.8. 講義第三回目のまとめ</a></li>
</ul>
</li>
<li><a href="#_まとめ">14. まとめ</a></li>
<li><a href="#_appendix">15. Appendix</a>
<ul class="sectlevel2">
<li><a href="#aws_secrets">15.1. AWS のシークレットキーの作成</a></li>
<li><a href="#aws_cli_install">15.2. AWS CLI のインストール</a></li>
<li><a href="#aws_cdk_install">15.3. AWS CDK のインストール</a></li>
<li><a href="#venv_quick_guide">15.4. Python <code>venv</code> クイックガイド</a></li>
</ul>
</li>
<li><a href="#_謝辞">16. 謝辞</a></li>
<li><a href="#_著者紹介">17. 著者紹介</a></li>
<li><a href="#_ライセンス">18. ライセンス</a></li>
</ul>
</div>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>ハンズオンで使うプログラムや教科書のソースコードは以下のウェブページで公開している．</p>
</div>
<div class="paragraph">
<p><a href="https://github.com/tomomano/learn-aws-by-coding" class="bare">https://github.com/tomomano/learn-aws-by-coding</a></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_はじめに">1. はじめに</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_本講義の目的内容">1.1. 本講義の目的・内容</h3>
<div class="paragraph">
<p>本講義は，東京大学計数工学科で2020年度S1/S2タームに開講されている"システム情報工学特論"の一部として行われるものである．</p>
</div>
<div class="paragraph">
<p>本講義(計3回)の目的は，クラウドの初心者を対象とし，クラウドの基礎的な知識・概念を解説する．
また， Amazon Web Service (AWS) の提供するクラウド環境を実例として，具体的なクラウドの利用方法をハンズオンを通して学ぶ．</p>
</div>
<div class="paragraph">
<p>特に，科学・エンジニアリングの学生を対象として，研究などの目的でクラウドを利用するための実践的な手順を紹介する．
知識・理論の説明は最小限に留め，実践を行う中で必要な概念の解説を行う予定である．
受講生が今後，研究などでクラウドを利用する際の，足がかりとなることができればこの講義の目的は十分達成されたことになる．</p>
</div>
<div class="paragraph">
<p>講義スケジュールは以下の通りである．</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 1. 講義スケジュール</caption>
<colgroup>
<col style="width: 20%;">
<col style="width: 40%;">
<col style="width: 40%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top"></th>
<th class="tableblock halign-left valign-top">講義</th>
<th class="tableblock halign-left valign-top">ハンズオン</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">第一回 (6/24)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">クラウドの基礎</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">AWSに自分のサーバーを立ち上げる</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">第二回 (7/1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">クラウドで行う機械学習</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="ulist">
<ul>
<li>
<p>AWS と Jupyter を使って始めるディープラーニング</p>
</li>
<li>
<p>AWS で自動質問回答ボットを作る</p>
</li>
</ul>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">第三回 (7/8)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Serverless Architecture 入門</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">AWSでデータベースを作る (俳句を投稿するSNS "Bashoutter" を作る)</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>講義初回は，クラウドの基礎となる概念・知識を解説する．
セキュリティやネットワークなど，クラウドを利用する上で最低限おさえなければいけないポイントを紹介する．
ハンズオンでは，初めての仮想サーバーをAWSに立ち上げる演習を行う．</p>
</div>
<div class="paragraph">
<p>第二回では，クラウド上で科学計算(特に機械学習)を走らせるための入門となる知識・技術を解説する．
併せて，
<a href="https://www.docker.com/">Docker</a>
とよばれる仮想計算環境に自分のプログラムをパッケージングする手順を説明する．
ハンズオンでは，AWSのクラウドでJupyter notebookを使って簡単な機械学習の計算を走らせる課題を実践する．
さらに，ディープラーニングを用いた自然言語処理により，質問に自動で回答を生成するボットを作成する．</p>
</div>
<div class="paragraph">
<p>第三回では，Serverless architectureと呼ばれる最新のクラウドのアーキテクチャを紹介する．
これは，サーバーの処理能力を負荷に応じてより柔軟に拡大・縮小するための概念であり，それ以前 (Serverfullとしばしば呼ばれる) と質的に異なる設計思想をクラウドに導入するものである．
これの実践として，ハンズオンでは簡単なデータベースをクラウド上に作成する．</p>
</div>
</div>
<div class="sect2">
<h3 id="_本講義のフィロソフィー">1.2. 本講義のフィロソフィー</h3>
<div class="paragraph">
<p>本講義のフィロソフィーを一言で表すなら， <strong>"ロケットで宇宙まで飛んでいって一度地球を眺めてみよう！"</strong> である．</p>
</div>
<div class="paragraph">
<p>どういうことか？</p>
</div>
<div class="paragraph">
<p>ここでいう"地球"とは，クラウドコンピューティングの全体像のことである．
言うまでもなく，クラウドという技術は大変奥が深く，幾多の情報技術・ハードウェア・アルゴリズムが精緻に組み合わさってできた総体である．
クラウドを理解するということは，それら一つ一つの概念を熟知することが求められる．</p>
</div>
<div class="paragraph">
<p>そして，ここでいう"ロケット"とはこの講義のことである．
この講義では，ロケットに乗って宇宙まで飛び立ち，地球(クラウド)の全体を自身の目で眺めてもらう．
その際，ロケットの成り立ちや仕組み(クラウドを支える要素技術)は深くは問わない．
将来，自分が研究などの目的でクラウドを利用することになった時に，改めて学んでもらえば良い．
本講義の目的はむしろ，クラウドの最先端に実際に触れ，そこからどんな景色が見えるか(どんな応用が可能か)を実感してもらうことである．</p>
</div>
<div class="paragraph">
<p>そのような理由で，本講義はとても盛りだくさんなものになっている．
第一回はクラウドの基礎から始め，二回目では一気にレベルアップし機械学習(ディープラーニング)をクラウドで実行する手法を解説する．
さらに第三回目では，サーバーレス・アーキテクチャというここ数年のうちに確立した全く新しいクラウドの設計について解説する．
正直に言って，一学期まるまるを費やして学んでもよいくらいの内容である．</p>
</div>
<div class="paragraph">
<p>が，このロケットにしがみついてきてもらえれば，とてもエキサイティングな景色が見られることを約束したい．</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="imgs/earth_from_earth.jpg" alt="cdk output" width="500">
</div>
<div class="title">Figure 1. 宇宙からみた地球 (Image from NASA <a href="https://www.nasa.gov/image-feature/planet-of-clouds" class="bare">https://www.nasa.gov/image-feature/planet-of-clouds</a>)</div>
</div>
</div>
<div class="sect2">
<h3 id="aws_account">1.3. AWSアカウント</h3>
<div class="paragraph">
<p>今回の講義では，ハンズオン形式で AWS のクラウドを実際に触ってみる．
講義を聞きながら自分も手元でクラウドを動かしてみたい読者は，各自 AWS のアカウントの作成をしていただく．
AWS のアカウントの作成の仕方は <a href="https://aws.amazon.com/jp/register-flow/">このページ</a> を参照．</p>
</div>
<div class="paragraph">
<p>AWS はアカウント作成の際，クレジットカードの登録が求められる．
そのような理由で，講義に際してアカウントの作成は強制ではない．
アカウントを作成した場合，講義で紹介するチュートリアルは多くが無料利用枠分で実行できる．
しかし，一部で数百円程度のコストが発生してしまうものも含まれる．
したがって，これらのチュートリアルを自分で実行するかどうかは，個人の判断に任せる．
講義では，どれが無料で行え，どれがコストが発生しうるものか，明示する．</p>
</div>
<div class="paragraph">
<p>なお，課題の提出や成績の評価に際しては，AWS のアカウントの有無に関係なく評価できるように配慮する．</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>当初は， <a href="https://aws.amazon.com/education/awseducate/">AWS Educate</a>
という教育向けの利用枠を使用することで，コストが発生しない予定だったのだが，
最近システムが変わったようで，AWS Educate 経由で取得したアカウントには制限が設けられ，講義で紹介するチュートリアルが実行できなくなってしまった．
そのような背景で，個人でアカウントの取得をしなければならない状況になってしまった．
その点，ご理解いただきたい．</p>
</div>
<div class="paragraph">
<p>なお， AWS Educate では，学生向けの様々なオンライン学習教材が無料で提供されているので，興味のある読者はぜひ活用していただきたい．</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="environments">1.4. 必要な計算機環境</h3>
<div class="paragraph">
<p>講義では，AWS上にクラウドを展開するハンズオンを実施する．そこで紹介するプログラムを実行するため，以下の計算機環境が必要である．</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>UNIX系コンソール</strong>:
ハンズオンで紹介するコマンドを実行したり，SSHでサーバーにアクセスするため，UNIX系のコンソール環境が必要である．
Mac または Linux のユーザーは，OSに標準搭載のコンソール(ターミナルとも呼ばれる)を使用すればよい．
Windowsのユーザーは，
<a href="https://docs.microsoft.com/en-us/windows/wsl/about">Windows Subsystem for Linux (WSL)</a>
を使って Linux の仮想環境をインストールすることを推奨する．
WSLのインストールについては，
<a href="https://docs.microsoft.com/en-us/windows/wsl/install-win10">公式ドキュメンテーションを参照</a>
のこと．</p>
</li>
<li>
<p><strong>Docker</strong>:
講義ではDockerの使い方を解説する．
予め自身の計算機にDockerのインストールをしておくこと．
Linux/Mac/Windowsのインストール法については <a href="https://docs.docker.com/get-docker/">公式ドキュメンテーション</a>を参照．
執筆時点において，<strong>Windows 10 Home</strong>　へのインストールするには WSL2 バックエンドの設定が必要である．詳細は
<a href="https://docs.docker.com/docker-for-windows/install/">こちらのドキュメンテーションを参照</a>
のこと．</p>
</li>
<li>
<p><strong>Python</strong> (Version 3.6以上)</p>
</li>
<li>
<p><strong>Node.js</strong> (version 10.0以上)</p>
</li>
<li>
<p><strong>AWS CLI</strong> (インストールについては <a href="#aws_cli_install">Section 15.2</a> 参照)</p>
</li>
<li>
<p><strong>AWS CDK</strong> (インストールについては <a href="#aws_cdk_install">Section 15.3</a> 参照)</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="_ハンズオン実行用の_docker_image">1.4.1. ハンズオン実行用の Docker Image</h4>
<div class="paragraph">
<p>Python, Node.js, AWS CDK など，ハンズオンのプログラムを実行するために必要なプログラム/ライブラリがインストール済みの Docker image を用意した．
また，ハンズオンのソースコードもクローン済みである．
Docker の使い方を知っている読者は，これを使えば，諸々のインストールをする必要なく，すぐにハンズオンのプログラムを実行できる．</p>
</div>
<div class="paragraph">
<p>次のコマンドで起動する．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash">docker pull docker.pkg.github.com/tomomano/learn-aws-by-coding/labc:latest</code></pre>
</div>
</div>
<div class="paragraph">
<p>Docker Image は <a href="https://gitlab.com/tomomano/intro-aws/container_registry">GitLab の Container registry</a> においてある．
Docker Image のソースコードは <a href="https://gitlab.com/tomomano/intro-aws/-/tree/master/docker/Dockerfile">こちら</a> にある．</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_前提知識">1.5. 前提知識</h3>
<div class="paragraph">
<p>本講義を行うにあたり，前提知識は特に仮定しない．が，以下の前提知識があるとよりスムーズに理解をすることができるだろう．</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Pythonの基本的な理解</strong>:
本講義ではPythonを使ってプログラムの作成を行う．
使用するライブラリは十分抽象化されており，関数の名前を見ただけで意味が明瞭なものがほとんどであるので，Pythonに詳しくなくても心配する必要はない．</p>
</li>
<li>
<p><strong>Linuxコマンドラインの基礎的な理解</strong>:
クラウドを利用する際，クラウド上に立ち上がるサーバーは基本的にLinuxである．
Linuxのコマンドラインについて知識があると，トラブルシュートなどが容易になる．</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_講義に関連する資料">1.6. 講義に関連する資料</h3>
<div class="paragraph">
<p>ハンズオンで使うプログラム，および教科書とそのソースコードは以下のウェブページで公開している．</p>
</div>
<div class="paragraph">
<p><a href="https://gitlab.com/tomomano/intro-aws" class="bare">https://gitlab.com/tomomano/intro-aws</a></p>
</div>
</div>
<div class="sect2">
<h3 id="_本書で使用するノーテーションなど">1.7. 本書で使用するノーテーションなど</h3>
<div class="ulist">
<ul>
<li>
<p>プログラムのコードやシェルのコマンドは <code>monospace letter</code> で記述する．</p>
</li>
<li>
<p>シェルに入力するコマンドは，それがシェルコマンドであると明示する目的で，先頭に <code>$</code> がつけてある．
<code>$</code> はコマンドをコピー&amp;ペーストするときは除かなければならない．
逆に，コマンドの出力には <code>$</code> はついていない点に留意する．</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>また，以下のような形式で注意やチップスを提供する．</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
追加のコメントなどを記す．
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
発展的な議論やアイディアなどを紹介する．
</td>
</tr>
</table>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
陥りやすいミスなどの注意事項を述べる．
</td>
</tr>
</table>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
絶対に犯してはならないミスを指摘する．
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="chap_cloud_basics">2. クラウド概論</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_クラウドとは">2.1. クラウドとは？</h3>
<div class="imageblock text-center">
<div class="content">
<img src="imgs/cloud_word_art.png" alt="Cloud" width="400">
</div>
</div>
<div class="paragraph">
<p>クラウドとはなにか？
クラウドという言葉は，それ自身がとても広い意味を持つので，厳密な定義付けを行うことは難しい．</p>
</div>
<div class="paragraph">
<p>学術的な意味でのクラウドの定義づけをするとしたら，NIST(米国・国立標準技術研究所) による <a href="https://csrc.nist.gov/publications/detail/sp/800-145/final">The NIST Definition of Cloud Computing</a> が引用されることが多い．
これによると，クラウドとは以下の要件が満たされたハードウェア/ソフトウェアの総体のことをいう．</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>On-demand self-service</strong>
利用者のリクエストに応じて計算資源が自動的に割り当てられる．</p>
</li>
<li>
<p><strong>Broad network access</strong>
利用者はネットワークを通じてクラウドにアクセスできる．</p>
</li>
<li>
<p><strong>Resource pooling</strong>
クラウドプロバイダーは，所有する計算資源を分割することで複数の利用者に計算資源を割り当てる．</p>
</li>
<li>
<p><strong>Rapid elasticity</strong>
利用者のリクエストに応じて，迅速に計算資源の拡大あるいは縮小を行うことができる</p>
</li>
<li>
<p><strong>Measured service</strong>
計算資源の利用量を計測・監視することができる．</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>&#8230;&#8203;と，いわれても抽象的でよくわからないかもしれない．もう少し具体的な話をする．</p>
</div>
<div class="paragraph">
<p>個人が所有する計算機で， CPU の数を増やそうと思ったら，物理的に筐体を開け，CPUソケットを露出させ，新しいCPUに交換する必要があるだろう．
あるいは，ストレージがいっぱいになってしまったら，古いディスクを抜き取り，新しいディスクを挿入する必要がある．
計算機の場所を移動させたときには， LAN ケーブルを差し込まないとネットワークには接続できない．</p>
</div>
<div class="paragraph">
<p>クラウドでは，これらの操作が<strong>プログラムからのコマンドによって実行できる</strong>．
CPUが1000個欲しいと思ったらならば，そのようにクラウドプロバイダーにリクエストを送れば良い．
すると，数分もしないうちに 1000 CPUの計算資源が割り当てられる．
ストレージを1TBから10TBに拡張しようと思ったならば，そのようにコマンドを送ればよい (これは，Google Drive や Dropbox などのサービスなどで馴染みのある人も多いだろう)．
計算資源を使い終わったら，そのことをプロバイダーに伝えれば，割り当て分はすぐさま削除される．
クラウドプロバイダーは，使った計算資源の量を正確にモニタリングしており，その量をもとに利用料金の計算が行われる．</p>
</div>
<div class="paragraph">
<p>このように，クラウドの本質は物理的なハードウェアの仮想化・抽象化であり，利用者はコマンドを通じて，<strong>まるでソフトウェアの一部かのように，物理的なハードウェアの管理・運用を行うことができる</strong>．もちろん，背後では，データセンターに置かれた膨大な数の計算機が大量の電力を消費しながら稼働している．クラウドプロバイダーはデータセンターの計算資源を上手にやりくりし，ソフトウェアとしてのインターフェースをユーザーに提供することで，このような仮想化・抽象化を達成しているわけである．クラウドプロバイダーの視点からすると，大勢のユーザーに計算機を貸し出し，データセンターの稼働率を常時100%に近づけることで，利益率の最大化を図っているのである．</p>
</div>
<div class="paragraph">
<p>著者の言葉で，クラウドの重要な特性を定義するならば，以下のようになる．</p>
</div>
<div class="quoteblock">
<blockquote>
クラウドとは計算機ハードウェアの抽象化である．つまり，物理的なハードウェアをソフトウェアの一部かのように自在に操作・拡大・接続することを可能にする技術である．
</blockquote>
</div>
</div>
<div class="sect2">
<h3 id="_なぜクラウドを使うのか">2.2. なぜクラウドを使うのか？</h3>
<div class="paragraph">
<p>上述のように，クラウドとは自由に計算資源をプログラムを通じて操作することのできる計算環境である．
ここでは，自前のローカル計算環境と比べて，なぜクラウドを使うと良いことがあるのかについて述べたい．</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><strong>自由にサーバーのサイズをスケールできる</strong></p>
<div class="paragraph">
<p>なにか新しいプロジェクトを始めるとき，あらかじめ必要なサーバーのスペックを知るのは難しい．
いきなり大きなサーバーを買うのはリスクが高い．
一方で，小さすぎるサーバーでは，後のアップグレードが面倒である．
クラウドを利用すれば，プロジェクトを進めながら，必要な分だけの計算資源を確保することができる．</p>
</div>
</li>
<li>
<p><strong>自分でサーバーをメンテナンスする必要がない</strong></p>
<div class="paragraph">
<p>悲しいことに，コンピュータとは古くなるものである．最近の技術の進歩の速度からすると，5年も経てば，もはや当時の最新コンピューターも化石と同じである．
5年ごとにサーバーを入れ替えるのは相当な手間である．
またサーバーの停電や故障など不意の障害への対応も必要である．
クラウドでは，そのようなインフラの整備やメンテナンスはプロバイダーが自動でやってくれるので，ユーザーが心配する必要がない．</p>
</div>
</li>
<li>
<p><strong>初期コスト0</strong></p>
<div class="paragraph">
<p>自前の計算環境とクラウドの，経済的なコストのイメージを示したのが <a href="#cloud_economic_curve">Figure 2</a> である．
クラウドを利用する場合の初期コストは基本的に0である．
その後，使った利用量に応じてコストが増大していく．
一方，自前の計算環境では，大きな初期コストが生じる．
その分，初期投資後のコストの増加は，電気利用料やサーバー維持費などに留まるため，クラウドを利用した場合よりも傾きは小さくなる．
自前の計算機では，ある一定期間後，サーバーのアップグレードなどによる支出が生じることがある．
一方，クラウドを利用する場合は，そのような非連続なコストの増大は基本的に生じない．
クラウドのコストのカーブが，自前計算環境のコストのカーブの下にある範囲においては，クラウドを使うことは経済的なコスト削減につながる．</p>
</div>
<div id="cloud_economic_curve" class="imageblock text-center">
<div class="content">
<img src="imgs/cloud_cost.png" alt="Cost" width="500">
</div>
<div class="title">Figure 2. クラウドと自前計算機環境の経済的コストの比較</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>特に，<strong>1.</strong>の点は研究の場面では重要であると筆者は感じる．
研究をやっていて，四六時中計算を走らせ続けるという場合は少ない．
むしろ，新しいアルゴリズムが完成したとき・新しいデータが届いたとき，集中的・突発的に計算タスクが増大することが多いだろう．
そういったときに，フレキシブルに計算力を増強させることができるのは，クラウドを使う大きなメリットである．</p>
</div>
<div class="paragraph">
<p>ここまでクラウドを使うメリットを述べたが，逆に，デメリットというのも当然存在する．</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><strong>クラウドは賢く使わないといけない</strong></p>
<div class="paragraph">
<p><a href="#cloud_economic_curve">Figure 2</a> で示したコストのカーブにあるとおり，使い方によっては自前の計算環境のほうがコスト的に有利な場面は存在しうる．
クラウドを利用する際は，使い終わった計算資源はすぐに削除するなど，利用者が賢く管理を行う必要があり，これを怠ると思いもしない額の請求が届く可能性がある．</p>
</div>
</li>
<li>
<p><strong>セキュリティ</strong></p>
<div class="paragraph">
<p>クラウドは，インターネットを通じて世界のどこからでもアクセスできる状態にあり，セキュリティ管理を怠ると簡単にハッキングの対象となりうる．
ハッキングを受けると，情報流出だけでなく，経済的な損失を被る可能性がある．</p>
</div>
</li>
<li>
<p><strong>ラーニングカーブ</strong></p>
<div class="paragraph">
<p>上記のように，コスト・セキュリティなど，クラウドを利用する際に留意しなければならない点は多い．
賢くクラウドを使うには，十分なクラウドの理解が必要であり，そのラーニングカーブを乗り越える必要がある．</p>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_どうやってクラウドを使うのか">2.3. どうやってクラウドを使うのか？</h3>
<div class="paragraph">
<p>各大学や研究機関では，その機関の構成員向けの大規模計算機サーバーが運用されていることが多い．
このような，特定の組織・団体の内部のみで使用されるクラウドを，プライベートクラウド (private cloud) と呼ぶ．</p>
</div>
<div class="paragraph">
<p>一方，商用のサービスとしてのクラウドも，現在は多くの企業から提供されている．
このような，一般の顧客に向けたクラウドサービスのことを，パブリッククラウド (public cloud) と呼ぶ．
有名なクラウドプラットフォームの例を挙げると， Google社が提供する <a href="https://cloud.google.com/">Google Cloud Platform (GCP)</a>， Microsoft 社が提供する <a href="https://azure.microsoft.com">Azure</a>， Amazon 社が提供する <a href="https://aws.amazon.com">Amazon Web Service (AWS)</a> などがある．</p>
</div>
<div class="paragraph">
<p>プライベートクラウドは，組織の構成員ならば無料もしくは極めて割安のコストで計算を実行できる．
しかし，最大で使用できる計算資源の量は，研究提案の申請により決定される場合が多く，柔軟性に欠ける場合もある．
パブリッククラウドを利用する場合は，プロバイダーの設定した利用料金を支払うことになるが，計算リソースはほとんど上限なく使用することが可能である．</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">コラム: Terminal の語源</div>
<div class="paragraph">
<p>Mac/Linuxなどでコマンドを入力するときに使用する，あの黒い画面のことを Terminal と呼んだりする．
この言葉の語源をご存知だろうか？</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="imgs/terminal.png" alt="Terminal" width="400">
</div>
</div>
<div class="paragraph">
<p>この言葉の語源は，コンピュータが誕生して間もない頃の時代に遡る．その頃のコンピュータというと，何千何万のという数の真空管が接続された，会議室一個分くらいのサイズのマシンであった．そのような高価でメンテが大変な機材であるから，当然みんなでシェアして使うことが前提となる．ユーザーがコンピュータにアクセスするため，マシンからは何本かのケーブルが伸び，それぞれにキーボードとスクリーンが接続されていた&#8230;&#8203; これを <strong>Terminal</strong> と呼んでいたのである．人々は，代わる代わるTerminalの前に座って，計算機との対話を行っていた．</p>
</div>
<div class="paragraph">
<p>時代は流れ，WindowsやMacなどのいわゆるパーソナルコンピュータの出現により，コンピュータはみんなで共有するものではなく，個人が所有するものになった．</p>
</div>
<div class="paragraph">
<p>最近のクラウドの台頭は，みんなで大きなコンピュータをシェアするという，最初のコンピュータの使われ方に原点回帰していると捉えることもできる．一方で，スマートフォンやウェアラブルなどのエッジデバイスの普及も盛んであり，個人が複数の"小さな"コンピュータを所有する，という流れも同時に進行しているのである．</p>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_aws入門">3. AWS入門</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_awsとは">3.1. AWSとは？</h3>
<div class="paragraph">
<p>本講義では，クラウドの実践を行うプラットフォームとして， AWS を用いる．
実践にあたって，最低限必要な AWS の知識を本章では解説しよう．</p>
</div>
<div class="paragraph">
<p><a href="https://aws.amazon.com">AWS (Amazon Web Service)</a> はAmazon社が提供する総合的なクラウドプラットフォームである．
AWSはAmazonが持つ膨大な計算リソースを貸し出すクラウドサービスとして，2006年に誕生した．
2018年では，クラウドプロバイダーとして最大のマーケットシェア(約33%)を保持している (<a href="https://www.canalys.com/newsroom/cloud-market-share-q4-2018-and-full-year-2018">参照</a>)．
Netflix, Slackをはじめとした多くのウェブ関連のサービスで，一部または全てのサーバーリソースがAWSから提供されているとのことである．
よって，知らないうちにAWSの恩恵にあずかっている人も少なくないはずだ．</p>
</div>
<div class="paragraph">
<p>最大のシェアをもつだけに，とても幅広い機能・サービスが提供されており，科学・エンジニアリングの研究用途としても頻繁に用いられるようになってきている．</p>
</div>
</div>
<div class="sect2">
<h3 id="_awsの機能サービス">3.2. AWSの機能・サービス</h3>
<div class="paragraph">
<p><a href="#fig_aws_services">Figure 3</a> は，執筆時点においてAWSで提供されている主要な機能・サービスの一覧である．</p>
</div>
<div id="fig_aws_services" class="imageblock text-center">
<div class="content">
<img src="imgs/aws_services.png" alt="AWS services" width="350">
</div>
<div class="title">Figure 3. AWSで提供されている主要なサービス一覧</div>
</div>
<div class="paragraph">
<p>計算，ストレージ，データベース，ネットワーク，セキュリティなど，クラウドの構築に必要な様々な要素が<strong>独立したコンポーネント</strong>として提供されている．
基本的に，これらを組み合わせることでひとつのクラウドシステムができあがる．</p>
</div>
<div class="paragraph">
<p>また，機械学習・音声認識・AR/VRなど，特定のアプリケーションにパッケージ済みのサービスも提供されている．
これらを合計すると全部で176個のサービスが提供されているとのことである (<a href="https://dev.classmethod.jp/articles/aws-summary-2020/">参照</a>)．</p>
</div>
<div class="paragraph">
<p>AWSの初心者は，この<strong>大量のサービスの数に圧倒され，どこから手をつけたらよいのかわからなくなる</strong>，という状況に陥りがちである．
だが実のところ，<strong>基本的な構成要素はそのうちの数個</strong>のみに限られる．
他の機能の多くは，基本の要素を組み合わせ特定のアプリケーションに特化したパッケージとして AWS が用意したものである．
したがって，基本要素となる機能の使い方を知れば，AWSのおおよそのリソースを使いこなすことが可能になる．</p>
</div>
</div>
<div class="sect2">
<h3 id="_awsでクラウドを作るときの基本となる部品">3.3. AWSでクラウドを作るときの基本となる部品</h3>
<div class="paragraph">
<p>以下では AWS 上で計算システムを構築するときの基本となる構成要素を列挙する．
これらは後のハンズオンで実際にプログラムを書きながら体験する．
現時点では，名前だけでも頭の片隅に記憶してもらえればよい．</p>
</div>
<div class="sect3">
<h4 id="_計算">3.3.1. 計算</h4>
<div class="paragraph">
<p><span class="image left"><img src="imgs/aws_logos/EC2.png" alt="S3" width="40"></span>
<strong>EC2 (Elastic Compute Cloud)</strong>
様々なスペックの仮想マシンを作成し，計算を実行することができる．
クラウドの最も基本となる構成要素である．
<a href="#sec_first_ec2">Section 4</a>, <a href="#sec_jupyter_and_deep_learning">Section 6</a>, <a href="#sec_aws_batch">Section 9</a> で詳しく触れる．</p>
</div>
<div class="paragraph">
<p><span class="image left"><img src="imgs/aws_logos/Lambda.png" alt="S3" width="40"></span>
<strong>Lambda</strong>
Function as a Service (FaaS)と呼ばれる，小さな計算を<strong>サーバーなし</strong>で実行するためのサービス．
Serverless architecutre の章 (<a href="#sec_serverless">Section 11</a>) で詳しく解説する．</p>
</div>
</div>
<div class="sect3">
<h4 id="_ストレージ">3.3.2. ストレージ</h4>
<div class="paragraph">
<p><span class="image left"><img src="imgs/aws_logos/EBS.png" alt="S3" width="40"></span>
<strong>EBS (Elastic Block Store)</strong>
EC2に付与することのできる仮想データドライブ．
いわゆる"普通の"(一般的なOSで使われている)ファイルシステムを思い浮かべてくれたらよい．</p>
</div>
<div class="paragraph">
<p><span class="image left"><img src="imgs/aws_logos/S3.png" alt="S3" width="40"></span>
<strong>S3 (Simple Storage Service)</strong>
Object Storage と呼ばれる，APIを使ってデータの読み書きを行う，いうなれば”クラウド・ネイティブ”なデータの格納システムである．
Serverless architecutre の章 (<a href="#sec_serverless">Section 11</a>) で詳しく解説する．</p>
</div>
</div>
<div class="sect3">
<h4 id="_データベース">3.3.3. データベース</h4>
<div class="paragraph">
<p><span class="image left"><img src="imgs/aws_logos/DynamoDB.png" alt="S3" width="40"></span>
<strong>DynamoDB</strong>
NoSQL型のデータベースサービス (知っている人は <code>mongoDB</code> などを思い浮かべたらよい)．
Serverless architecutre の章 (<a href="#sec_serverless">Section 11</a>) で詳しく解説する．</p>
</div>
</div>
<div class="sect3">
<h4 id="_ネットワーク">3.3.4. ネットワーク</h4>
<div class="paragraph">
<p><span class="image left"><img src="imgs/aws_logos/VPC.png" alt="S3" width="40"></span>
<strong>VPC(Virtual Private Cloud)</strong>
AWS上に仮想ネットワーク環境を作成し，仮想サーバー間の接続を定義したり，外部からのアクセスなどを管理する．
EC2はVPCの内部に配置されなければならない．</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_region_と_availability_zone">3.4. Region と Availability Zone</h3>
<div class="paragraph">
<p>AWSを使用する際に知っておかなければならない重要な概念として， <code>Region</code> と <code>Availability Zone (AZ)</code> がある (<a href="#fig_aws_regions_and_azs">Figure 4</a>)．
以下ではこの概念について簡単に記述する．</p>
</div>
<div id="fig_aws_regions_and_azs" class="imageblock text-center">
<div class="content">
<img src="imgs/aws_region_and_az.png" alt="AWS regions and azs" width="500">
</div>
<div class="title">Figure 4. AWSにおける Region と Availability Zones</div>
</div>
<div class="paragraph">
<p><code>Region</code> とは，おおまかに言うとデータセンターの所在地のことである．
執筆時点において，AWSは世界の25の国と地域でデータセンターを所有している．
<a href="#fig_aws_regions">Figure 5</a> は執筆時点で利用できるRegionの世界地図を示している．
日本では東京と大阪にデータセンターがある．
各Regionには固有のIDがついており，例えば東京は <code>ap-northeast-1</code>, 米国オハイオ州は <code>us-east-2</code>，などと定義されている．</p>
</div>
<div id="fig_aws_regions" class="imageblock text-center">
<div class="content">
<img src="imgs/aws_regions.png" alt="AWS regions" width="600">
</div>
<div class="title">Figure 5. Regions in AWS(出典: <a href="https://aws.amazon.com/about-aws/global-infrastructure/" class="bare">https://aws.amazon.com/about-aws/global-infrastructure/</a>)</div>
</div>
<div class="paragraph">
<p>AWSコンソールにログインすると，画面右上のメニューバーでリージョンを選択することができる(<a href="#fig_aws_console_regions">Figure 6</a>, 赤丸で囲った箇所)．
EC2, S3 などのAWSのリソースは，リージョンごとに完全に独立である．
したがって，<strong>リソースを新たにデプロイする時，あるいはデプロイ済みのリソースを閲覧するときは，コンソールのリージョンが正しく設定されているか，確認する必要がある</strong>．
ウェブビジネスを展開する場合などは，世界の各地にクラウドを展開する必要があるが，個人的な研究用途として用いる場合は，最寄りのリージョン (i.e. 東京) を使えば基本的に問題ない．</p>
</div>
<div id="fig_aws_console_regions" class="imageblock text-center">
<div class="content">
<img src="imgs/aws_regions2.png" alt="AWS console select regions" width="600">
</div>
<div class="title">Figure 6. AWSコンソールでリージョンを選択</div>
</div>
<div class="paragraph">
<p><code>Avaialibity Zone (AZ)</code> とは，Region 内で地理的に隔離されたデータセンターのことである．
それぞれのリージョンは2個以上のAZを有しており，もしひとつのAZで火災や停電などが起きた場合でも，他のAZがその障害をカバーすることができる．
また， AZ 間は高速な AWS 専用ネットワーク回線で結ばれているため， AZ 間のデータ転送は極めて早い．
AZ は，ビジネスなどでサーバーダウンが許容されない場合などに注意すべき概念であり，個人的な用途で使う限りにおいてはあまり深く考慮する必要はない．言葉の意味だけ知っておけば十分である．</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>AWS を使用するとき，どこの region を指定するのがよいのだろうか？
インターネットの接続速度などの観点からは，地理的に一番近い region を使用するのが一般的によいだろう．
一方， EC2 の利用料などは region ごとに価格設定が若干 (10-20%程度) 異なる．
従って，自分が最も頻繁に利用するサービスの価格が最も安く設定されているリージョンを選択する，というのも重要な視点である．
また，いくつかのサービスは，特定の region で利用できない場合もある．
これらのポイントから総合的に判断して使用する region を決めると良い．</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Further reading</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/using-regions-availability-zones.html">AWS documentation "Regions, Availability Zones, and Local Zones"</a></p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_awsでのクラウド開発">3.5. AWSでのクラウド開発</h3>
<div class="paragraph">
<p>AWS のクラウドの全体像がわかってきたところで，次のトピックとして，どのようにしてAWS上にクラウドの開発を行い，展開していくかについての概略を解説をしよう．</p>
</div>
<div class="paragraph">
<p>AWS のリソースを追加・編集・削除などの操作を実行するには，<strong>コンソールを用いる</strong>方法と，<strong> API を用いる方法</strong>の，二つの経路がある．</p>
</div>
<div class="sect3">
<h4 id="_コンソール画面からリソースを操作する">3.5.1. コンソール画面からリソースを操作する</h4>
<div class="paragraph">
<p>AWSのアカウントにログインすると，まず最初に表示されるのが<strong> AWS コンソール</strong>である (<a href="#aws_console_window">Figure 7</a>)．</p>
</div>
<div id="aws_console_window" class="imageblock text-center">
<div class="content">
<img src="imgs/aws_console.png" alt="AWS console" width="600">
</div>
<div class="title">Figure 7. AWSマネージメントコンソール画面</div>
</div>
<div class="paragraph">
<p>コンソールを使うことで， EC2 のインスタンスを立ち上げたり，S3のデータを追加・削除したり，ログを閲覧したりなど，AWS上のあらゆるリソースの操作をGUI (Graphical User Interface) を通して実行することができる．
<strong>初めて触る機能をポチポチと試したり，デバッグを行うときなどにとても便利である</strong>．</p>
</div>
<div class="paragraph">
<p>コンソールはさらっと機能を試したり，開発中のクラウドのデバッグをするときには便利なのであるが，実際にクラウドの開発をする場面でこれを直接いじることはあまりない．
むしろ，次に紹介する API を使用して，プログラムとしてクラウドのリソースを記述することで開発を行うのが一般的である．
そのような理由で，本講義ではAWSコンソールを使ったAWSの使い方はあまり触れない．AWSのドキュメンテーションには，たくさんの
<a href="https://aws.amazon.com/getting-started/hands-on/">チュートリアル</a>
が用意されており，コンソール画面から様々な操作を行う方法が記述されているので，興味がある読者はそちらを参照されたい．</p>
</div>
</div>
<div class="sect3">
<h4 id="_apiからリソースを操作する">3.5.2. APIからリソースを操作する</h4>
<div class="paragraph">
<p><strong>API (Application Programming Interface)</strong> を使うことで，コマンドをAWSに送信し，クラウドのリソースの操作をすることができる．
API とは，端的に言えば AWS が公開しているコマンドの一覧であり，<code>GET</code>, <code>POST</code>, <code>DELETE</code> などの <strong>REST API</strong> から構成されている (REST API については <a href="#sec_rest_api">Section 10.2</a> で簡単に解説する)．
が，直接REST APIを入力するのは面倒であるので，その手間を解消するための様々なツールが提供されている．</p>
</div>
<div class="paragraph">
<p><a href="https://docs.aws.amazon.com/cli/latest/index.html">AWS CLI</a>
は， UNIX コンソールから AWS API を実行するための CLI (Command Line Interface) である．</p>
</div>
<div class="paragraph">
<p>CLIに加えて，いろいろなプログラミング言語での SDK (Software Development Kit) が提供されている．以下に一例を挙げる．</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Python &#8658; <a href="https://boto3.amazonaws.com/v1/documentation/api/latest/index.html">boto3</a></p>
</li>
<li>
<p>Ruby &#8658; <a href="https://aws.amazon.com/sdk-for-ruby/">AWS SDK for Ruby</a></p>
</li>
<li>
<p>node.js &#8658; <a href="https://aws.amazon.com/sdk-for-node-js/">AWS SDK for Node.js</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>具体的な API の使用例を見てみよう．</p>
</div>
<div class="paragraph">
<p>S3に新しい保存領域 (<code>Bucket (バケット)</code> と呼ばれる) を追加したいとしよう．
AWS CLI を使った場合は，以下のようなコマンドを打てばよい．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>aws s3 mb s3://my-bucket <span class="nt">--region</span> ap-northeast-1</code></pre>
</div>
</div>
<div class="paragraph">
<p>上記のコマンドは， <code>my-bucket</code> という名前のバケットを， <code>ap-northeast-1</code> のregionに作成する．</p>
</div>
<div class="paragraph">
<p>Pythonから上記と同じ操作を実行するには， <code>boto3</code> ライブラリを使って，以下のようなスクリプトを実行する．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="python"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno">1
2
3
4
</pre></td><td class="code"><pre><span class="kn">import</span> <span class="nn">boto3</span>

<span class="n">s3_client</span> <span class="o">=</span> <span class="n">boto3</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="s">"s3"</span><span class="p">,</span> <span class="n">region_name</span><span class="o">=</span><span class="s">"ap-northeast-1"</span><span class="p">)</span>
<span class="n">s3_client</span><span class="o">.</span><span class="n">create_bucket</span><span class="p">(</span><span class="n">Bucket</span><span class="o">=</span><span class="s">"my-bucket"</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>もう一つ例をあげよう．</p>
</div>
<div class="paragraph">
<p>新しいEC2のインスタンス(インスタンスとは，起動状態にある仮想サーバーの意味である)を起動するには，以下のようなコマンドを打てば良い．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>aws ec2 run-instances <span class="nt">--image-id</span> ami-xxxxxxxx <span class="nt">--count</span> 1 <span class="nt">--instance-type</span> t2.micro <span class="nt">--key-name</span> MyKeyPair <span class="nt">--security-group-ids</span> sg-903004f8 <span class="nt">--subnet-id</span> subnet-6e7f829e</code></pre>
</div>
</div>
<div class="paragraph">
<p>上記のコマンドにより，
<a href="https://aws.amazon.com/ec2/instance-types/t2/">t2.micro</a>
というタイプ (1 vCPU, 1.0 GB RAM) のインスタンスが起動する．
ここではその他のパラメータの詳細の説明は省略する (ハンズオン (<a href="#sec_first_ec2">Section 4</a>) で詳しく解説する)．</p>
</div>
<div class="paragraph">
<p>Pythonから上記と同じ操作を実行するには，以下のようなスクリプトを使う．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="python"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
</pre></td><td class="code"><pre><span class="kn">import</span> <span class="nn">boto3</span>

<span class="n">ec2_client</span> <span class="o">=</span> <span class="n">boto3</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="s">"ec2"</span><span class="p">)</span>
<span class="n">ec2_client</span><span class="o">.</span><span class="n">run_instances</span><span class="p">(</span>
    <span class="n">ImageId</span><span class="o">=</span><span class="s">"ami-xxxxxxxxx"</span><span class="p">,</span>
    <span class="n">MinCount</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
	<span class="n">MaxCount</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
	<span class="n">KeyName</span><span class="o">=</span><span class="s">"MyKeyPair"</span><span class="p">,</span>
	<span class="n">InstanceType</span><span class="o">=</span><span class="s">"t2.micro"</span><span class="p">,</span>
    <span class="n">SecurityGroupIds</span><span class="o">=</span><span class="p">[</span><span class="s">"sg-903004f8"</span><span class="p">],</span>
    <span class="n">SubnetId</span><span class="o">=</span><span class="s">"subnet-6e7f829e"</span><span class="p">,</span>
<span class="p">)</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>以上の例を通じて，APIによるクラウドのリソースの操作のイメージがつかめてきただろうか？
コマンド一つで，新しい仮想サーバーを起動したり，データの保存領域を追加したり，任意の操作を実行することができるわけである．
基本的に，このようなコマンドを複数組み合わせていくことで，自分の望むCPU・RAM・ネットワーク・ストレージが備わった計算環境をを構築することができる．
もちろん，逆の操作 (リソースの削除) も API を使って実行できる．</p>
</div>
</div>
<div class="sect3">
<h4 id="_ミニハンズオン_aws_cli_を使ってみよう">3.5.3. ミニ・ハンズオン: AWS CLI を使ってみよう</h4>
<div class="paragraph">
<p>ここでは，ミニ・ハンズオンとして，AWS CLI を実際に使ってみる．
AWS CLI は先述の通り， AWS 上の任意のリソースの操作が可能であるが，ここでは一番シンプルな，<strong> S3 を使ったファイルの読み書きを実践する</strong> (EC2の操作は少し複雑なので，第一回ハンズオンで行う)．
<code>aws s3</code> コマンドの詳しい使い方は <a href="https://docs.aws.amazon.com/cli/latest/reference/s3/index.html#cli-aws-s3">公式ドキュメンテーション</a>を参照．</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>AWS CLI のインストールについては， <a href="#aws_cli_install">Section 15.2</a> を参照．</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>以下に紹介するハンズオンは，基本的に <a href="https://aws.amazon.com/free/?all-free-tier.sort-by=item.additionalFields.SortRank&amp;all-free-tier.sort-order=asc">S3 の無料枠</a> の範囲内で実行することができる．</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>以下のコマンドを実行する前に，AWSの認証情報が正しく設定されていることを確認する．
これには <code>~/.aws/credentials</code> のファイルに設定が書き込まれているか，環境変数 (<code>AWS_ACCESS_KEY_ID</code>, <code>AWS_SECRET_ACCESS_KEY</code>, <code>AWS_DEFAULT_REGION</code>) が定義されている必要がある．
詳しくは <a href="#aws_cli_install">Section 15.2</a> を参照．</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>まず最初に，S3にデータの格納領域 (<code>Bucket</code> と呼ばれる．一般的なOSでの"ドライブ"に相当する) を作成するところから始めよう．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ bucketName</span><span class="o">=</span><span class="s2">"mybucket-</span><span class="si">$(</span>openssl rand <span class="nt">-hex</span> 12<span class="si">)</span><span class="s2">"</span>
<span class="nv">$ </span><span class="nb">echo</span> <span class="nv">$bucketName</span>
<span class="nv">$ </span>aws s3 mb <span class="s2">"s3://</span><span class="k">${</span><span class="nv">bucketName</span><span class="k">}</span><span class="s2">"</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>S3のバケットの名前は， AWS 全体でに一意的でなければならないことから，上ではランダムな文字列を含んだバケットの名前を生成し，<code>bucketName</code> という変数に格納している．
そして， <code>aws s3 mb</code> (<code>mb</code> は make bucket の略) によって，新しいバケットを作成する．</p>
</div>
<div class="paragraph">
<p>次に，バケットの一覧を取得してみよう．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>aws s3 <span class="nb">ls

</span>2020-06-07 23:45:44 mybucket-c6f93855550a72b5b66f5efe</code></pre>
</div>
</div>
<div class="paragraph">
<p>先ほど作成したバケットがリストにあることを確認できる．</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>本書のノーテーションとして，コマンドラインに入力するコマンドは，それがコマンドであると明示する目的で先頭に <code>$</code> がつけてある． <code>$</code> はコマンドをコピー&amp;ペーストするときは除かなければならない．逆に，コマンドの出力は <code>$</code> なしで表示されている．</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>次に，バケットにファイルをアップロードする．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span><span class="nb">echo</span> <span class="s2">"Hello world!"</span> <span class="o">&gt;</span> hello_world.txt
<span class="nv">$ </span>aws s3 <span class="nb">cp </span>hello_world.txt <span class="s2">"s3://</span><span class="k">${</span><span class="nv">bucketName</span><span class="k">}</span><span class="s2">/hello_world.txt"</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>上では <code>hello_world.txt</code> というダミーのファイルを作成して，それをアップロードした．</p>
</div>
<div class="paragraph">
<p>それでは，バケットの中にあるファイルの一覧を取得してみる．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>aws s3 <span class="nb">ls</span> <span class="s2">"s3://</span><span class="k">${</span><span class="nv">bucketName</span><span class="k">}</span><span class="s2">"</span> <span class="nt">--human-readable</span>

2020-06-07 23:54:19   13 Bytes hello_world.txt</code></pre>
</div>
</div>
<div class="paragraph">
<p>先ほどアップロードしたファイルがたしかに存在することがわかる．</p>
</div>
<div class="paragraph">
<p>最後に，使い終わったバケットを削除する．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>aws s3 rb <span class="s2">"s3://</span><span class="k">${</span><span class="nv">bucketName</span><span class="k">}</span><span class="s2">"</span> <span class="nt">--force</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><code>rb</code> は remove bucket の略である．
デフォルトでは，バケットの中にファイルが存在すると削除できない．
空でないバケットを強制的に削除するには <code>--force</code> のオプションを付ける．</p>
</div>
<div class="paragraph">
<p>以上のように，AWS CLI を使って S3 バケットに対しての一連の操作を実行することができた．
EC2 や Lambda,  DynamoDB などについても同様に AWS CLI を使ってあらゆる操作を実行することができる．</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_cloudformation_と_aws_cdk">3.6. CloudFormation と AWS CDK</h3>
<div class="sect3">
<h4 id="_cloudformation_による_infrastructure_as_code_iac">3.6.1. CloudFormation による Infrastructure as Code (IaC)</h4>
<div class="paragraph">
<p>前節で述べたように，AWS API を使うことでクラウドの<strong>あらゆる</strong>リソースの作成・管理が可能である．
よって，原理上は， API のコマンドを組み合わせていくことで，自分の作りたいクラウドを設計することができる．</p>
</div>
<div class="paragraph">
<p>しかし，ここで実用上考慮しなければならない点がひとつある．
AWS API には大きく分けて，<strong>リソースを操作する</strong>コマンドと，<strong>タスクを実行する</strong>コマンドがあることである (<a href="#fig_aws_iac">Figure 8</a>)．</p>
</div>
<div id="fig_aws_iac" class="imageblock text-center">
<div class="content">
<img src="imgs/iac.png" alt="AWS console" width="500">
</div>
<div class="title">Figure 8. AWS APIはリソースを操作するコマンドとタスクを実行するコマンドに大きく分けられる．リソースを記述・管理するのに使われるのが， CloudFormation と CDK である．</div>
</div>
<div class="paragraph">
<p><strong>リソースを操作する</strong>とは，EC2のインスタンスを起動したり，S3のバケットを作成したり，データベースに新たなテーブルを追加する，などの<strong>静的なリソースを準備する</strong> 操作を指す．
"ハコ"を作る操作と呼んでもよいだろう．
このようなコマンドは，<strong>クラウドのデプロイ時にのみ，一度だけ実行されればよい</strong>．</p>
</div>
<div class="paragraph">
<p><strong>タスクを実行するコマンド</strong> とは， EC2 のインスタンスにジョブを投入したり， S3 のバケットにデータを読み書きするなどの操作を指す．
これは， EC2 や S3 などのリソース ("ハコ") を前提として，その内部で実行されるべき計算を記述するものである．
前者に比べてこちらは<strong>動的な操作</strong>を担当する，と捉えることもできる．</p>
</div>
<div class="paragraph">
<p>そのような観点から，<strong>インフラを記述するプログラム</strong>と<strong>タスクを実行するプログラム</strong>はある程度分けて管理されるべきである．
クラウドの開発は，クラウドの(静的な)リソースを記述するプログラムを作成するステップと，インフラ上で動く動的な操作を行うプログラムを作成するステップの，二段階に分けて考えることができる．</p>
</div>
<div class="paragraph">
<p>AWSでの静的リソースを管理するための仕組みが， <a href="https://aws.amazon.com/cloudformation/">CloudFormation</a> である．
CloudFormation とは， CloudFormation の文法に従ったテキストファイルを使って，AWSのインフラを記述する仕組みである．
CloudFormation を使って，例えば，EC2のインスタンスをどれくらいのスペックで，何個起動するか，インスタンス間はどのようなネットワークで結び，どのようなアクセス権限を付与するか，などのリソースの要件を逐次的に記述することができる．
一度CloudFormation ファイルが出来上がれば，それにしたがったクラウドシステムをコマンド一つで AWS 上に展開することができる．
また，CloudFormation ファイルを交換することで，全く同一のクラウド環境を他者が簡単に再現することも可能になる．
このように，本来は物理的な実体のあるハードウェアを，プログラムによって記述し，管理するという考え方を，<strong>Infrastructure as Code (IaC)</strong>と呼ぶ．</p>
</div>
<div class="paragraph">
<p>CloudFormation を記述するには，基本的に <strong>JSON</strong> (JavaScript Object Notation) と呼ばれるフォーマットを使う．以下は，JSONで記述された CloudFormation ファイルの一例 (抜粋) である．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="json"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
</pre></td><td class="code"><pre><span class="nl">"Resources"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
  </span><span class="err">...</span><span class="w">
  </span><span class="nl">"WebServer"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"Type"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"AWS::EC2::Instance"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"Properties"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"ImageId"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"Fn::FindInMap"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="s2">"AWSRegionArch2AMI"</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"Ref"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"AWS::Region"</span><span class="w"> </span><span class="p">},</span><span class="w">
                        </span><span class="p">{</span><span class="w"> </span><span class="nl">"Fn::FindInMap"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="s2">"AWSInstanceType2Arch"</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"Ref"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"InstanceType"</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="s2">"Arch"</span><span class="w"> </span><span class="p">]</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">]</span><span class="w"> </span><span class="p">},</span><span class="w">
      </span><span class="nl">"InstanceType"</span><span class="w">   </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"Ref"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"InstanceType"</span><span class="w"> </span><span class="p">},</span><span class="w">
      </span><span class="nl">"SecurityGroups"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="p">{</span><span class="nl">"Ref"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"WebServerSecurityGroup"</span><span class="p">}</span><span class="w"> </span><span class="p">],</span><span class="w">
      </span><span class="nl">"KeyName"</span><span class="w">        </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"Ref"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"KeyName"</span><span class="w"> </span><span class="p">},</span><span class="w">
      </span><span class="nl">"UserData"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"Fn::Base64"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"Fn::Join"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">""</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="w">
                     </span><span class="s2">"#!/bin/bash -xe</span><span class="se">\n</span><span class="s2">"</span><span class="p">,</span><span class="w">
                     </span><span class="s2">"yum update -y aws-cfn-bootstrap</span><span class="se">\n</span><span class="s2">"</span><span class="p">,</span><span class="w">

                     </span><span class="s2">"/opt/aws/bin/cfn-init -v "</span><span class="p">,</span><span class="w">
                     </span><span class="s2">"         --stack "</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"Ref"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"AWS::StackName"</span><span class="w"> </span><span class="p">},</span><span class="w">
                     </span><span class="s2">"         --resource WebServer "</span><span class="p">,</span><span class="w">
                     </span><span class="s2">"         --configsets wordpress_install "</span><span class="p">,</span><span class="w">
                     </span><span class="s2">"         --region "</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"Ref"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"AWS::Region"</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="p">,</span><span class="w">

                     </span><span class="s2">"/opt/aws/bin/cfn-signal -e $? "</span><span class="p">,</span><span class="w">
                     </span><span class="s2">"         --stack "</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"Ref"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"AWS::StackName"</span><span class="w"> </span><span class="p">},</span><span class="w">
                     </span><span class="s2">"         --resource WebServer "</span><span class="p">,</span><span class="w">
                     </span><span class="s2">"         --region "</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"Ref"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"AWS::Region"</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="w">
      </span><span class="p">]]}}</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="err">...</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="err">...</span><span class="w">
</span><span class="p">}</span><span class="err">,</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>ここでは， "WebServer" という名前のつけられた EC2 インスタンスを定義している．かなり長大で複雑な記述であるが，これによって所望のスペック・OSをもつEC2インスタンスを自動的に生成することが可能になる．</p>
</div>
</div>
<div class="sect3">
<h4 id="_aws_cdk">3.6.2. AWS CDK</h4>
<div class="paragraph">
<p>前節で紹介した CloudFormation は，見てわかるとおり大変記述が複雑であり，またそれのどれか一つにでも誤りがあってはいけない．
また，基本的に"テキスト"を書いていくことになるので，プログラミング言語で使うような変数やクラスといった便利な概念が使えない　(厳密には， CloudFormation にも変数に相当するような機能は存在する)．
また，記述の多くの部分は繰り返しが多く，自動化できる部分も多い．</p>
</div>
<div class="paragraph">
<p>そのような悩みを解決してくれるのが， <a href="https://aws.amazon.com/cdk/">AWS Cloud Development Kit (CDK)</a> である．
<strong>CDKは Python などのプログラミング言語を使って CloudFormation を自動的に生成してくれるツールである．</strong>
CDK は2019年にリリースされたばかりの比較的新しいツールで，日々改良が進められている (<a href="https://github.com/aws/aws-cdk/releases">GitHub レポジトリ</a> のリリースを見ればその開発のスピードの速さがわかるだろう)．
CDK は TypeScript (JavaScript), Python, Java など複数の言語でサポートされている．</p>
</div>
<div class="paragraph">
<p>CDKを使うことで，CloudFormation に相当するクラウドリソースの記述を，より親しみのあるプログラミング言語を使って行うことができる．
かつ，典型的なリソース操作に関してはパラメータの多くの部分を自動で決定してくれるので，記述しなければならない量もかなり削減される．</p>
</div>
<div class="paragraph">
<p>以下に Python を使った CDK のコードの一例 (抜粋) を示す．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="python"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
</pre></td><td class="code"><pre><span class="kn">from</span> <span class="nn">aws_cdk</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">core</span><span class="p">,</span>
    <span class="n">aws_ec2</span> <span class="k">as</span> <span class="n">ec2</span><span class="p">,</span>
<span class="p">)</span>

<span class="k">class</span> <span class="nc">MyFirstEc2</span><span class="p">(</span><span class="n">core</span><span class="o">.</span><span class="n">Stack</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scope</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">scope</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="n">vpc</span> <span class="o">=</span> <span class="n">ec2</span><span class="o">.</span><span class="n">Vpc</span><span class="p">(</span>
            <span class="o">...</span> <span class="c1"># some parameters
</span>        <span class="p">)</span>

        <span class="n">sg</span> <span class="o">=</span> <span class="n">ec2</span><span class="o">.</span><span class="n">SecurityGroup</span><span class="p">(</span>
            <span class="o">...</span> <span class="c1"># some parameters
</span>        <span class="p">)</span>

        <span class="n">host</span> <span class="o">=</span> <span class="n">ec2</span><span class="o">.</span><span class="n">Instance</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="s">"MyGreatEc2"</span><span class="p">,</span>
            <span class="n">instance_type</span><span class="o">=</span><span class="n">ec2</span><span class="o">.</span><span class="n">InstanceType</span><span class="p">(</span><span class="s">"t2.micro"</span><span class="p">),</span>
            <span class="n">machine_image</span><span class="o">=</span><span class="n">ec2</span><span class="o">.</span><span class="n">MachineImage</span><span class="o">.</span><span class="n">latest_amazon_linux</span><span class="p">(),</span>
            <span class="n">vpc</span><span class="o">=</span><span class="n">vpc</span><span class="p">,</span>
            <span class="o">...</span>
        <span class="p">)</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>上記のコードは，一つ前に示した JSON を使った CloudFormation と実質的に同じことを記述している．
とても煩雑だった CloudFormation ファイルに比べて， CDK と Python を使うことで格段に短く，わかりやすく記述できることができるのがわかるだろう．</p>
</div>
<div class="paragraph">
<p>本書の主題は，<strong> CDK を使って，コードを書きながら AWS の概念や開発方法を学んでいくことである</strong>．
後の章では CDK を使って様々なハンズオンを実施していく．</p>
</div>
<div class="paragraph">
<p>早速，最初のハンズオンでは， CDK を使って EC2 インスタンスを作成する方法を学んでいこう．</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Further reading</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://github.com/aws-samples/aws-cdk-examples">AWS CDK Examples</a>: CDKを使ったプロジェクトの例が多数紹介されている．
ここにある例をテンプレートに自分のアプリケーションの開発を進めるとよい．</p>
</li>
</ul>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="sec_first_ec2">4. Hands-on #1: 初めてのEC2インスタンスを起動する</h2>
<div class="sectionbody">
<div class="paragraph">
<p>ハンズオンの第一回では， CDK を使って EC2 のインスタンス(仮想サーバー)を作成し，SSHでサーバーにログインする，という演習を行う．
このハンズオンを終えれば，あなたは自分だけのサーバーをAWS上に立ち上げ，自由に計算を走らせることができるようになるのである！</p>
</div>
<div class="paragraph">
<p>ハンズオン1のソースコードは <a href="https://gitlab.com/tomomano/intro-aws/-/tree/master/handson/01-ec2">こちらのリンク</a> に置いてある．</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>ハンズオン1は，基本的に <a href="https://aws.amazon.com/free/?all-free-tier.sort-by=item.additionalFields.SortRank&amp;all-free-tier.sort-order=asc">AWS の無料枠</a> の範囲内で実行することができる．</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="handson_01_prep">4.1. 準備</h3>
<div class="paragraph">
<p>まずは，ハンズオンを実行するための環境を整える．
これらの環境整備は，後のハンズオンでも前提となるものなので確実にミスなく行っていただきたい．</p>
</div>
<div class="sect3">
<h4 id="_aws_account">4.1.1. AWS Account</h4>
<div class="paragraph">
<p>ハンズオンを実行するには個人のAWSアカウントが必要である．
AWSアカウントの取得については <a href="#aws_account">Section 1.3</a> 参照．</p>
</div>
</div>
<div class="sect3">
<h4 id="_python_と_node_js">4.1.2. Python と Node.js</h4>
<div class="paragraph">
<p>本ハンズオンを実行するには，Python (3.6 以上)，Node.js (10.3.0 以上) がインストールされていなければならない．</p>
</div>
</div>
<div class="sect3">
<h4 id="_aws_cli">4.1.3. AWS CLI</h4>
<div class="paragraph">
<p>AWS CLI のインストールについては， <a href="#aws_cli_install">Section 15.2</a> を参照．</p>
</div>
</div>
<div class="sect3">
<h4 id="_aws_cdk_2">4.1.4. AWS CDK</h4>
<div class="paragraph">
<p>AWS CDK のインストールについては， <a href="#aws_cdk_install">Section 15.3</a> を参照．</p>
</div>
</div>
<div class="sect3">
<h4 id="_ソースコードのダウンロード">4.1.5. ソースコードのダウンロード</h4>
<div class="paragraph">
<p>本ハンズオンで使用するプログラムのソースコードを，以下のコマンドを使って GitLab からダウンロードする．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git clone https://gitlab.com/tomomano/intro-aws.git</code></pre>
</div>
</div>
<div class="paragraph">
<p>あるいは， <a href="https://gitlab.com/tomomano/intro-aws" class="bare">https://gitlab.com/tomomano/intro-aws</a> のページに行って，右上のダウンロードボタンからダウンロードすることもできる．</p>
</div>
</div>
<div class="sect3">
<h4 id="_docker_を使用する場合">4.1.6. Docker を使用する場合</h4>
<div class="paragraph">
<p>Python, Node.js, AWS CDK など，ハンズオンのプログラムを実行するために必要なプログラム/ライブラリがインストール済みの Docker image を用意した．
また，ハンズオンのソースコードもクローン済みである．
Docker の使い方を知っている読者は，これを使えば，諸々のインストールをする必要なく，すぐにハンズオンのプログラムを実行できる．</p>
</div>
<div class="paragraph">
<p>次のコマンドでコンテナを起動する．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash">docker run <span class="nt">-it</span> registry.gitlab.com/tomomano/intro-aws:latest</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_ssh">4.2. SSH</h3>
<div class="paragraph">
<p><a href="https://en.wikipedia.org/wiki/Secure_Shell">SSH (secure shell)</a> はUnix系のリモートサーバーに安全にアクセスするためのツールである．
本ハンズオンでは， SSH を使って仮想サーバーにアクセスする．
SSH に慣れていない読者のため，簡単な説明をここで行う．</p>
</div>
<div class="paragraph">
<p>SSHによる通信はすべて暗号化されているので，機密情報をインターネット越しに安全に送受信することができる．
本ハンズオンで，リモートのサーバーにアクセスするためにSSHクライアントがインストールされている必要がある．
SSHクライアントはLinux/Macには標準搭載されている．
Windowsの場合はWSLをインストールすることでSSHクライアントを利用することを推奨する (<a href="#environments">Section 1.4</a> を参照)．</p>
</div>
<div class="paragraph">
<p>SSH コマンドの基本的な使い方は</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>ssh &lt;user name&gt;@&lt;host name&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>である．
<code>&lt;host name&gt;</code> はアクセスする先のサーバーのIPアドレスやDNSによるホストネームが入る．
<code>&lt;user name&gt;</code> は接続する先のユーザー名である．</p>
</div>
<div class="paragraph">
<p>SSH は平文のパスワードによる認証を行うこともできるが，より強固なセキュリティを施すため，<strong>公開鍵暗号方式(Public Key Cryptography)による認証</strong>を行うことが強く推奨されており，EC2はこの方法でしかアクセスを許していない．
公開鍵暗号方式の仕組みについては各自勉強してほしい．
本ハンズオンにおいて大事なことは，<strong>EC2 インスタンスが公開鍵(Public key)を保持し，クライアントとなるコンピューター(あなた自身のコンピュータ)が秘密鍵(Private key)を保持する</strong>，という点である．
EC2のインスタンスには秘密鍵を持ったコンピュータのみがアクセスすることができる．逆に言うと，秘密鍵が漏洩すると第三者もサーバーにアクセスできることになるので，<strong>秘密鍵は絶対に漏洩することのないよう注意して管理する</strong>．</p>
</div>
<div class="paragraph">
<p>SSH コマンドでは，ログインのために使用する秘密鍵ファイルを <code>-i</code> もしくは <code>--identity_file</code> のオプションで指定することができる．
例えば</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>ssh <span class="nt">-i</span> Ec2SecretKey.pem &lt;user name&gt;@&lt;host name&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>のように使う．</p>
</div>
</div>
<div class="sect2">
<h3 id="_アプリケーションの説明">4.3. アプリケーションの説明</h3>
<div class="paragraph">
<p>このハンズオンで作成するアプリケーションの概要を <a href="#handson_01_architecture">Figure 9</a> に示す．</p>
</div>
<div id="handson_01_architecture" class="imageblock text-center">
<div class="content">
<img src="imgs/handson-01/app_architecture.png" alt="hands-on 01 architecture" width="600">
</div>
<div class="title">Figure 9. ハンズオン#1で作製するアプリケーションのアーキテクチャ</div>
</div>
<div class="paragraph">
<p>このアプリケーションではまず，<strong>VPC (Virtual Private Cloud)</strong> を使ってプライベートな仮想ネットワーク環境を立ち上げている．
そのVPCの public subnet の内側に，<strong>EC2 (Elatic Compute Cloud)</strong> の仮想サーバーを配置する．
さらに，セキュリティのため， <strong>Security Group</strong> によるEC2インスタンスへのアクセス制限を設定している．
このようにして作成された仮想サーバーに，SSHを使ってアクセスし，簡単な計算を行う．</p>
</div>
<div class="paragraph">
<p>上記のようなアプリケーションを，CDKを使って構築する．</p>
</div>
<div class="paragraph">
<p>早速ではあるが，今回のハンズオンで使用するプログラムを見てみよう (<a href="https://gitlab.com/tomomano/intro-aws/-/tree/master/handson/01-ec2/app.py">handson/01-ec2/app.py</a>)．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="python"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
</pre></td><td class="code"><pre><span class="k">class</span> <span class="nc">MyFirstEc2</span><span class="p">(</span><span class="n">core</span><span class="o">.</span><span class="n">Stack</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scope</span><span class="p">:</span> <span class="n">core</span><span class="o">.</span><span class="n">App</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">key_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">scope</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <i class="conum" data-value="1"></i><b>(1)</b>
        <span class="n">vpc</span> <span class="o">=</span> <span class="n">ec2</span><span class="o">.</span><span class="n">Vpc</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="s">"MyFirstEc2-Vpc"</span><span class="p">,</span>
            <span class="n">max_azs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">cidr</span><span class="o">=</span><span class="s">"10.10.0.0/23"</span><span class="p">,</span>
            <span class="n">subnet_configuration</span><span class="o">=</span><span class="p">[</span>
                <span class="n">ec2</span><span class="o">.</span><span class="n">SubnetConfiguration</span><span class="p">(</span>
                    <span class="n">name</span><span class="o">=</span><span class="s">"public"</span><span class="p">,</span>
                    <span class="n">subnet_type</span><span class="o">=</span><span class="n">ec2</span><span class="o">.</span><span class="n">SubnetType</span><span class="o">.</span><span class="n">PUBLIC</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">],</span>
            <span class="n">nat_gateways</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="p">)</span>

        <i class="conum" data-value="2"></i><b>(2)</b>
        <span class="n">sg</span> <span class="o">=</span> <span class="n">ec2</span><span class="o">.</span><span class="n">SecurityGroup</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="s">"MyFirstEc2Vpc-Sg"</span><span class="p">,</span>
            <span class="n">vpc</span><span class="o">=</span><span class="n">vpc</span><span class="p">,</span>
            <span class="n">allow_all_outbound</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">sg</span><span class="o">.</span><span class="n">add_ingress_rule</span><span class="p">(</span>
            <span class="n">peer</span><span class="o">=</span><span class="n">ec2</span><span class="o">.</span><span class="n">Peer</span><span class="o">.</span><span class="n">any_ipv4</span><span class="p">(),</span>
            <span class="n">connection</span><span class="o">=</span><span class="n">ec2</span><span class="o">.</span><span class="n">Port</span><span class="o">.</span><span class="n">tcp</span><span class="p">(</span><span class="mi">22</span><span class="p">),</span>
        <span class="p">)</span>

        <i class="conum" data-value="3"></i><b>(3)</b>
        <span class="n">host</span> <span class="o">=</span> <span class="n">ec2</span><span class="o">.</span><span class="n">Instance</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="s">"MyFirstEc2Instance"</span><span class="p">,</span>
            <span class="n">instance_type</span><span class="o">=</span><span class="n">ec2</span><span class="o">.</span><span class="n">InstanceType</span><span class="p">(</span><span class="s">"t2.micro"</span><span class="p">),</span>
            <span class="n">machine_image</span><span class="o">=</span><span class="n">ec2</span><span class="o">.</span><span class="n">MachineImage</span><span class="o">.</span><span class="n">latest_amazon_linux</span><span class="p">(),</span>
            <span class="n">vpc</span><span class="o">=</span><span class="n">vpc</span><span class="p">,</span>
            <span class="n">vpc_subnets</span><span class="o">=</span><span class="n">ec2</span><span class="o">.</span><span class="n">SubnetSelection</span><span class="p">(</span><span class="n">subnet_type</span><span class="o">=</span><span class="n">ec2</span><span class="o">.</span><span class="n">SubnetType</span><span class="o">.</span><span class="n">PUBLIC</span><span class="p">),</span>
            <span class="n">security_group</span><span class="o">=</span><span class="n">sg</span><span class="p">,</span>
            <span class="n">key_name</span><span class="o">=</span><span class="n">key_name</span>
        <span class="p">)</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>まず最初に，VPCを定義する．</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>次に，SGを定義している．ここでは，任意のIPv4のアドレスからの，ポート22 (SSHの接続に使用される)への接続を許容している．それ以外の接続は拒絶される．</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>最後に，上記で作ったVPCとSGが付与されたEC2 のインスタンスを作成している．インスタンスタイプは <code>t2.micro</code> を選択し， <a href="https://aws.amazon.com/amazon-linux-ami/">Amazon Linux</a> をOSとして設定している．</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>それぞれについて，もう少し詳しく説明しよう．</p>
</div>
<div class="sect3">
<h4 id="_vpc_virtual_private_cloud">4.3.1. VPC (Virtual Private Cloud)</h4>
<div class="imageblock">
<div class="content">
<img src="imgs/aws_logos/VPC.png" alt="VPC" width="100">
</div>
</div>
<div class="paragraph">
<p>VPCはAWS上にプライベートな仮想ネットワーク環境を構築するツールである．高度な計算システムを構築するには，複数のサーバーを連動させて計算を行う必要があるが，そのような場合に互いのアドレスなどを管理する必要があり，そのような場合にVPCは有用である．</p>
</div>
<div class="paragraph">
<p>本ハンズオンでは，サーバーは一つしか起動しないので，VPCの恩恵はよく分からないかもしれない．しかし，EC2インスタンスは必ずVPCの中に配置されなければならない，という制約があるので，このハンズオンでもミニマルなVPCを構成している．</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>興味のある読者のために，VPCのコードについてもう少し詳しく説明しよう．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="python"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
</pre></td><td class="code"><pre><span class="n">vpc</span> <span class="o">=</span> <span class="n">ec2</span><span class="o">.</span><span class="n">Vpc</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="s">"MyFirstEc2-Vpc"</span><span class="p">,</span>
    <span class="n">max_azs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">cidr</span><span class="o">=</span><span class="s">"10.10.0.0/23"</span><span class="p">,</span>
    <span class="n">subnet_configuration</span><span class="o">=</span><span class="p">[</span>
        <span class="n">ec2</span><span class="o">.</span><span class="n">SubnetConfiguration</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s">"public"</span><span class="p">,</span>
            <span class="n">subnet_type</span><span class="o">=</span><span class="n">ec2</span><span class="o">.</span><span class="n">SubnetType</span><span class="o">.</span><span class="n">PUBLIC</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="p">],</span>
    <span class="n">nat_gateways</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
<span class="p">)</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p><code>max_azs=1</code> : このパラメータは，前章で説明した avaialibility zone を設定している．このハンズオンでは，特にデータセンターの障害などを気にする必要はないので1にしている．</p>
</li>
<li>
<p><code>cidr="10.10.0.0/23"</code> : このパラメターは，VPC内のIPv4のレンジを指定している．CIDR記法については， <a href="https://en.wikipedia.org/wiki/Classless_Inter-Domain_Routing">Wikipedia</a>などを参照． <code>10.10.0.0/23</code> は <code>10.10.0.0</code> から <code>10.10.1.255</code> までの512個の連続したアドレス範囲を指している．つまり，このVPCでは最大で512個のユニークなIPv4アドレスが使えることになる．今回はサーバーは一つなので512個は明らかに多すぎるが，VPCはアドレスの数はどれだけ作成しても無料なので，多めに作成した．</p>
</li>
<li>
<p><code>subnet_configuration=&#8230;&#8203;</code> : このパラメータは，VPCにどのようなサブネットを作るか，を決めている．サブネットの種類には <strong>priavte subnet</strong> と <strong>public subnet</strong> の二種類がある．private subnet は基本的にインターネットとは遮断されたサブネット環境である．インターネットと繋がっていないので，セキュリティは極めて高く，VPC内のサーバーとのみ通信を行えばよいEC2インスタンスは，ここに配置する．Public subnet とはインターネットに繋がったサブネットである．本ハンズオンで作成するサーバーは，外からSSHでログインを行いたいので，Public subnet 内に配置する．</p>
</li>
<li>
<p><code>natgateways=0</code> : これは少し高度な内容なので省略する (興味のある読者は <a href="https://docs.aws.amazon.com/vpc/latest/userguide/vpc-nat-gateway.html">公式ドキュメンテーション</a>を参照)．が，<strong>これを0にしておかないと，NAT Gateway の利用料金が発生してしまうので，注意！</strong></p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_security_group">4.3.2. Security Group</h4>
<div class="paragraph">
<p>Security group (SG) は，EC2インスタンスに付与することのできる仮想ファイアーウォールである．例えば，特定のIPアドレスから来た接続を許したり　(インバウンド・トラフィックの制限) ，逆に特定のIPアドレスへのアクセスを禁止したり (アウトバウンド・トラフィックの制限) することができる．</p>
</div>
<div class="paragraph">
<p>コードの該当部分を見てみよう．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="python"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="code"><pre><span class="n">sg</span> <span class="o">=</span> <span class="n">ec2</span><span class="o">.</span><span class="n">SecurityGroup</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="s">"MyFirstEc2Vpc-Sg"</span><span class="p">,</span>
    <span class="n">vpc</span><span class="o">=</span><span class="n">vpc</span><span class="p">,</span>
    <span class="n">allow_all_outbound</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">sg</span><span class="o">.</span><span class="n">add_ingress_rule</span><span class="p">(</span>
    <span class="n">peer</span><span class="o">=</span><span class="n">ec2</span><span class="o">.</span><span class="n">Peer</span><span class="o">.</span><span class="n">any_ipv4</span><span class="p">(),</span>
    <span class="n">connection</span><span class="o">=</span><span class="n">ec2</span><span class="o">.</span><span class="n">Port</span><span class="o">.</span><span class="n">tcp</span><span class="p">(</span><span class="mi">22</span><span class="p">),</span>
<span class="p">)</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>本ハンズオンでは，SSHによる外部からの接続を許容するため， <code>sg.add_ingress_rule(peer=ec2.Peer.any_ipv4(), connection=ec2.Port.tcp(22))</code> により，すべてのIPv4アドレスからのポート22番へのアクセスを許容している．
また，SSHでEC2インスタンスにログインしたのち，インターネットからプログラムなどをダウンロードできるよう， <code>allow_all_outbound=True</code> のパラメータを設定している．</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>SSH はデフォルトでは22番ポートを使用するのが慣例である．</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>セキュリティ上の観点からは，SSHの接続は自宅や大学などの特定の地点からの接続のみを許す方が望ましい．</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_ec2_elastic_compute_cloud">4.3.3. EC2 (Elastic Compute Cloud)</h4>
<div class="imageblock">
<div class="content">
<img src="imgs/aws_logos/EC2.png" alt="EC2" width="100">
</div>
</div>
<div class="paragraph">
<p>EC2 はAWS上に仮想サーバーを立ち上げるサービスである．個々の起動状態にある仮想サーバーのことをインスタンス (instance) と呼ぶ
(しかし，コミュニケーションにおいては，サーバーとインスタンスという言葉は相互互換的に用いられることが多い)．</p>
</div>
<div class="paragraph">
<p>EC2では用途に応じて様々なインスタンスタイプが提供されている．
以下に，代表的なインスタンスタイプの例を挙げる(2020/06時点での情報)．
EC2 のインスタンスタイプのすべてのリストは <a href="https://aws.amazon.com/ec2/instance-types/">公式ドキュメンテーション</a>で見ることができる．</p>
</div>
<table id="ec2_instance_types" class="tableblock frame-all grid-all stretch">
<caption class="title">Table 2. EC2 instance types</caption>
<colgroup>
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 20%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Instance</th>
<th class="tableblock halign-left valign-top">vCPU</th>
<th class="tableblock halign-left valign-top">Memory (GiB)</th>
<th class="tableblock halign-left valign-top">Network bandwidth (Gbps)</th>
<th class="tableblock halign-left valign-top">Price per hour ($)</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">t2.micro</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.0116</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">t2.small</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.023</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">t2.medium</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">4</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.0464</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">c5.24xlarge</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">96</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">192</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">25</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">4.08</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">c5n.18xlarge</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">72</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">192</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">100</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3.888</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">x1e.16xlarge</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">64</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1952</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">10</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">13.344</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>このようにCPUは1コアから96コアまで，メモリーは1GBから3000GB以上まで，ネットワークは最大で100Gbpsまで，幅広く選択することができる．また，時間あたりの料金は，CPU・メモリーの占有数にほぼ比例する形で増加する．
EC2 はサーバーの起動時間を秒単位で記録しており，<strong>利用料金は使用時間に比例する形で決定される</strong>．
例えば， <code>t2.medium</code> のインスタンスを10時間起動した場合，0.0464 * 10 = 0.464 ドルの料金が発生する．</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>AWS には <a href="https://aws.amazon.com/free/?all-free-tier.sort-by=item.additionalFields.SortRank&amp;all-free-tier.sort-order=asc">無料利用枠</a> というものがあり， <code>t2.micro</code> であれば月に750時間までは無料で利用することができる．</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p><a href="#ec2_instance_types">Table 2</a> の価格は <code>us-east-1</code> のものである．地域によって多少価格設定が異なることがある．</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>上記で t2.micro の $0.0116 / hour という金額は，on-demandインスタンスというタイプを選択した場合の価格である．
EC2 では他に，Spot instance と呼ばれるインスタンスも存在しする．
Spot instance は，AWSのデータセンターの負荷が増えた場合，AWSの判断により強制シャットダウンされる可能性がある，という不便さを抱えているのだが，その分大幅に安い料金設定になっている．
いうなれば，"すき間の空きCPUで計算を行う"といった格好である．
科学計算で，コストを削減する目的で，このSpot Instanceを使う事例も報告されている (<a href="https://arxiv.org/abs/1904.10489">Wu+, 2019</a>)．</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>EC2 インスタンスを定義しているコードの該当部分を見てみよう．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="python"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="code"><pre><span class="n">host</span> <span class="o">=</span> <span class="n">ec2</span><span class="o">.</span><span class="n">Instance</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="s">"MyFirstEc2Instance"</span><span class="p">,</span>
    <span class="n">instance_type</span><span class="o">=</span><span class="n">ec2</span><span class="o">.</span><span class="n">InstanceType</span><span class="p">(</span><span class="s">"t2.micro"</span><span class="p">),</span>
    <span class="n">machine_image</span><span class="o">=</span><span class="n">ec2</span><span class="o">.</span><span class="n">MachineImage</span><span class="o">.</span><span class="n">latest_amazon_linux</span><span class="p">(),</span>
    <span class="n">vpc</span><span class="o">=</span><span class="n">vpc</span><span class="p">,</span>
    <span class="n">vpc_subnets</span><span class="o">=</span><span class="n">ec2</span><span class="o">.</span><span class="n">SubnetSelection</span><span class="p">(</span><span class="n">subnet_type</span><span class="o">=</span><span class="n">ec2</span><span class="o">.</span><span class="n">SubnetType</span><span class="o">.</span><span class="n">PUBLIC</span><span class="p">),</span>
    <span class="n">security_group</span><span class="o">=</span><span class="n">sg</span><span class="p">,</span>
    <span class="n">key_name</span><span class="o">=</span><span class="n">key_name</span>
<span class="p">)</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>ここでは， <code>t2.micro</code> というインスタンスタイプを選択している．
さらに， <code>machine_image</code> (OSと考えてよい) として， <a href="https://aws.amazon.com/amazon-linux-ami/">Amazon Linux</a> を選択している (Machine image については，第二回ハンズオンでより詳しく触れる)．
さらに，上で定義した VPC, SG をこのインスタンスに付与している．</p>
</div>
<div class="paragraph">
<p>以上が，今回使用するプログラムの簡単な解説であった．
ミニマルな形のプログラムではあるが，仮想サーバーを作成するのに必要なステップがおわかりいただけただろうか？</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_プログラムを実行する">4.4. プログラムを実行する</h3>
<div class="paragraph">
<p>さて，ハンズオンのコードの理解ができたところで，プログラムを実際に実行してみよう．繰り返しになるが， <a href="#handson_01_prep">Section 4.1</a> での準備ができていることが前提である．</p>
</div>
<div class="sect3">
<h4 id="_python_の依存ライブラリのインストール">4.4.1. Python の依存ライブラリのインストール</h4>
<div class="paragraph">
<p>まずは，Python の依存ライブラリをインストールする．以下では，Python のライブラリを管理するツールとして， <a href="https://docs.python.org/3/library/venv.html">venv</a> を使用する．</p>
</div>
<div class="paragraph">
<p>まずは， <code>handson/01-ec2</code> のディレクトリに移動しよう．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span><span class="nb">cd </span>handson/01-ec2</code></pre>
</div>
</div>
<div class="paragraph">
<p>ディレクトリを移動したら， <code>venv</code> で新しい仮想環境を作成し，インストールを実行する．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>python3 <span class="nt">-m</span> venv .env
<span class="nv">$ </span><span class="nb">source</span> .env/bin/activate
<span class="nv">$ </span>pip <span class="nb">install</span> <span class="nt">-r</span> requirements.txt</code></pre>
</div>
</div>
<div class="paragraph">
<p>これで Python の環境構築は完了だ．</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p><code>venv</code> の簡単な説明は <a href="#venv_quick_guide">Section 15.4</a> に記述してある．</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_aws_のシークレットキーをセットする">4.4.2. AWS のシークレットキーをセットする</h4>
<div class="paragraph">
<p>AWS CLI および AWS CDK を使うには，AWSのシークレットキーが設定されている必要がある．以下のようにして環境変数を設定する．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span><span class="nb">export </span><span class="nv">AWS_ACCESS_KEY_ID</span><span class="o">=</span>XXXXXX
<span class="nv">$ </span><span class="nb">export </span><span class="nv">AWS_SECRET_ACCESS_KEY</span><span class="o">=</span>YYYYYY
<span class="nv">$ </span><span class="nb">export </span><span class="nv">AWS_DEFAULT_REGION</span><span class="o">=</span>ap-northeast-1</code></pre>
</div>
</div>
<div class="paragraph">
<p>上の <code>XXXXXX</code>, <code>YYYYYY</code> としたところは自分の鍵に置き換えることを忘れずに．</p>
</div>
<div class="paragraph">
<p>シークレットキーの発行については <a href="#aws_secrets">Section 15.1</a> を参照．</p>
</div>
</div>
<div class="sect3">
<h4 id="_ssh鍵を生成">4.4.3. SSH鍵を生成</h4>
<div class="paragraph">
<p>EC2 インスタンスには SSH を使ってログインする．
EC2インスタンスを起動するのに先行して，今回のハンズオンで専用に使うSSHの公開鍵・秘密鍵のペアを準備する必要がある．</p>
</div>
<div class="paragraph">
<p>以下の aws-cli コマンドにより， <code>HirakeGoma</code> という名前のついた鍵を生成する．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span><span class="nb">export </span><span class="nv">KEY_NAME</span><span class="o">=</span><span class="s2">"HirakeGoma"</span>
<span class="nv">$ </span>aws ec2 create-key-pair <span class="nt">--key-name</span> <span class="k">${</span><span class="nv">KEY_NAME</span><span class="k">}</span> <span class="nt">--query</span> <span class="s1">'KeyMaterial'</span> <span class="nt">--output</span> text <span class="o">&gt;</span> <span class="k">${</span><span class="nv">KEY_NAME</span><span class="k">}</span>.pem</code></pre>
</div>
</div>
<div class="paragraph">
<p>上のコマンドを実行すると，現在のディレクトリに <code>HirakeGoma.pem</code> というファイルが作成される．これが，サーバーにアクセスするための秘密鍵である． SSH でこの鍵を使うため， <code>~/.ssh/</code> のディレクトリに鍵を移動する．さらに，秘密鍵が書き換えられたり第三者に閲覧されないよう，ファイルのアクセス権限を <code>400</code> に設定する．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span><span class="nb">mv </span>HirakeGoma.pem ~/.ssh/
<span class="nv">$ </span><span class="nb">chmod </span>400 ~/.ssh/HirakeGoma.pem</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_デプロイを実行">4.4.4. デプロイを実行</h4>
<div class="paragraph">
<p>これまでのステップで準備は整った！</p>
</div>
<div class="paragraph">
<p>早速，アプリケーションをAWSにデプロイしてみよう．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>cdk deploy <span class="nt">-c</span> <span class="nv">key_name</span><span class="o">=</span><span class="s2">"HirakeGoma"</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><code>-c key_name="HirakeGoma"</code> というオプションで，先程生成した <code>HirakeGoma</code> という名前の鍵を使うよう指定している．</p>
</div>
<div class="paragraph">
<p>上記のコマンドを実行すると，VPC， EC2 などが実際に展開される．また，コマンドの出力の最後に <a href="#handson_01_cdk_output">Figure 10</a> のような出力が得られるはずである．
<strong>出力の中で <code>InstancePublicIp</code> に続く数字が，起動したインスタンスのパブリックIPアドレスである．</strong>
IPアドレスはデプロイのごとにランダムに割り当てられる．</p>
</div>
<div id="handson_01_cdk_output" class="imageblock text-center">
<div class="content">
<img src="imgs/handson-01/cdk_output.png" alt="cdk output" width="700">
</div>
<div class="title">Figure 10. CDKデプロイ実行後の出力</div>
</div>
</div>
<div class="sect3">
<h4 id="_ssh_でログイン">4.4.5. SSH でログイン</h4>
<div class="paragraph">
<p>早速，SSHで接続してみよう．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>ssh <span class="nt">-i</span> ~/.ssh/HirakeGoma.pem ec2-user@&lt;IP address&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>-i</code> オプションで，先程生成した秘密鍵を指定している． EC2 インスタンスにはデフォルトで <code>ec2-user</code> という名前のユーザーが作られているので，それを使用する．最後に， <code>&lt;IP address&gt;</code> の部分は自分が作成したEC2インスタンスのIPアドレスで置き換える (<code>54.238.112.5</code> など）．</p>
</div>
<div class="paragraph">
<p>ログインに成功すると，以下のような画面が表示される．リモートのサーバーにログインしているので，プロンプトが <code>[ec2-user@ip-10-10-1-217 ~]$</code> となっている．</p>
</div>
<div id="handson_01_ssh_login" class="imageblock text-center">
<div class="content">
<img src="imgs/handson-01/ssh_login.png" alt="ssh_login" width="700">
</div>
<div class="title">Figure 11. SSH で EC2 インスタンスにログイン</div>
</div>
<div class="paragraph">
<p><strong>おめでとう！これで，めでたくAWS上にEC2仮想サーバーを起動し，リモートからアクセスすることができるようになった！</strong></p>
</div>
</div>
<div class="sect3">
<h4 id="_起動した_ec2_インスタンスで遊んでみる">4.4.6. 起動した EC2 インスタンスで遊んでみる</h4>
<div class="paragraph">
<p>せっかくサーバーを起動したので，少し遊んでみよう．</p>
</div>
<div class="paragraph">
<p>ログインした EC2 インスタンスで，次のコマンドを実行してみよう．
CPUの情報を取得することができる．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span><span class="nb">cat</span> /proc/cpuinfo

processor	: 0
vendor_id	: GenuineIntel
cpu family	: 6
model		: 63
model name	: Intel<span class="o">(</span>R<span class="o">)</span> Xeon<span class="o">(</span>R<span class="o">)</span> CPU E5-2676 v3 @ 2.40GHz
stepping	: 2
microcode	: 0x43
cpu MHz		: 2400.096
cache size	: 30720 KB</code></pre>
</div>
</div>
<div class="paragraph">
<p>次に，実行中のプロセスやメモリの消費を見てみよう．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span> top <span class="nt">-n</span> 1

top - 09:29:19 up 43 min,  1 user,  load average: 0.00, 0.00, 0.00
Tasks:  76 total,   1 running,  51 sleeping,   0 stopped,   0 zombie
Cpu<span class="o">(</span>s<span class="o">)</span>:  0.3%us,  0.3%sy,  0.1%ni, 98.9%id,  0.2%wa,  0.0%hi,  0.0%si,  0.2%st
Mem:   1009140k total,   270760k used,   738380k free,    14340k buffers
Swap:        0k total,        0k used,        0k free,   185856k cached

  PID USER      PR  NI  VIRT  RES  SHR S %CPU %MEM    TIME+  COMMAND
    1 root      20   0 19696 2596 2268 S  0.0  0.3   0:01.21 init
    2 root      20   0     0    0    0 S  0.0  0.0   0:00.00 kthreadd
    3 root      20   0     0    0    0 I  0.0  0.0   0:00.00 kworker/0:0</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>t2.micro</code> インスタンスなので， 1009140k = 1GB のメモリーがあることがわかる．</p>
</div>
<div class="paragraph">
<p>今回起動したインスタンスには Python 2 はインストール済みだが， Python 3 は入っていない．
Python 3.6 のインストールを行ってみよう．
インストールは簡単である．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span><span class="nb">sudo </span>yum update <span class="nt">-y</span>
<span class="nv">$ </span><span class="nb">sudo </span>yum <span class="nb">install</span> <span class="nt">-y</span> python36</code></pre>
</div>
</div>
<div class="paragraph">
<p>インストールしたPythonを起動してみよう．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>python3
Python 3.6.10 <span class="o">(</span>default, Feb 10 2020, 19:55:14<span class="o">)</span>
<span class="o">[</span>GCC 4.8.5 20150623 <span class="o">(</span>Red Hat 4.8.5-28<span class="o">)]</span> on linux
Type <span class="s2">"help"</span>, <span class="s2">"copyright"</span>, <span class="s2">"credits"</span> or <span class="s2">"license"</span> <span class="k">for </span>more information.
<span class="o">&gt;&gt;&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Python のインタープリタが起動した！
<code>Ctrl + D</code> あるいは <code>exit()</code> と入力することで，インタープリタを閉じることができる．</p>
</div>
<div class="paragraph">
<p>さて，サーバーでのお遊びはこんなところにしておこう (興味があれば各自いろいろと試してみると良い) ．
次のコマンドでログアウトする．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span><span class="nb">exit</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_aws_コンソールから確認">4.4.7. AWS コンソールから確認</h4>
<div class="paragraph">
<p>これまでは，すべてコマンドラインからEC2に関連する諸々の操作を行ってきた．
EC2インスタンスの状態を確認したり，サーバーをシャットダウンするなどの操作は，AWS コンソールから実行することもできる．
軽くこれを紹介しよう．</p>
</div>
<div class="paragraph">
<p>まず，AWS コンソールにログインする．</p>
</div>
<div class="paragraph">
<p>ログインしたら， <code>Services</code> から <code>EC2</code> を検索(選択)する．
次に，左のサイドバーの <code>Instances</code> とページを辿る.
すると， <a href="#aws_ec2_console">Figure 12</a> のような画面が得られるはずである．
この画面で，自分のアカウントの管理下にあるインスタンスを確認することができる．</p>
</div>
<div id="aws_ec2_console" class="imageblock text-center">
<div class="content">
<img src="imgs/handson-01/ec2_console.png" alt="ec2_console" width="700">
</div>
<div class="title">Figure 12. EC2 コンソール画面</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p><strong>コンソール右上で，正しいリージョン (今回の場合は ap-northeast-1, Tokyo) が選択されているか，注意する！</strong></p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>同様に，VPC・SG についてもコンソールから確認することができる．</p>
</div>
<div class="paragraph">
<p>前章で CloudFormation について触れたが，今回デプロイしたアプリケーションも，CloudFormation の "スタック" として管理されている．
スタック (stack) とは，AWSリソースの集合のことを指す．
今回の場合は，VPC/EC2/SG などがスタックの中に含まれている．</p>
</div>
<div class="paragraph">
<p>コンソールで <code>CloudFormation</code> のページに行ってみよう (<a href="#aws_cloudformation_console">Figure 13</a>)．</p>
</div>
<div id="aws_cloudformation_console" class="imageblock text-center">
<div class="content">
<img src="imgs/handson-01/cloudformation_console.png" alt="cloudformation console" width="700">
</div>
<div class="title">Figure 13. CloudFormation コンソール画面</div>
</div>
<div class="paragraph">
<p>"MyFirstEc2" という名前のスタックがあることが確認できる．
クリックをして中身を見てみると，EC2, VPN などのリソースがこのスタックに紐付いていることがわかる．</p>
</div>
</div>
<div class="sect3">
<h4 id="handson_01_delete_stack">4.4.8. スタックを削除</h4>
<div class="paragraph">
<p>これにて，第一回のハンズオンで説明すべき事柄はすべて完了した．
最後に，使わなくなったスタックを削除しよう．</p>
</div>
<div class="paragraph">
<p>スタックの削除には，２つの方法がある．</p>
</div>
<div class="paragraph">
<p>１つめの方法は，前節の Cloudformation のコンソール画面で， "Delete" ボタンを押すことである (<a href="#cloudformation_delete">Figure 14</a>)．</p>
</div>
<div id="cloudformation_delete" class="imageblock text-center">
<div class="content">
<img src="imgs/handson-01/cloudformation_delete.png" alt="cloudformation delete" width="700">
</div>
<div class="title">Figure 14. CloudFormationコンソール画面から，スタックを削除</div>
</div>
<div class="paragraph">
<p>２つめの方法は，コマンドラインから行う方法である．</p>
</div>
<div class="paragraph">
<p>先ほど，デプロイを行ったコマンドラインに戻ろう．そうしたら，</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>cdk destroy</code></pre>
</div>
</div>
<div class="paragraph">
<p>と実行する．すると，スタックの削除が始まる．</p>
</div>
<div class="paragraph">
<p>削除した後は，VPC, EC2 など，すべて跡形もなく消え去っている．</p>
</div>
<div class="paragraph">
<p>このように，自分の使いたいときにだけ，サーバーを立ち上げ，使い終わったら直ちに削除する，というのが現代のクラウドの正しい使い方である．</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p><strong>スタックの削除は各自で必ず行うこと！</strong>
行わなかった場合，EC2インスタンスの料金が発生し続けることになる！</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>また，本ハンズオンのために作成したSSH鍵ペアも不要なので，削除しておく．</p>
</div>
<div class="paragraph">
<p>まず，EC2側に登録してある公開鍵を削除する．
これも，コンソールおよびコマンドラインの２つの方法で実行できる．</p>
</div>
<div class="paragraph">
<p>コンソールから実行するには， <code>EC2</code> の画面に行き，左のサイドバーの <code>Key Pairs</code> を選択．
鍵の一覧が表示されるので， <code>HirakeGoma</code> とある鍵にチェックを入れ，画面右上の <code>Actions</code> から， <code>Delete</code> を実行 (<a href="#delete_ec2_key_pair">Figure 15</a>)．</p>
</div>
<div id="delete_ec2_key_pair" class="imageblock text-center">
<div class="content">
<img src="imgs/handson-01/ec2_keypair_console.png" alt="ec2_keypair_console" width="700">
</div>
<div class="title">Figure 15. EC2でSSH鍵ペアを削除</div>
</div>
<div class="paragraph">
<p>コマンドラインから実行するには，以下のコマンドを使う．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>aws ec2 delete-key-pair <span class="nt">--key-name</span> <span class="s2">"HirakeGoma"</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>最後に，ローカルのコンピュータから鍵を削除する．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span><span class="nb">rm</span> <span class="nt">-f</span> ~/.ssh/HirakeGoma.pem</code></pre>
</div>
</div>
<div class="paragraph">
<p>これで，クラウドの片付けもすべて終了だ．</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>なお，頻繁にEC2インスタンスを起動したりする場合は，いちいちSSH鍵を削除する必要はない．</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_講義第一回目のまとめ">4.5. 講義第一回目のまとめ</h3>
<div class="paragraph">
<p>ここまでが，第一回目の講義の内容である．盛りだくさんの内容であったが，ついてこれたであろうか？</p>
</div>
<div class="paragraph">
<p>第一回では，クラウドの概要と，なぜクラウドを使うのか，という点を議論した．
また，クラウドを学ぶ具体的な題材としてAWSを取り上げ，AWSの概要説明を行った．
さらに，ハンズオンではAWS CLI/CDK を使って，自分のマイ・サーバーをAWS上に立ち上げる演習を行った．</p>
</div>
<div class="paragraph">
<p>ハンズオンなどを通じて，いかに簡単に(たった数行のコマンドで！)仮想サーバーを立ち上げたり，削除したりすることができるか，体験することができただろう．
このように，<strong>ダイナミックに計算リソースを拡大・縮小をできることが，クラウドの最も本質的な側面であると，筆者は考えている</strong>．</p>
</div>
<div class="paragraph">
<p>次回以降の講義では，今回学んだクラウドの技術を基に，より現実的な問題を解くことを体験してもらう．お楽しみに！</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="sec_scientific_computing">5. クラウドで行う科学計算・機械学習</h2>
<div class="sectionbody">
<div class="paragraph">
<p>ここからが第二回目の講義の内容になる．</p>
</div>
<div class="paragraph">
<p>第二回目は，前回学んだクラウドの知識・技術を使って，現実的な問題を解くことを考える．</p>
</div>
<div class="paragraph">
<p>計算機が発達した現代では，計算機によるシミュレーションやビッグデータの解析は，科学・エンジニアリングの研究の主要な柱である．
これらの大規模な計算を実行するには，クラウドは最適である．
講義第二回では，どのようにしてクラウド上で科学計算を実行するのかを，ハンズオンとともに体験してもらう．
科学計算の具体的な題材として，今回は機械学習(ディープラーニング)を取り上げる．</p>
</div>
<div class="paragraph">
<p>なお，本講義では <a href="https://pytorch.org/">PyTorch</a> ライブラリを使ってディープラーニングのアルゴリズムを走らせるが，ディープラーニングおよび PyTorch の知識は不要である．
講義ではなぜ・どうやってディープラーニングをクラウドで実行するかに主眼を置いているので，実行するプログラムの詳細には立ち入らない．
将来自分でディープラーニングを使う機会が来たときに，詳しく学んでもらいたい．</p>
</div>
<div class="sect2">
<h3 id="_なぜ機械学習をクラウドで行うのか">5.1. なぜ機械学習をクラウドで行うのか？</h3>
<div class="paragraph">
<p>2010年代に始まったAIブームのおかげで，研究だけでなく社会・ビジネスの文脈でも機械学習に高い関心が寄せられている．
特に，ディープラーニングと呼ばれる多層のレイヤーからなるニューラルネットワークを用いたアルゴリズムは，画像認識や自然言語処理などの分野で圧倒的に高い性能を実現し，革命をもたらしている．</p>
</div>
<div class="paragraph">
<p>ディープラーニングの特徴は，なんといってもそのパラメータの多さである．
層が深くなるほど，層間のニューロンを結ぶ重みパラメータの数が増大していく．
例えば，最新の言語モデルである <a href="https://arxiv.org/abs/2005.14165">GPT-3</a> には<strong>1750億個</strong>ものパラメータが含まれている！
このような膨大なパラメータを有することで，ディープラーニングは高い表現力と汎化性能を実現しているのである．</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="imgs/cnn.png" alt="cnn" width="500">
</div>
<div class="title">Figure 16. ニューラルネットワークにおける畳み込み演算．</div>
</div>
<div class="paragraph">
<p>GPT-3 に限らず，最近の SOTA (State-of-the-art) の性能を達成するニューラルネットでは，百万から億のオーダーのパラメータを有することは頻繁になってきている．そのような巨大なニューラルネットを学習させるのは，当然のことながら巨大な計算コストがかかる．そんな巨大な計算に最適なのが，クラウドである！事実，GPT-3の学習も，詳細は明かされていないが，Microsoft社のクラウドを使って行われたと報告されている．</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>GPT-3 が発表された時，そのモデルがもつ表現能力には多くの人が驚嘆させられた． <a href="https://openai.com/blog/better-language-models/#task5">OpenAI</a> のブログに，モデルが出力した翻訳や文章要約のタスクの結果が紹介されている．</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_gpu_による機械学習の高速化">5.2. GPU による機械学習の高速化</h3>
<div class="paragraph">
<p>ディープラーニングの計算で欠かすことのできない技術として， <strong>GPU (Graphics Processing Unit)</strong> について少し説明する．</p>
</div>
<div class="paragraph">
<p>GPUは，その名のとおり，元々はコンピュータグラフィックスを出力するための専用計算チップである．CPU (Central Processing Unit) に対し，グラフィックスの演算に特化した設計がなされている．身近なところでは，XBoxやPS4などのゲーム機などに搭載されているし，ハイスペックなノートパソコンやデスクトップコンピュータにも搭載されていることがある．コンピュータグラフィクスでは，スクリーンにアレイ状に並んだ数百万個の画素をリアルタイムで処理する必要がある．そのため，GPUは，コアあたりの演算能力は比較的弱いかわりに，チップあたり数百から数千のコアを搭載しており (<a href="#gpu_architecture">Figure 17</a>)，スクリーンの画素を並列的に処理することで，リアルタイムでの描画を実現している．</p>
</div>
<div id="gpu_architecture" class="imageblock text-center">
<div class="content">
<img src="imgs/gpu_architecture.jpg" alt="cdk output" width="500">
</div>
<div class="title">Figure 17. GPUのアーキテクチャ．GPUには数百から数千の独立した計算コアが搭載されている． (画像出典: <a href="https://devblogs.nvidia.com/nvidia-turing-architecture-in-depth/" class="bare">https://devblogs.nvidia.com/nvidia-turing-architecture-in-depth/</a>)</div>
</div>
<div class="paragraph">
<p>このように，コンピュータグラフィクスの目的で生まれたGPUだが，2010年前後から，その高い並列計算能力をグラフィックス以外の計算(科学計算など)に用いるという流れ (<strong>General-purpose computing on GPU; GPGPU</strong>) が生まれた．GPUのコアは，その設計から，行列の計算など，単純かつ規則的な演算が得意であり，そのような演算に対しては数個程度のコアしか持たないCPUに比べて圧倒的に高い計算速度を実現することができる．現在ではGPGPUは分子動力学や気象シミュレーション，そして機械学習など多くの分野で使われている．</p>
</div>
<div class="paragraph">
<p>ディープラーニングで最も頻繁に起こる演算が，ニューロンの出力を次の層のニューロンに伝える畳み込み (Convolution) 演算である．畳み込み演算は，まさにGPUが得意とする演算であり，CPUではなくGPUを用いることで学習を飛躍的に(最大で数百倍程度！)加速させることができる．</p>
</div>
<div class="paragraph">
<p>このように GPU は機械学習の計算で欠かせないものであるが，なかなか高価である．例えば，科学計算・機械学習に専用設計されたNVIDIA社の Tesla V100 というチップは，一台で約百万円の価格が設定されている．機械学習を始めるのに，いきなり百万円の投資はなかなか大きい．だが，クラウドを使えば，初期コスト０でGPUを使用することができる．</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>機械学習を行うのに，V100が必ずしも必要というわけではない．
むしろ，研究者などでしばしば行われるのは，コンピュータゲームに使われるグラフィックス用のGPUを買ってきて(NVIDIA GeForceシリーズなど)，開発のときはをそれを用いる，というアプローチである．
グラフィックス用のいわゆる"コンシューマGPU"は，市場の需要が大きいおかげで，10万円前後の価格で購入することができる．
V100と比べると，コンシューマGPUはコアの数が少なかったり，メモリーが小さかったりなどで劣る点があるが，ディープラーニングの計算は特に問題なく実行することができ，開発の段階では十分な性能である．</p>
</div>
<div class="paragraph">
<p>プログラムができあがって，ビッグデータの解析や，モデルをさらに大きくしたいときなどに，クラウドは有効だろう．</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>クラウドでGPUを使うには，GPUが搭載されたEC2インスタンスタイプ (<code>P3</code>, <code>P2</code>, <code>G3</code>, <code>G4</code> など) を選択しなければならない．
<a href="#table_gpu_instances">Table 3</a> に，代表的なGPU搭載のインスタンスタイプを挙げる (執筆時点(2020/06)での情報)．</p>
</div>
<table id="table_gpu_instances" class="tableblock frame-all grid-all stretch">
<caption class="title">Table 3. GPUを搭載したEC2インスタンスタイプ</caption>
<colgroup>
<col style="width: 14.2857%;">
<col style="width: 14.2857%;">
<col style="width: 14.2857%;">
<col style="width: 14.2857%;">
<col style="width: 14.2857%;">
<col style="width: 14.2857%;">
<col style="width: 14.2858%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Instance</th>
<th class="tableblock halign-left valign-top">GPUs</th>
<th class="tableblock halign-left valign-top">GPU model</th>
<th class="tableblock halign-left valign-top">GPU Mem (GiB)</th>
<th class="tableblock halign-left valign-top">vCPU</th>
<th class="tableblock halign-left valign-top">Mem (GiB)</th>
<th class="tableblock halign-left valign-top">Price per hour ($)</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">p3.2xlarge</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">NVIDIA V100</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">16</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">8</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">61</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3.06</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">p3n.16xlarge</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">8</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">NVIDIA V100</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">128</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">64</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">488</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">24.48</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">p2.xlarge</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">NVIDIA K80</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">12</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">4</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">61</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.9</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">g4dn.xlarge</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">NVIDIA T4</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">16</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">4</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">16</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.526</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p><a href="#table_gpu_instances">Table 3</a> からわかるとおり，CPUのみのインスタンスと比べると少し高い価格設定になっている．
また，古い世代のGPU (V100に対してのK80) はより安価な価格で提供されている．
GPUの搭載数は1台から最大で8台まで選択することが可能である．</p>
</div>
<div class="paragraph">
<p>GPUを搭載した一番安いインスタンスタイプは， <code>g2dn.xlarge</code> であり，これには廉価かつ省エネルギー設計の NVIDIA T4 が搭載されている．今回のハンズオンでは，このインスタンスを使用して，ディープラーニングの計算を行ってみる．</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p><a href="#table_gpu_instances">Table 3</a> の価格は <code>us-east-1</code> のもの．地域によって多少価格設定が異なることがある．</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>V100を一台搭載した <code>p3.2xlarge</code> の利用料金は一時間あたり $3.06 である．V100が約百万円で売られていることを考えると，約3000時間 (= 124日間)，通算で計算を行った場合に，クラウドを使うよりもV100を自分で買ったほうがお得になる，という計算になる．
(実際には，自前でV100を用意する場合は，V100だけでなく，CPUやネットワーク機器，電気使用料も必要なので，百万円よりもさらにコストがかかる．)</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>GPT-3 で使われた計算リソースの詳細は論文でも明かされていないのだが， <a href="https://lambdalabs.com/blog/demystifying-gpt-3/">Lambda社のブログ</a>で興味深い考察が行われている (Lambda社は機械学習に特化したクラウドサービスを提供している)．</p>
</div>
<div class="paragraph">
<p>記事によると，1750億のパラメータを学習するには，一台のGPU (NVIDIA V100)を用いた場合，342年の月日と460万ドルのクラウド利用料が必要となる，とのことである．GPT-3のチームは，複数のGPUに処理を分散することで現実的な時間のうちに学習を完了させたのであろうが，このレベルのモデルになってくるとクラウド技術の限界を攻めないと達成できないことは確かである．</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="sec_jupyter_and_deep_learning">6. Hands-on #2: AWSでディープラーニングの計算を走らせる</h2>
<div class="sectionbody">
<div class="paragraph">
<p>ハンズオン第二回では，GPUを搭載したEC2インスタンスを起動し，ディープラーニングの学習と推論を実行する演習を行う．</p>
</div>
<div class="paragraph">
<p>ハンズオンのソースコードはこちらのリンクに置いてある &#8658; <a href="https://gitlab.com/tomomano/intro-aws/-/tree/master/handson/02-ec2-dnn" class="bare">https://gitlab.com/tomomano/intro-aws/-/tree/master/handson/02-ec2-dnn</a></p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>このハンズオンは，AWSの無料枠内では実行できない．
<code>g4dn.xlarge</code> タイプの EC2 インスタンスを使うので， <code>ap-northeast-1</code> リージョンでは 0.8 $/hour のコストが発生する．</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="_準備">6.1. 準備</h3>
<div class="paragraph">
<p>本ハンズオンの実行には，第一回ハンズオンで説明した準備 (<a href="#handson_01_prep">Section 4.1</a>) が整っていることを前提とする．それ以外に必要な準備はない．</p>
</div>
</div>
<div class="sect2">
<h3 id="_アプリケーションの説明_2">6.2. アプリケーションの説明</h3>
<div class="paragraph">
<p>このハンズオンで作成するアプリケーションの概要を <a href="#handson_02_architecture">Figure 18</a> に示す．</p>
</div>
<div id="handson_02_architecture" class="imageblock text-center">
<div class="content">
<img src="imgs/handson-02/handson-02-architecture.png" alt="hands-on 01 architecture" width="600">
</div>
<div class="title">Figure 18. ハンズオン#2で作製するアプリケーションのアーキテクチャ</div>
</div>
<div class="paragraph">
<p>図の多くの部分が，第一回ハンズオンで作成したアプリケーションと共通していることに気がつくだろう．少しの変更で，簡単にディープラーニングを走らせる環境を構築することができるのである！主な変更点は次の３点である．</p>
</div>
<div class="ulist">
<ul>
<li>
<p>GPUを搭載した <code>g4dn.xlarge</code> インスタンスタイプを使用．</p>
</li>
<li>
<p>ディープラーニングに使うプログラムが予めインストールされたDLAMI (後述) を使用．</p>
</li>
<li>
<p>SSHにポートフォワーディングのオプションつけてサーバーに接続し，サーバーで起動しているJupyter notebook (後述) を使ってプログラムを書いたり実行したりする．</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>ハンズオンで使用するプログラムのコードをみてみよう (<a href="https://gitlab.com/tomomano/intro-aws/-/tree/master/handson/02-ec2-dnn/app.py">/handson/02-ec2-dnn/app.py</a>)．コードも，第一回目とほとんど共通である．変更点のみ解説を行う．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="python"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
</pre></td><td class="code"><pre><span class="k">class</span> <span class="nc">Ec2ForDl</span><span class="p">(</span><span class="n">core</span><span class="o">.</span><span class="n">Stack</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scope</span><span class="p">:</span> <span class="n">core</span><span class="o">.</span><span class="n">App</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">key_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">scope</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="n">vpc</span> <span class="o">=</span> <span class="n">ec2</span><span class="o">.</span><span class="n">Vpc</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="s">"Ec2ForDl-Vpc"</span><span class="p">,</span>
            <span class="n">max_azs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">cidr</span><span class="o">=</span><span class="s">"10.10.0.0/23"</span><span class="p">,</span>
            <span class="n">subnet_configuration</span><span class="o">=</span><span class="p">[</span>
                <span class="n">ec2</span><span class="o">.</span><span class="n">SubnetConfiguration</span><span class="p">(</span>
                    <span class="n">name</span><span class="o">=</span><span class="s">"public"</span><span class="p">,</span>
                    <span class="n">subnet_type</span><span class="o">=</span><span class="n">ec2</span><span class="o">.</span><span class="n">SubnetType</span><span class="o">.</span><span class="n">PUBLIC</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">],</span>
            <span class="n">nat_gateways</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">sg</span> <span class="o">=</span> <span class="n">ec2</span><span class="o">.</span><span class="n">SecurityGroup</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="s">"Ec2ForDl-Sg"</span><span class="p">,</span>
            <span class="n">vpc</span><span class="o">=</span><span class="n">vpc</span><span class="p">,</span>
            <span class="n">allow_all_outbound</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">sg</span><span class="o">.</span><span class="n">add_ingress_rule</span><span class="p">(</span>
            <span class="n">peer</span><span class="o">=</span><span class="n">ec2</span><span class="o">.</span><span class="n">Peer</span><span class="o">.</span><span class="n">any_ipv4</span><span class="p">(),</span>
            <span class="n">connection</span><span class="o">=</span><span class="n">ec2</span><span class="o">.</span><span class="n">Port</span><span class="o">.</span><span class="n">tcp</span><span class="p">(</span><span class="mi">22</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="n">host</span> <span class="o">=</span> <span class="n">ec2</span><span class="o">.</span><span class="n">Instance</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="s">"Ec2ForDl-Instance"</span><span class="p">,</span>
            <span class="n">instance_type</span><span class="o">=</span><span class="n">ec2</span><span class="o">.</span><span class="n">InstanceType</span><span class="p">(</span><span class="s">"g4dn.xlarge"</span><span class="p">),</span> <i class="conum" data-value="1"></i><b>(1)</b>
            <span class="n">machine_image</span><span class="o">=</span><span class="n">ec2</span><span class="o">.</span><span class="n">MachineImage</span><span class="o">.</span><span class="n">generic_linux</span><span class="p">({</span>
                <span class="s">"ap-northeast-1"</span><span class="p">:</span> <span class="s">"ami-09c0c16fc46a29ed9"</span>
            <span class="p">}),</span> <i class="conum" data-value="2"></i><b>(2)</b>
            <span class="n">vpc</span><span class="o">=</span><span class="n">vpc</span><span class="p">,</span>
            <span class="n">vpc_subnets</span><span class="o">=</span><span class="n">ec2</span><span class="o">.</span><span class="n">SubnetSelection</span><span class="p">(</span><span class="n">subnet_type</span><span class="o">=</span><span class="n">ec2</span><span class="o">.</span><span class="n">SubnetType</span><span class="o">.</span><span class="n">PUBLIC</span><span class="p">),</span>
            <span class="n">security_group</span><span class="o">=</span><span class="n">sg</span><span class="p">,</span>
            <span class="n">key_name</span><span class="o">=</span><span class="n">key_name</span>
        <span class="p">)</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>ここで，GPUを搭載した <code>g4dn.xlarge</code> インスタンスタイプを選択している (第一回では，CPUのみの <code>t2.micro</code> だった)．</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>ここで，Deep Learning 用の諸々のソフトウェアがプリンストールされたAMI (<a href="https://docs.aws.amazon.com/dlami/latest/devguide/what-is-dlami.html">Deep Learning Amazon Machine Image; DLAMI</a>) を選択している．(第一回では，Amazon Linux というAMIを使用していた)．使用するAMIのIDは "ami-09c0c16fc46a29ed9" である．</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><code>g4dn.xlarge</code> のインスタンスタイプについては， <a href="#sec_scientific_computing">Section 5</a> ですでに触れた．DLAMI について，少し説明しよう．</p>
</div>
<div class="sect3">
<h4 id="_dlami_deep_learning_amazon_machine_image">6.2.1. DLAMI (Deep Learning Amazon Machine Image)</h4>
<div class="paragraph">
<p><code>AMI</code> (Amazon Machine Image) とは，平たく言えば OS (Operating System) のことである．当然のことながら，OSがなければコンピュータはなにもできないので，EC2インスタンスを起動する時には必ずなにかのOSを"インストール"する必要がある．AMI には，例えば <a href="https://ubuntu.com/">Ubuntu</a> や <a href="https://www.suse.com/">SUSE Linux</a> などの各Linux系OSに加えて，Windows Server を選択することもできる．また，EC2での使用に最適化された <a href="https://aws.amazon.com/amazon-linux-ami/">Amazon Linux</a> というAMIも提供されている．</p>
</div>
<div class="paragraph">
<p>しかしながら，AMIを単なるOSと理解するのは誤りである．
AMIには，ベースとなる(空っぽの)OSを選択できることもできるが，それに加えて，各種のプログラムがインストール済みのAMIも用意されている．
必要なプログラムがインストールされているAMIを見つけることができれば，自分でインストールを行ったり環境設定をする手間が大幅に省ける．
具体例を挙げると，ハンズオン第一回では EC2 インスタンスに Python 3.6 をインストールする例を示したが，そのような操作をインスタンスを起動するたびに行うのは手間である！</p>
</div>
<div class="paragraph">
<p>AMI は，AWSや他のサードパーティーから提供されており，EC2のコンソール画面でインスタンスを起動するときに検索することができる．あるいは， AWS CLI を使って，次のコマンドでリストを取得することができる (<a href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/finding-an-ami.html">参考</a>)．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>aws ec2 describe-images <span class="nt">--owners</span> amazon</code></pre>
</div>
</div>
<div class="paragraph">
<p>上記のコマンドにより，amazon が提供しているAMIの一覧が表示される．
また，自分自身のAMIを作って登録することも可能である (<a href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/creating-an-ami-instance-store.html">参考</a>)．</p>
</div>
<div class="paragraph">
<p>ディープラーニングで頻繁に使われるプログラムが予めインストールしてあるAMIが， <a href="https://docs.aws.amazon.com/dlami/latest/devguide/what-is-dlami.html">DLAMI (Deep Learning AMI)</a> である． DLAMIには <code>TensorFlow</code>, <code>PyTorch</code> などの人気の高いディープラーニングのフレームワーク・ライブラリが既にインストールされているため，EC2インスタンスを起動してすぐさまディープラーニングの計算を実行できる．</p>
</div>
<div class="paragraph">
<p>本ハンズオンでは， Amazon Linux 2 をベースにした DLAMI を使用する (AMI ID = ami-09c0c16fc46a29ed9)．AWS CLI を使って，このAMIの詳細情報を取得してみよう．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>aws ec2 describe-images <span class="nt">--owners</span> amazon <span class="nt">--image-ids</span> <span class="s2">"ami-09c0c16fc46a29ed9"</span></code></pre>
</div>
</div>
<div id="handson_02_ami-info" class="imageblock text-center">
<div class="content">
<img src="imgs/handson-02/ami-info.png" alt="ami-info" width="700">
</div>
<div class="title">Figure 19. AMI ID = ami-09c0c16fc46a29ed9 の詳細情報</div>
</div>
<div class="paragraph">
<p><a href="#handson_02_ami-info">Figure 19</a> のような出力が得られるはずである．得られた出力から，例えばこの DLAMI には PyTorch のバージョン1.4.0 と 1.5.0 がインストールされていることがわかる．このDLAMIを使って，早速ディープラーニングの計算を実行してみよう．</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>DLAMIには具体的には何がインストールされているのだろうか？
興味のある読者のために，簡単な解説をしよう (参考: <a href="https://docs.aws.amazon.com/dlami/latest/devguide/what-is-dlami.html">公式ドキュメンテーション</a>)．</p>
</div>
<div class="paragraph">
<p>最も low-level なレイヤーとしては， GPUドライバー がインストールされている．
GPUドライバーなしにはOSはGPUにコマンドを送ることができない．
次のレイヤーが <a href="https://developer.nvidia.com/about-cuda">CUDA</a> と <a href="https://developer.nvidia.com/cudnn">cuDNN</a> である．
CUDAは，NVIDIA社が開発した，GPU上で汎用コンピューティングを行うための言語であり，C++言語を拡張したシンタックスを備える．
cuDNN は CUDA で書かれたディープラーニングのライブラリであり，n次元の畳み込みなどの演算が実装されている．</p>
</div>
<div class="paragraph">
<p>以上までが， "Base" と呼ばれるタイプの DLAMI の中身である．</p>
</div>
<div class="paragraph">
<p>これに加えて， "Conda" と呼ばれるタイプには， これらのプログラム基盤の上に， <code>TensorFlow</code> や <code>PyTorch</code> などのライブラリがインストールされている．
さらに， <a href="https://docs.conda.io/projects/conda/en/latest/index.html">Anaconda</a> による仮想環境を使うことによって， <code>TensorFlow</code> の環境， <code>PyTorch</code> の環境，を簡単に切り替えることができる (これについては，ハンズオンで触れる)．また， Jupyter notebook もインストール済みである．</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_スタックのデプロイ">6.3. スタックのデプロイ</h3>
<div class="paragraph">
<p>スタックの中身が理解できたところで，早速スタックをデプロイしてみよう．</p>
</div>
<div class="paragraph">
<p>デプロイの手順は，ハンズオン1とほとんど共通である．
ここでは，コマンドのみ列挙する (<code>#</code> で始まる行はコメントである)．
それぞれのコマンドの意味を忘れてしまった場合は，ハンズオン1に戻って復習していただきたい．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="c"># プロジェクトのディレクトリに移動</span>
<span class="nv">$ </span><span class="nb">cd </span>intro-aws/handson/02-ec2-dnn

<span class="c"># venv を作成し，依存ライブラリのインストールを行う</span>
<span class="nv">$ </span>python3 <span class="nt">-m</span> venv .env
<span class="nv">$ </span><span class="nb">source</span> .env/bin/activate
<span class="nv">$ </span>pip <span class="nb">install</span> <span class="nt">-r</span> requirements.txt

<span class="c"># AWS の認証情報をセットする</span>
<span class="c"># 自分自身の認証情報に置き換えること！</span>
<span class="nb">export </span><span class="nv">AWS_ACCESS_KEY_ID</span><span class="o">=</span>XXXXXX
<span class="nb">export </span><span class="nv">AWS_SECRET_ACCESS_KEY</span><span class="o">=</span>YYYYYY
<span class="nb">export </span><span class="nv">AWS_DEFAULT_REGION</span><span class="o">=</span>ap-northeast-1

<span class="c"># SSH鍵を生成</span>
<span class="nv">$ </span><span class="nb">export </span><span class="nv">KEY_NAME</span><span class="o">=</span><span class="s2">"HirakeGoma"</span>
<span class="nv">$ </span>aws ec2 create-key-pair <span class="nt">--key-name</span> <span class="k">${</span><span class="nv">KEY_NAME</span><span class="k">}</span> <span class="nt">--query</span> <span class="s1">'KeyMaterial'</span> <span class="nt">--output</span> text <span class="o">&gt;</span> <span class="k">${</span><span class="nv">KEY_NAME</span><span class="k">}</span>.pem
<span class="nv">$ </span><span class="nb">mv </span>HirakeGoma.pem ~/.ssh/
<span class="nv">$ </span><span class="nb">chmod </span>400 ~/.ssh/HirakeGoma.pem

<span class="c"># デプロイを実行</span>
<span class="nv">$ </span>cdk deploy <span class="nt">-c</span> <span class="nv">key_name</span><span class="o">=</span><span class="s2">"HirakeGoma"</span></code></pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>ハンズオン1で作成したSSH鍵の削除を行わなかった場合は，SSH鍵を改めて作成する必要はない．逆に言うと，同じ名前のSSHが既に存在する場合は，鍵生成のコマンドはエラーを出力する．</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>デプロイのコマンドが無事に実行されれば， <a href="#handson_02_cdk_output">Figure 20</a> のような出力が得られるはずである．AWSにより割り振られたIPアドレス (<code>InstancePublicIp</code> に続く文字列) をメモしておこう．</p>
</div>
<div id="handson_02_cdk_output" class="imageblock text-center">
<div class="content">
<img src="imgs/handson-02/cdk_output.png" alt="cdk output" width="700">
</div>
<div class="title">Figure 20. CDKデプロイ実行後の出力</div>
</div>
</div>
<div class="sect2">
<h3 id="_ログイン">6.4. ログイン</h3>
<div class="paragraph">
<p>早速，デプロイしたインスタンスにSSHでログインしてみよう．</p>
</div>
<div class="paragraph">
<p>ここでは，この後で使う Jupyter notebook に接続するため，<strong>ポートフォワーディング</strong> のオプション (<code>-L</code>) をつけてログインする．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>ssh <span class="nt">-i</span> ~/.ssh/HirakeGoma.pem <span class="nt">-L</span> localhost:8931:localhost:8888 ec2-user@&lt;IP address&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>ポートフォワーディングとは，クライアントマシンの特定のアドレスへの接続を，SSHの暗号化された通信を介して，リモートマシンの特定のアドレスへ転送する，という意味である．
上のコマンドの <code>-L localhost:8931:localhost:8888</code> は，自分のローカルマシンの <code>localhost:8931</code> へのアクセスを，リモートサーバーの <code>localhost:8888</code> のアドレスに転送せよ，という意味である (<code>:</code> につづく数字はポート番号を意味している)．
リモートサーバーのポート8888には，後述する Jupyter notebook が起動している．
したがって，ローカルマシンの <code>localhost:8931</code> にアクセスすることで，リモートサーバーの Jupyter notebook にアクセスすることができるのである (このようなSSHによる接続方式を<strong>トンネル接続</strong>と呼ぶ)．</p>
</div>
<div class="paragraph">
<p>ポートフォワーディングについて混乱した読者は，より詳しい解説が <a href="https://medium.com/@apbetahouse45/how-to-run-jupyter-notebooks-on-remote-server-part-1-ssh-a2be0232c533">このブログ記事</a> にある．</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>ポートフォワーディングのオプションで，ポートの番号 (<code>:8931</code>, <code>:8888</code> など) には1から65535までの任意の整数を指定できる．しかし，例えば ポート22は SSH に，ポート80は HTTP に，など，いくつか既に使われているポート番号もあることに注意する．また， Jupyter notebook デフォルトではポート8888番を使用する．したがって，リモート側のポート番号は，8888を使うのがよい．</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>SSH ログインコマンドの <code>&lt;IP address&gt;</code> 部分は自分のインスタンスのIPアドレスを代入することを忘れずに．</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p><strong>本講義の提供している Docker を使ってデプロイを実行した人へ</strong></p>
</div>
<div class="paragraph">
<p>SSH によるログインは， <strong>Docker の外</strong> (すなわちクライアントマシン本体) から行わなければならない．
なぜなら，Jupyter を開くウェブブラウザは Docker の外にあるからである．</p>
</div>
<div class="paragraph">
<p>その際，秘密鍵を Docker の外に持ってこなければならない．手っ取り早い方法は， <code>cat ~/.ssh/HirakeGoma</code> と打って，出力結果をコピー&amp;ペーストで Docker の外に持ってくる方法である．</p>
</div>
<div class="paragraph">
<p>あるいは <code>-v</code> オプションをつけて，ファイルシステムをマウントしてもよい (詳しくは <a href="https://docs.docker.com/storage/volumes/">参照</a>)．</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>SSHによるログインができたら，早速，GPUの状態を確認してみよう．以下のコマンドを実行する．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>nvidia-smi</code></pre>
</div>
</div>
<div class="paragraph">
<p><a href="#handson_02_nvidia-smi">Figure 21</a> のような出力が得られるはずである．出力を見ると， Tesla T4 型のGPUが1台搭載されていることが確認できる．その他，GPU Driver や CUDA のバージョンを確認することができる．</p>
</div>
<div id="handson_02_nvidia-smi" class="imageblock text-center">
<div class="content">
<img src="imgs/handson-02/nvidia-smi.png" alt="nvidia-smi" width="700">
</div>
<div class="title">Figure 21. nvidia-smi の出力</div>
</div>
</div>
<div class="sect2">
<h3 id="_jupyter_notebook_の起動">6.5. Jupyter notebook の起動</h3>
<div class="paragraph">
<p><a href="https://jupyter.org/">Jupyter notebook</a> とは，インタラクティブに Python のプログラムを書いたり実行したりするためのツールである．Jupyter は GUIとしてウェブブラウザを介してアクセスする形式をとっており，まるでノートを書くように，プロットやテーブルのデータも美しく表示することができる (<a href="#handson_02_welcome_jupyter">Figure 22</a>)．Python に慣れている読者は，きっと一度は使ったことがあるだろう．</p>
</div>
<div id="handson_02_welcome_jupyter" class="imageblock text-center">
<div class="content">
<img src="imgs/handson-02/welcome_to_jupyter.png" alt="welcome to jupyter" width="700">
</div>
<div class="title">Figure 22. Jupyter notebook の画面</div>
</div>
<div class="paragraph">
<p>このハンズオンでは， Jupyter notebook を使ってディープラーニングのプログラムを書いたり実行していく．
DLAMI には既に Jupyter がインストールされているので，特段の設定なしに使い始めることができる．</p>
</div>
<div class="paragraph">
<p>早速， Jupyter を起動しよう． SSHでログインした先のEC2インスタンスで，次のコマンドを実行すればよい．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span><span class="nb">cd</span> ~ <span class="c"># go to home directory</span>
<span class="nv">$ </span>jupyter notebook</code></pre>
</div>
</div>
<div class="paragraph">
<p>このコマンドを実行すると， <a href="#handson_02_jupyter_launch">Figure 23</a> のような出力が確認できるだろう．
この出力から，Jupyter のサーバーが EC2 インスタンスの <code>localhost:8888</code> というアドレスに起動していることがわかる．
また， <code>localhost:8888</code> に続く <code>?token=XXXXXXX</code> は，アクセスに使うための一時的なトークンである．</p>
</div>
<div id="handson_02_jupyter_launch" class="imageblock text-center">
<div class="content">
<img src="imgs/handson-02/jupyter_launch.png" alt="jupyter launch" width="700">
</div>
<div class="title">Figure 23. Jupyter notebook サーバーを起動</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Jupyter notebook を初回に起動するときは，起動に少し時間がかかることがある．
1,2分じっと待つ．</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>先ほど，ポートフォワーディングのオプションをつけてSSH接続をしているので， Jupyter の起動している <code>localhost:8888</code> には，ローカルマシンの <code>localhost:8931</code> からアクセスすることができる．</p>
</div>
<div class="paragraph">
<p>したがって，ローカルマシンから Jupyter にアクセスするには，ウェブブラウザ (Chrome, FireFox など)から次のアドレスにアクセスすれば良い．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code>http://localhost:8931/?token=XXXXXXXXXX</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>?token=XXXXXX</code> の部分は，上で Jupyter を起動したときに発行されたトークンの値に置き換える．</p>
</div>
<div class="paragraph">
<p>上のアドレスにアクセスすると， Jupyter のホーム画面が起動するはずである (<a href="#handson_02_jupyter_home">Figure 24</a>)．
これで， Jupyter の準備が整った！</p>
</div>
<div id="handson_02_jupyter_home" class="imageblock text-center">
<div class="content">
<img src="imgs/handson-02/jupyter_home.png" alt="jupyter home" width="700">
</div>
<div class="title">Figure 24. Jupyter ホーム画面</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>DLAMI の <a href="https://docs.aws.amazon.com/dlami/latest/devguide/setup-jupyter-config.html">公式ドキュメンテーション</a> では，自分で指定したパスワードとSSLを有効化することを推奨している．
本ハンズオンでは時間の節約のためにスキップしているが，今後個人で使うときはより強固にセキュリティを設定することを推奨する．</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Jupyter notebook の使い方(超簡易版)</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>Shift</code> + <code>Enter</code>: セルを実行</p>
</li>
<li>
<p><code>Esc</code>: <strong>Command mode</strong> に遷移</p>
</li>
<li>
<p>メニューバーの "+" ボタン または Command mode で <code>A</code> : セルを追加</p>
</li>
<li>
<p>メニューバーの "ハサミ" ボタン または Command mode で <code>X</code> : セルを削除</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>ショートカットの一覧などは <a href="https://towardsdatascience.com/jypyter-notebook-shortcuts-bf0101a98330">このブログ</a> が参考になる．</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_pytorchはじめの一歩">6.6. PyTorchはじめの一歩</h3>
<div class="paragraph">
<p><a href="https://pytorch.org/">PyTorch</a> は Facebook AI Research LAB (FAIR) が中心となって開発を進めている，オープンソースのディープラーニングのライブラリである．
PyTorch は 有名な例で言えば Tesla 社の自動運転プロジェクトなどで使用されており，2020/06時点において最も人気の高いディープラーニングライブラリの一つである．
本ハンズオンでは， PyTorch を使ってディープラーニングの実践を行う．</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>PyTorch の歴史のお話</p>
</div>
<div class="paragraph">
<p>Facebook は PyTorch の他に Caffe2 と呼ばれるディープラーニングのフレームワークを開発していた (初代Caffe は UC Berkley の博士学生だった Yangqing Jia によって創られた)．
Caffe2 は 2018年に PyTorch プロジェクトに合併された．</p>
</div>
<div class="paragraph">
<p>また，2019年12月，日本の Preferred Networks 社が開発していた <a href="https://chainer.org/">Chainer</a> も，開発を終了し，PyTorchの開発チームと協業していくことが発表された (<a href="https://chainer.org/announcement/2019/12/05/released-v7-ja.html">プレスリリース</a>)．
PyTorch には，開発統合前から Chainer からインスパイアされた API がいくつもあり， Chainer の DNA は今も PyTorch に引き継がれているのである&#8230;&#8203;!</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>本格的なディープラーニングの計算に移る前に， PyTorch ライブラリを使って， GPU で計算を行うとはどういうものか，その入り口に触れてみよう．</p>
</div>
<div class="paragraph">
<p>まずは，新しいノートブックを作成する．
Jupyterのホーム画面の右上の "New" を押し，"conda_pytorch_p36" という環境を選択した上で，新規ノートブックを作成する (<a href="#handson_02_jupyeter_new">Figure 25</a>)．
"conda_pytorch_p36" の仮想環境には， PyTorch がインストール済みである (他にある TensorFlow なども同様)．</p>
</div>
<div id="handson_02_jupyeter_new" class="imageblock text-center">
<div class="content">
<img src="imgs/handson-02/jupyter_new.png" alt="jupyter_new" width="700">
</div>
<div class="title">Figure 25. 新規ノートブックの作成． "conda_pytorch_p36" の環境を選択する．</div>
</div>
<div class="paragraph">
<p>次のようなプログラムを書いてみよう (<a href="#handson_02_jupyeter_pytorch">Figure 26</a>)．</p>
</div>
<div id="handson_02_jupyeter_pytorch" class="imageblock text-center">
<div class="content">
<img src="imgs/handson-02/jupyter_pytorch.png" alt="jupyter_pytorch" width="700">
</div>
<div class="title">Figure 26. PyTorch始めの一歩</div>
</div>
<div class="paragraph">
<p>まずは， PyTorch をインポートする．さらに，GPUが使える環境にあるか，確認する．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="python"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno">1
2
</pre></td><td class="code"><pre><span class="kn">import</span> <span class="nn">torch</span>
<span class="k">print</span><span class="p">(</span><span class="s">"Is CUDA ready?"</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">())</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>出力:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code>Is CUDA ready? True</code></pre>
</div>
</div>
<div class="paragraph">
<p>次に，3x3 のランダムな行列を <strong>CPU</strong> 上に作ってみよう．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="python"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno">1
2
</pre></td><td class="code"><pre><span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>出力:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code>tensor([[0.6896, 0.2428, 0.3269],
        [0.0533, 0.3594, 0.9499],
        [0.9764, 0.5881, 0.0203]])</code></pre>
</div>
</div>
<div class="paragraph">
<p>次に，行列を <strong>GPU</strong> 上に作成する．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="python"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno">1
2
</pre></td><td class="code"><pre><span class="n">y</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="s">"cuda"</span><span class="p">)</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s">"cuda"</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>そして，行列 <code>x</code> と <code>y</code> の加算を，<strong>GPU上で実行する</strong>．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="python"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno">1
2
</pre></td><td class="code"><pre><span class="n">z</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span>
<span class="k">print</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>出力:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code>tensor([[1.6896, 1.2428, 1.3269],
        [1.0533, 1.3594, 1.9499],
        [1.9764, 1.5881, 1.0203]], device='cuda:0')</code></pre>
</div>
</div>
<div class="paragraph">
<p>最後に，GPU上にある行列を，CPUに戻す．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="python"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno">1
2
</pre></td><td class="code"><pre><span class="n">z</span> <span class="o">=</span> <span class="n">z</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s">"cpu"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>出力:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code>tensor([[1.6896, 1.2428, 1.3269],
        [1.0533, 1.3594, 1.9499],
        [1.9764, 1.5881, 1.0203]])</code></pre>
</div>
</div>
<div class="paragraph">
<p>以上の例は， GPU を使った計算の初歩の初歩であるが，雰囲気はつかめただろうか？ CPU と GPU で明示的にデータを交換するのが肝である．この例は，たった 3x3 の行列の足し算なので，GPUを使う意味はまったくないが，これが数千，数万のサイズの行列になった時，GPUは格段の威力を発揮する．</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>完成した Jupyter notebook は <a href="https://gitlab.com/tomomano/intro-aws/-/tree/master/handson/02-ec2-dnn/pytorch/pytorch_get_started.ipynb">/handson/02-ec2-dnn/pytorch/pytorch_get_started.ipynb</a> にある．
Jupyter の画面右上の "Upload" から，このファイルをアップロードして，コードを走らせることが可能である．</p>
</div>
<div class="paragraph">
<p>しなしながら，勉強の時にはコードはすべて自分の手で打つことが，記憶に残りやすくより効果的である，というのが筆者の意見である．</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_cpu_vs_gpu_の簡易ベンチマーク">6.7. CPU vs GPU の簡易ベンチマーク</h3>
<div class="paragraph">
<p>実際に，ベンチマークを取ることでGPUとCPUの速度を比較をしてみよう．実行時間を計測するツールとして， Jupyter の提供する <a href="https://ipython.readthedocs.io/en/stable/interactive/magics.html">%time</a> マジックコマンドを利用する．</p>
</div>
<div class="paragraph">
<p>まずは，CPUを使用して，10000x10000 の行列の行列積を計算した場合の速度を測ってみよう．先ほどのノートブックの続きに，次のコードを実行する．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="python"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="code"><pre><span class="n">s</span> <span class="o">=</span> <span class="mi">10000</span>
<span class="n">device</span> <span class="o">=</span> <span class="s">"cpu"</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

<span class="o">%</span><span class="n">time</span> <span class="n">z</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>出力は以下のようなものが得られるだろう．これは，行列積の計算に実時間で5.8秒かかったことを意味する (実行のたびに計測される時間はばらつくことに留意)．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code>CPU times: user 11.5 s, sys: 140 ms, total: 11.6 s
Wall time: 5.8 s</code></pre>
</div>
</div>
<div class="paragraph">
<p>次に，GPUを使用して，同じ演算を行った場合の速度を計測しよう．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="python"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="code"><pre><span class="n">s</span> <span class="o">=</span> <span class="mi">10000</span>
<span class="n">device</span> <span class="o">=</span> <span class="s">"cuda"</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">synchronize</span><span class="p">()</span>

<span class="o">%</span><span class="n">time</span> <span class="n">z</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">);</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">synchronize</span><span class="p">()</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>出力は以下のようなものになるだろう．GPUでは 553ミリ秒 で計算を終えることができた！</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code>CPU times: user 334 ms, sys: 220 ms, total: 554 ms
Wall time: 553 ms</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>PyTorch において， GPU での演算は asynchronous (非同期) で実行される．その理由で，上のベンチマークコードでは， <code>torch.cuda.synchronize()</code> というステートメントを埋め込んである．</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>このベンチマークでは， <code>dtype=torch.float32</code> と指定することで，32bitの浮動小数点型を用いている．ディープラーニングの学習および推論の計算には，32bit型，場合によっては16bit型が使われるのが一般的である．これの主な理由として，教師データやミニバッチに起因するノイズが，浮動小数点の精度よりも大きいことがあげられる．32bit/16bit を採用することで，メモリー消費を抑えたり，計算速度の向上が達成できる．</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>上記のベンチマークから，GPUを用いることで，<strong>約10倍のスピードアップ</strong>を実現することができた．スピードアップの割合は，演算の種類や行列のサイズに依存する．行列積は，そのなかでも最も速度向上が見込まれる演算の一つである．</p>
</div>
</div>
<div class="sect2">
<h3 id="sec_mnist_using_jupyter">6.8. 実践ディープラーニング! MNIST手書き数字認識タスク</h3>
<div class="paragraph">
<p>ここまで，AWS上でディープラーニングの計算をするための概念や前提知識をながながと説明してきたが，ついにここからディープラーニングの計算を実際に走らせてみる．</p>
</div>
<div class="paragraph">
<p>ここでは，機械学習のタスクで最も初歩的かつ有名な <strong>MNIST データセットを使った数字認識</strong>を扱う (<a href="#handson_02_mnist_examples">Figure 27</a>)．
0から9までの手書きの数字の画像が与えられ，その数字が何の数字なのかを当てる，というシンプルなタスクである．</p>
</div>
<div id="handson_02_mnist_examples" class="imageblock text-center">
<div class="content">
<img src="imgs/handson-02/mnist_examples.png" alt="mnist_examples" width="400">
</div>
<div class="title">Figure 27. MNIST 手書き数字データセット</div>
</div>
<div class="paragraph">
<p>今回は， MNIST 文字認識タスクを，<strong>畳み込みニューラルネットワーク (Convolutional Neural Network; CNN)</strong> を使って解く．
ソースコードは <a href="https://gitlab.com/tomomano/intro-aws/-/tree/master/handson/02-ec2-dnn/pytorch/">/handson/02-ec2-dnn/pytorch/</a> にある <code>mnist.ipynb</code> と <code>simple_mnist.py</code> である．
なお，このプログラムは， <a href="https://github.com/pytorch/examples/tree/master/mnist">PyTorch の公式 Example Project 集</a> を参考に，多少の改変を行ったものである．</p>
</div>
<div class="paragraph">
<p>まず最初に，カスタムのクラスや関数が定義された <code>simple_mnist.py</code> をアップロードしよう (<a href="#handson_02_jupyter_upload">Figure 28</a>)．
画面右上の "Upload" ボタンをクリックし，ファイルを選択すればよい．
この Python プログラムの中に，CNN のモデルや，学習の各イテレーションにおけるパラメータの更新などが記述されている．
今回は，この中身を説明することはしないが，興味のある読者は，自分でソースコードを読んでみるとよい．</p>
</div>
<div id="handson_02_jupyter_upload" class="imageblock text-center">
<div class="content">
<img src="imgs/handson-02/jupyter_upload.png" alt="jupyter upload" width="600">
</div>
<div class="title">Figure 28. <code>simple_mnist.py</code> をアップロード</div>
</div>
<div class="paragraph">
<p><code>simple_mnist.py</code> をアップロードできたら，次に新しい notebook を作成しよう．
"conda_pytorch_p36" の環境を選択することを忘れずに．</p>
</div>
<div class="paragraph">
<p>新しいノートブックが起動したら，まず最初に，必要なライブラリをインポートしよう．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="python"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="code"><pre><span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">torch.optim</span> <span class="k">as</span> <span class="n">optim</span>
<span class="kn">import</span> <span class="nn">torchvision</span>
<span class="kn">from</span> <span class="nn">torchvision</span> <span class="kn">import</span> <span class="n">datasets</span><span class="p">,</span> <span class="n">transforms</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>

<span class="c1"># custom functions and classes
</span><span class="kn">from</span> <span class="nn">simple_mnist</span> <span class="kn">import</span> <span class="n">Model</span><span class="p">,</span> <span class="n">train</span><span class="p">,</span> <span class="n">test</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p><a href="https://pytorch.org/docs/stable/torchvision/index.html">torchvision</a> パッケージには，MNIST データセットをロードするなどの便利な関数が含まれている．
また，今回のハンズオンで使うカスタムのクラス・関数 (<code>Model</code>, <code>train</code>, <code>test</code>) のインポートを行っている．</p>
</div>
<div class="paragraph">
<p>次に，MNIST テストデータをダウンロードしよう．
同時に，画像データの輝度の正規化も行っている．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="python"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="code"><pre><span class="n">transf</span> <span class="o">=</span> <span class="n">transforms</span><span class="o">.</span><span class="n">Compose</span><span class="p">([</span><span class="n">transforms</span><span class="o">.</span><span class="n">ToTensor</span><span class="p">(),</span>
                             <span class="n">transforms</span><span class="o">.</span><span class="n">Normalize</span><span class="p">((</span><span class="mf">0.1307</span><span class="p">,),</span> <span class="p">(</span><span class="mf">0.3081</span><span class="p">,))])</span>

<span class="n">trainset</span> <span class="o">=</span> <span class="n">datasets</span><span class="o">.</span><span class="n">MNIST</span><span class="p">(</span><span class="n">root</span><span class="o">=</span><span class="s">'./data'</span><span class="p">,</span> <span class="n">train</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">download</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">transf</span><span class="p">)</span>
<span class="n">trainloader</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">DataLoader</span><span class="p">(</span><span class="n">trainset</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

<span class="n">testset</span> <span class="o">=</span> <span class="n">datasets</span><span class="o">.</span><span class="n">MNIST</span><span class="p">(</span><span class="n">root</span><span class="o">=</span><span class="s">'./data'</span><span class="p">,</span> <span class="n">train</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">download</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">transf</span><span class="p">)</span>
<span class="n">testloader</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">DataLoader</span><span class="p">(</span><span class="n">trainset</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>今回扱う MNIST データは 28x28 ピクセルの正方形の画像(モノクロ)と，それぞれのラベル(0 - 9 の数字)の組で構成されている．
いくつかのデータを抽出して，可視化してみよう．
<a href="#handson_02_mnist_ground_truth">Figure 29</a> のような出力が得られるはずである．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="python"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
</pre></td><td class="code"><pre><span class="n">examples</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">testloader</span><span class="p">)</span>
<span class="n">example_data</span><span class="p">,</span> <span class="n">example_targets</span> <span class="o">=</span> <span class="n">examples</span><span class="o">.</span><span class="nb">next</span><span class="p">()</span>

<span class="k">print</span><span class="p">(</span><span class="s">"Example data size:"</span><span class="p">,</span> <span class="n">example_data</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">example_data</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">cmap</span><span class="o">=</span><span class="s">'gray'</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="s">'none'</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">"Ground Truth: {}"</span><span class="o">.</span><span class="nb">format</span><span class="p">(</span><span class="n">example_targets</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">([])</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">yticks</span><span class="p">([])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div id="handson_02_mnist_ground_truth" class="imageblock text-center">
<div class="content">
<img src="imgs/handson-02/mnist_ground_truth.png" alt="mnist_ground_truth" width="700">
</div>
<div class="title">Figure 29. MNIST の手書き数字画像とその教師ラベル</div>
</div>
<div class="paragraph">
<p>次に， CNN のモデルを定義する．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="python"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno">1
2
</pre></td><td class="code"><pre><span class="n">model</span> <span class="o">=</span> <span class="n">Model</span><span class="p">()</span>
<span class="n">model</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s">"cuda"</span><span class="p">)</span> <span class="c1"># load to GPU</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>今回使う <code>Model</code> は <code>simple_mnist.py</code> の中で定義されている．
このモデルは，<a href="#handson_02_cnn_architecture">Figure 30</a> に示したような，２層の畳み込み層と2層の全結合層からなるネットワークである．
出力層 (output layer) には Softmax 関数を使用し，損失関数 (Loss function) には 負の対数尤度関数 (Negative log likelyhood; NLL) を使用している．</p>
</div>
<div id="handson_02_cnn_architecture" class="imageblock text-center">
<div class="content">
<img src="imgs/handson-02/cnn_architecture.png" alt="cnn architecture" width="700">
</div>
<div class="title">Figure 30. 本ハンズオンで使用するニューラルネットの構造．</div>
</div>
<div class="paragraph">
<p>続いて， CNN のパラメータを更新する最適化アルゴリズムを定義する．
ここでは， <strong>Stochastic Gradient Descent (SGD)</strong> を使用している．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="python"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno">1
</pre></td><td class="code"><pre><span class="n">optimizer</span> <span class="o">=</span> <span class="n">optim</span><span class="o">.</span><span class="n">SGD</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">momentum</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>これで，準備が整った．
CNN の学習ループを開始しよう!</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="python"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
</pre></td><td class="code"><pre><span class="n">train_losses</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
    <span class="n">losses</span> <span class="o">=</span> <span class="n">train</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">trainloader</span><span class="p">,</span> <span class="n">optimizer</span><span class="p">,</span> <span class="n">epoch</span><span class="p">)</span>
    <span class="n">train_losses</span> <span class="o">=</span> <span class="n">train_losses</span> <span class="o">+</span> <span class="n">losses</span>
    <span class="n">test</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">testloader</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">train_losses</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s">"Iterations"</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s">"Train loss"</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>ここでは5エポック分学習を行っている．
GPU を使えば，これくらいの計算であれば1分程度で完了するだろう．</p>
</div>
<div class="paragraph">
<p>出力として， <a href="#handson_02_train_loss">Figure 31</a> のようなプロットが得られるはずである．
イテレーションを重ねるにつれて，損失関数 (Loss function) の値が減少している (=精度が向上している) ことがわかる．</p>
</div>
<div class="paragraph">
<p>出力には各エポック終了後のテストデータに対する精度も表示されている．
最終的には 99% 程度の極めて高い精度を実現できていることが確認できるだろう (<a href="#handson_02_mnist_final_score">Figure 32</a>)．</p>
</div>
<div id="handson_02_train_loss" class="imageblock text-center">
<div class="content">
<img src="imgs/handson-02/train_loss.png" alt="train_loss" width="500">
</div>
<div class="title">Figure 31. 学習の進行に対する Train loss の変化</div>
</div>
<div id="handson_02_mnist_final_score" class="imageblock text-center">
<div class="content">
<img src="imgs/handson-02/mnist_final_score.png" alt="mnist_final_score" width="700">
</div>
<div class="title">Figure 32. 学習したCNNのテストデータに対するスコア (5エポック後)</div>
</div>
<div class="paragraph">
<p>最後に，学習した CNN の推論結果を可視化してみよう．
次のコードを実行することで， <a href="#handson_02_mnist_mnist_prediction">Figure 33</a> のような出力が得られるだろう．
この図で，下段右下などは，"1"に近い見た目をしているが，きちんと"9"と推論できている．
なかなか賢い CNN を作り出すことができたようだ！</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="python"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
</pre></td><td class="code"><pre><span class="n">model</span><span class="o">.</span><span class="nb">eval</span><span class="p">()</span>

<span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
    <span class="n">output</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">example_data</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s">"cuda"</span><span class="p">))</span>

<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">example_data</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">cmap</span><span class="o">=</span><span class="s">'gray'</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="s">'none'</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">"Prediction: {}"</span><span class="o">.</span><span class="nb">format</span><span class="p">(</span><span class="n">output</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdim</span><span class="o">=</span><span class="bp">True</span><span class="p">)[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">([])</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">yticks</span><span class="p">([])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div id="handson_02_mnist_mnist_prediction" class="imageblock text-center">
<div class="content">
<img src="imgs/handson-02/mnist_prediction.png" alt="mnist_prediction" width="700">
</div>
<div class="title">Figure 33. 学習した CNN による，MNIST画像の推論結果</div>
</div>
<div class="paragraph">
<p>おめでとう！
これで，めでたくあなたは AWS クラウドの仮想サーバーを使って，最初のディープラーニングの計算を行うことができた！
MNIST 文字認識のタスクを行うニューラルネットを，GPUを使って高速に学習させ，現実的な問題を一つ解くことができたのである．</p>
</div>
<div class="paragraph">
<p>興味のある読者は，今回のハンズオンを雛形に，自分で他のディープラーニングの計算を走らせてみるとよいだろう．</p>
</div>
</div>
<div class="sect2">
<h3 id="_スタックの削除">6.9. スタックの削除</h3>
<div class="paragraph">
<p>これにて，ハンズオン第二回の内容はすべて説明した．
クラウドの利用料金を最小化するため，使い終わったEC2インスタンスはすぐさま削除しよう．</p>
</div>
<div class="paragraph">
<p>ハンズオン第一回と同様に， AWS の CloudFormation コンソールか， AWS CLI により削除を実行する (詳細は <a href="#handson_01_delete_stack">Section 4.4.8</a> 参照)．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>cdk destroy</code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p><strong>スタックの削除は各自で必ず行うこと！</strong> 行わなかった場合，EC2インスタンスの料金が発生し続けることになる！ <code>g4dn.xlarge</code> は $0.526 / hour の料金設定なので，一日起動しつづけると約$12の請求が発生することになる！</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>AWS で， GPU 搭載型のインスタンスは高めの料金設定がされている．
したがって，プログラムの開発やデバッグはローカルマシンの GPU で行い，大規模なデータを処理するときや，複数の GPU を並列に使って高速にモデルの学習を行いたい場合などにクラウドを利用する，と使い分けるのがよいと筆者は考えている．</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_docker_入門">7. Docker 入門</h2>
<div class="sectionbody">
<div class="paragraph">
<p><a href="#sec_scientific_computing">Section 5</a>，<a href="#sec_handson02">[sec_handson02]</a> にわたって， AWS 上に仮想サーバーを立ち上げ，深層学習のプログラムを走らせる方法を紹介してきた．
ここまでは，<strong>単一のサーバー</strong>を立ち上げ，それに SSH でログインをして，コマンドを叩くことで計算を行ってきた．
いわば，<em>パーソナルコンピュータの延長</em>のような形でクラウドを使ってきたわけである．</p>
</div>
<div class="paragraph">
<p>このような，インターネットのどこからでもアクセスできるパーソナルコンピュータとしてのクラウドという使い方も，もちろん便利であるし，いろいろな応用の可能性がある．
しかし，これだけではクラウドの本当の価値は十分に発揮されていないと言うべきだろう．
<a href="#chap_cloud_basics">Section 2</a> で述べたように，現代的なクラウドの一番の強みは自由に計算機の規模を拡大できることにある．
すなわち，<strong>多数のサーバーを同時に起動し，複数のジョブを分散並列的に実行させることで大量のデータを処理してこそ，クラウドの本領が発揮される</strong>のである．</p>
</div>
<div class="paragraph">
<p>本章からはじまる3章を使って，クラウドを使うことでどのように大規模な計算システムを構築しビッグデータの解析に立ち向かうのか，その片鱗をお見せしたい．
特に，前章で扱った深層学習を，どのようにビッグデータに適用していくかという点に焦点を絞って議論していきたい．
そのための前準備として，本章では <a href="https://www.docker.com/">Docker</a> と呼ばれる計算機環境の仮想化ソフトウェアを紹介する．
現代のクラウドは Docker なしには成り立たないといっても過言ではないだろう．
クラウドに限らず，ローカルで行う計算処理にも Docker は大変便利である．
クラウドからは少し話が離れるが，しっかりと理解して前に進んでもらいたい．</p>
</div>
<div class="sect2">
<h3 id="_機械学習の大規模化">7.1. 機械学習の大規模化</h3>
<div class="paragraph">
<p>先ほどから"計算システムの大規模化"と繰り返し唱えているが，それは具体的にはどのようなものを指しているのか？
ここでは大規模データを処理するための計算機システムを，機械学習を例にとって見てみよう．</p>
</div>
<div class="paragraph">
<p><a href="#sec_scientific_computing">Section 5</a> で紹介した <a href="https://github.com/openai/gpt-3">GPT-3</a> のような，超巨大な数のパラメータを有する深層学習モデルを学習させたいとしよう．
そのような計算を行いたい場合，一つのサーバーでは計算力が到底足りない．
したがって，典型的には <a href="#big_dnn_training">Figure 34</a> に示すような計算システムの設計がなされる．
すなわち，大量の教師データを，小さなチャンクとして複数のマシンに分散し，並列的にニューラルネットのパラメータを最適化していくという構造である．</p>
</div>
<div id="big_dnn_training" class="imageblock text-center">
<div class="content">
<img src="imgs/big_dnn_training.png" alt="big_dnn_training" width="700">
</div>
<div class="title">Figure 34. 複数の計算機を使った大規模な深層学習モデルの訓練</div>
</div>
<div class="paragraph">
<p>あるいは，学習済みのモデルを大量のデータに適用し，解析を行いたいとしよう．
例えば， SNS のプラットフォームで大量の画像が与えられて，それぞれの写真に何が写っているのかをラベルづけする，などのアプリケーションを想定できる．
そのような場合は， <a href="#big_dnn_inference">Figure 35</a> のようなアーキテクチャが考えられるだろう．
すなわち，大量のデータを複数のマシンで分割し，それぞれのマシンで推論の計算を行うというような構造である．</p>
</div>
<div id="big_dnn_inference" class="imageblock text-center">
<div class="content">
<img src="imgs/big_dnn_inference.png" alt="big_dnn_inference" width="700">
</div>
<div class="title">Figure 35. 複数の計算機を使った大規模なディープラーニングモデルの学習</div>
</div>
<div class="paragraph">
<p>このような複数の計算機を同時に走らせるようなアプリケーションをクラウド上で実現するには，どのようにすればよいのだろうか？</p>
</div>
<div class="paragraph">
<p>ひとつ重要なポイントとして， <a href="#big_dnn_training">Figure 34</a> や <a href="#big_dnn_inference">Figure 35</a> で起動している複数のマシンは，<strong>基本的に全く同一のOS・計算環境を有している</strong>点である．
ここで，個人のコンピュータでやるようなインストールの操作を，各マシンで行うこともできるが，それは大変な手間であるし，メンテナンスも面倒だろう．
すなわち，大規模な計算システムを構築するには，<strong>簡単に計算環境を複製できるような仕組み</strong>が必要であるということがわかる．</p>
</div>
<div class="paragraph">
<p>そのような目的を実現するために使われるのが， <a href="https://www.docker.com/">Docker</a> と呼ばれるソフトウェアである．</p>
</div>
</div>
<div class="sect2">
<h3 id="_docker_とは">7.2. Docker とは</h3>
<div class="imageblock text-center">
<div class="content">
<img src="imgs/docker_log.png" alt="docker" width="500">
</div>
<div class="title">Figure 36. Docker のロゴ</div>
</div>
<div class="paragraph">
<p>Docker とは， <strong>コンテナ (Container)</strong> と呼ばれる仮想環境下で，ホストOSとは独立した別の計算環境を走らせるためのソフトウェアである．
Docker を使うことで， OS を含めた全てのプログラムをコンパクトにパッケージングすることが可能になる (パッケージされたひとつの計算環境のことを <strong>イメージ (Image) </strong>と呼ぶ)．
Dockerを使うことで，クラウドのサーバー上に瞬時に計算環境を複製することが可能になり，上で見たような複数の計算機を同時に走らせるためのシステムが実現できる．</p>
</div>
<div class="paragraph">
<p>Docker は2013年に Solomon Hykes らを中心に開発され，以降爆発的に普及し，クラウドコンピューティングだけでなく，機械学習・科学計算の文脈などで，欠かすことのできないソフトウェアとなった．
概念としては， Docker は仮想マシン (Virtual machine; VM) にとても近い．
ここでは， VM との対比をしながら，Docker とはなにかを簡単に説明しよう．</p>
</div>
<div class="paragraph">
<p>仮想マシン(VM) とは，ホストとなるマシンの上に，仮想化されたOSを走らせる技術である (<a href="#docker_vs_vm">Figure 37</a>)．
VM には <strong>ハイパーバイザー (Hypervisor)</strong> と呼ばれるレイヤーが存在する．
Hypervisor はまず，物理的な計算機リソース (CPU, RAM, network など) を分割し，仮想化する．
例えば， ホストマシンに物理的なCPUが4コアあるとして，ハイパーバイザーはそれを (2,2) 個の組に仮想的に分割することができる．
VM 上で起動する OS には，ハイパーバイザーによって仮想化されたハードウェアが割り当てられる．
VM 上で起動する OS は基本的に完全に独立であり，例えば OS-A は OS-B に割り当てられたCPUやメモリー領域にアクセスすることはできない．
VM を作成するための有名なソフトウェアとしては， <a href="https://www.vmware.com/">VMware</a>， <a href="https://www.virtualbox.org/">VirtualBox</a>， <a href="https://xenproject.org/">Xen</a> などがある．
また，これまで触ってきた EC2 も，基本的に VM 技術を使うことで所望のスペックを持った仮想マシンがユーザーに提示される．</p>
</div>
<div class="paragraph">
<p>Docker も， VM と同様に，仮想化された OS をホストのOS上に走らせるための技術である．
VM に対し， Docker ではハードウェアレベルの仮想化は行われておらず，すべての<strong>仮想化はソフトウェアレベルで実現されている</strong> (<a href="#docker_vs_vm">Figure 37</a>)．
Docker で走る仮想 OS は，<strong>多くの部分をホストのOSに依存しており，結果として非常にコンパクトである</strong>．
その結果， Docker で仮想 OS を起動するために要する時間は， VM に比べて圧倒的に早い．
また， パッケージ化された環境 (=image) のサイズも完全なOSに比べ圧倒的に小さくなるので，ネットワークを通じたやり取りが非常に高速化される点も重要である．
加えて， VM のいくつかの実装では，メタル (仮想化マシンに対して，物理的なハードウェア上で直接起動する場合のこと) と比べ，ハイパーバイザーレイヤでのオーバーヘッドなどにより性能が低下することが知られているが， Docker ではメタルとほぼ同様の性能を引き出すことができるとされている．</p>
</div>
<div class="paragraph">
<p>その他， VM との相違点などはたくさんあるのだが，ここではこれ以上詳細には立ち入らない．
大事なのは， <strong>Docker とはとてもコンパクトかつハイパフォーマンスな仮想計算環境を作るツールである</strong>，という点である．
その手軽さゆえに，2013年の登場以降，クラウドシステムでの利用が急速に増加し，現代のクラウドでは欠くことのできない中心的な技術になっている．</p>
</div>
<div id="docker_vs_vm" class="imageblock text-center">
<div class="content">
<img src="imgs/docker_vs_vm.png" alt="docker_vs_vm" width="700">
</div>
<div class="title">Figure 37. Docker と VM の比較 (画像出典: <a href="https://www.docker.com/blog/containers-replacing-virtual-machines/" class="bare">https://www.docker.com/blog/containers-replacing-virtual-machines/</a>)</div>
</div>
</div>
<div class="sect2">
<h3 id="_docker_チュートリアル">7.3. Docker チュートリアル</h3>
<div class="paragraph">
<p>Docker とはなにかを理解するためには，実際に触って動かしてみるのが一番有効な手立てである．
ここでは， Docker の簡単なチュートリアルを行っていく．</p>
</div>
<div class="paragraph">
<p>Docker のインストールについては， <a href="#environments">Section 1.4</a> および <a href="https://docs.docker.com/engine/install/">公式のドキュメンテーション</a> を参照してもらいたい．
Docker のインストールが完了している前提で，以下は話を進めるものとする．</p>
</div>
<div class="sect3">
<h4 id="_image_をダウンロード">7.3.1. Image をダウンロード</h4>
<div class="paragraph">
<p>パッケージ化された Docker の仮想環境 (<strong>Image</strong> と呼ぶ) は， <a href="https://hub.docker.com/">Docker Hub</a> からダウンロードできる．
Docker Hub には，個人や企業・団体が作成した Docker Image が集められており， GitHub などと同じ感覚で，オープンな形で公開されている．</p>
</div>
<div class="paragraph">
<p>例えば， Ubuntu の Image は <a href="https://hub.docker.com/_/ubuntu">このリンク</a> で公開されており， <code>pull</code> コマンドを使うことでローカルにダウンロードすることができる．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>docker pull ubuntu:18.04</code></pre>
</div>
</div>
<div class="paragraph">
<p>ここで，イメージ名の <code>:</code> (コロン) 以降に続く文字列を <strong>タグ (tag)</strong> と呼び，主にバージョンを指定するなどの目的で使われる．</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p><code>pull</code> コマンドはデフォルトでは Docker Hub でイメージを検索し，ダウンロードを行う．
Docker image を公開するためのデータベース (registry と呼ぶ) は Docker Hub だけではなく，例えば GitLab や GitHub は独自の registry 機能を提供しているし，個人のサーバーで registry を立ち上げることも可能である．
Docker Hub 以外の registry から pull するには， <code>myregistry.local:5000/testing/test-image</code> のように，イメージ名の先頭につける形で registry のアドレス (とオプションとしてポート番号) を指定すればよい．</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_image_を起動">7.3.2. Image を起動</h4>
<div class="paragraph">
<p>Pull してきた Image を起動するには， <code>run</code> コマンドを使う．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>docker run <span class="nt">-it</span> ubuntu:18.04</code></pre>
</div>
</div>
<div class="paragraph">
<p>ここで， <code>-it</code> とは，インタラクティブな shell のセッションを開始するために必要なオプションである．</p>
</div>
<div class="paragraph">
<p>上のコマンドを実行すると，仮想化された Ubuntu が起動され，コマンドラインからコマンドが打ち込めるようになる (<a href="#docker_shell">Figure 38</a>)．</p>
</div>
<div id="docker_shell" class="imageblock text-center">
<div class="content">
<img src="imgs/docker_shell.png" alt="docker_shell" width="600">
</div>
<div class="title">Figure 38. Docker を使って ubuntu:18.04 イメージを起動</div>
</div>
<div class="paragraph">
<p>上で使った <code>ubuntu:18.04</code> のイメージは は，空の Ubuntu OS だが，既にプログラムがインストール済みのものもある．
これは， <a href="#sec_handson02">[sec_handson02]</a> でみた DLAMI と概念として似ている．
たとえば， pytorch がインストール済みの Image は <a href="https://hub.docker.com/r/pytorch/pytorch/">こちら</a> で公開されている．</p>
</div>
<div class="paragraph">
<p>これを起動してみよう．</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ docker run -it pytorch/pytorch</pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p><code>docker run</code> を実行したとき，ローカルに該当する Image がない場合は，自動的に Docker Hub からダウンロードされる</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>pytorch の container が起動したら， Python のシェルを立ち上げて， pytorch をインポートしてみよう．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>python3
Python 3.7.7 <span class="o">(</span>default, May  7 2020, 21:25:33<span class="o">)</span>
<span class="o">[</span>GCC 7.3.0] :: Anaconda, Inc. on linux
Type <span class="s2">"help"</span>, <span class="s2">"copyright"</span>, <span class="s2">"credits"</span> or <span class="s2">"license"</span> <span class="k">for </span>more information.
<span class="o">&gt;&gt;&gt;</span> import torch
<span class="o">&gt;&gt;&gt;</span> torch.cuda.is_available<span class="o">()</span>
False</code></pre>
</div>
</div>
<div class="paragraph">
<p>このように， Docker を使うことで簡単に特定のOS・プログラムの入った計算環境を再現することが可能になる．</p>
</div>
</div>
<div class="sect3">
<h4 id="_自分だけの_image_を作る">7.3.3. 自分だけの Image を作る</h4>
<div class="paragraph">
<p>自分の使うソフトウェア・ライブラリがインストールされた，自分だけの Image を作ることも可能である．</p>
</div>
<div class="paragraph">
<p>例えば， <a href="https://gitlab.com/tomomano/intro-aws/container_registry">本講義で提供している docker image</a> には， Python, Node.js, AWS CLI, AWS CDK などのソフトウェアがインストール済みであり，ダウンロードしてくるだけですぐにハンズオンのプログラムが実行できるようになっている．</p>
</div>
<div class="paragraph">
<p>カスタムの docker image を作るには， <code>Dockerfile</code> という名前のついたファイルを用意し，その中にどんなプログラムをインストールするかなどを記述していく．</p>
</div>
<div class="paragraph">
<p>具体例として，本講義で提供している Docker image のレシピを見てみよう (<a href="https://github.com/tomomano/intro-aws-2021/blob/main/docker/Dockerfile">/docker/Dockerfile</a>)．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="docker"><span class="k">FROM</span><span class="s"> node:12</span>

<i class="conum" data-value="1"></i><b>(1)</b>
<span class="k">RUN </span><span class="nb">cd</span> /opt <span class="se">\
</span>    <span class="o">&amp;&amp;</span> curl <span class="nt">-q</span> <span class="s2">"https://www.python.org/ftp/python/3.7.6/Python-3.7.6.tgz"</span> <span class="nt">-o</span> Python-3.7.6.tgz <span class="se">\
</span>    <span class="o">&amp;&amp;</span> <span class="nb">tar</span> <span class="nt">-xzf</span> Python-3.7.6.tgz <span class="se">\
</span>    <span class="o">&amp;&amp;</span> <span class="nb">cd </span>Python-3.7.6 <span class="se">\
</span>    <span class="o">&amp;&amp;</span> ./configure <span class="nt">--enable-optimizations</span> <span class="se">\
</span>    <span class="o">&amp;&amp;</span> make <span class="nb">install</span>

<span class="k">RUN </span><span class="nb">cd</span> /opt <span class="se">\
</span>    <span class="o">&amp;&amp;</span> curl <span class="s2">"https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip"</span> <span class="nt">-o</span> <span class="s2">"awscliv2.zip"</span> <span class="se">\
</span>    <span class="o">&amp;&amp;</span> unzip awscliv2.zip <span class="se">\
</span>    <span class="o">&amp;&amp;</span> ./aws/install

<i class="conum" data-value="2"></i><b>(2)</b>
<span class="k">RUN </span>npm <span class="nb">install</span> <span class="nt">-g</span> aws-cdk@1.105

<span class="c"># Make command line prettier...</span>
<span class="k">RUN </span><span class="nb">echo</span> <span class="s2">"alias ls='ls --color=auto'"</span> <span class="o">&gt;&gt;</span> /root/.bashrc
<span class="k">RUN </span><span class="nb">echo</span> <span class="s2">"PS1='</span><span class="k">${</span><span class="nv">debian_chroot</span>:+<span class="p">(</span><span class="nv">$debian_chroot</span><span class="p">)</span><span class="k">}</span><span class="se">\[\0</span><span class="s2">33[01;32m</span><span class="se">\]\u</span><span class="s2">@aws-handson</span><span class="se">\[\0</span><span class="s2">33[00m</span><span class="se">\]</span><span class="s2">:</span><span class="se">\[\0</span><span class="s2">33[01;34m</span><span class="se">\]\w\[\0</span><span class="s2">33[00m</span><span class="se">\]\$</span><span class="s2"> '"</span> <span class="o">&gt;&gt;</span> /root/.bashrc

<span class="k">RUN </span><span class="nb">mkdir</span> <span class="nt">-p</span> /root/.ssh
<span class="k">WORKDIR</span><span class="s"> /root</span>
<span class="k">ENTRYPOINT</span><span class="s"> ["/bin/bash"]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><code>Dockerfile</code> の中身の説明は特に行わないが，例えば上のコードで &lt;1&gt; で示したところは， Python 3.7 のインストールを実行している．
また， &lt;2&gt; で示したところは， AWS CDK のインストールを行っていることがわかるだろう．
このように，リアルな OS で行うのと同じ流れでインストールのコマンドを逐一記述していくことで，自分だけの Docker image を作成することができる．
一度 image を作成すれば，それを他人に渡すことで，他者も同一の計算環境を簡単に再構成することができる．</p>
</div>
<div class="paragraph">
<p>"ぼくの環境ではそのプログラム走ったのにな&#8230;&#8203;" というのは，プログラミング初心者ではよく耳にする会話だが， docker を使いこなせばそのような心配とは無縁である．
そのような意味で，クラウド以外の場面でも， Docker の有用性・汎用性は極めて高い．</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Is Docker alone?</div>
<div class="paragraph">
<p>コンテナを用いた仮想計算環境ツールとして Docker を紹介したが， 他に選択肢はないのか？
よくぞ聞いてくれた！
Docker の登場以降，複数のコンテナベースの仮想環境ツールが開発されてきた．
いずれのツールも，概念や API については Docker と共通するものが多いが，Docker にはない独自の特徴を提供している．
ここではその中でも有名ないくつかを紹介しよう．</p>
</div>
<div class="paragraph">
<p><a href="https://github.com/hpcng/singularity">Singularity</a> は科学計算や HPC (High Performance Computing) の分野で人気の高いコンテナプラットフォームである．
Singularity では大学・研究機関の HPC クラスターでの運用に適したような設計が施されている．
例えば， Docker は基本的には root 権限で実行されるのに対し， Singularity はユーザー権限 (コマンドを実行したユーザー自身) でプログラムが実行される．
root 権限での実行は Web サーバーのように個人・企業がある特定のサービスのために運用するサーバーでは問題ないが，多数のユーザーが多様な目的で計算を実行する HPC クラスターでは問題となる．
また，Singularity は独自のイメージの作成方法・エコシステムを持っているが， Docker イメージを Singularity のイメージに変換し実行する機能も有している．</p>
</div>
<div class="paragraph">
<p><a href="https://github.com/containers/podman">podman</a> は Red Hat 社によって開発されたもう一つのコンテナプラットフォームである．
podman は基本的に Docker と同一のコマンドを採用しているが，実装は Red Hat によってスクラッチから行われた．
podman では， Singularity と同様にユーザー権限でのプログラムの実行を可能であり，クラウドおよび HPC の両方の環境に対応するコンテナプラットフォームを目指して作られた．
また，その名前にある通り pod と呼ばれる独自の概念が導入されている．</p>
</div>
<div class="paragraph">
<p>著者の個人的な意見としては，現時点では Docker をマスターしておけば当面は困ることはないと考えるが，興味のある読者はぜひこれらのツールも試してみてはいかがだろうか？</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_elastic_container_service_ecs">7.4. Elastic Container Service (ECS)</h3>
<div class="imageblock">
<div class="content">
<img src="imgs/aws_logos/ECS.png" alt="ECS" width="100">
</div>
<div class="title">Figure 39. ECS のロゴ</div>
</div>
<div class="paragraph">
<p>以上で説明したように， Docker を使うことで仮想計算環境を簡単に複製・起動することが可能になる．
本章の最後の話題として， AWS 上で Docker を使った計算システムを構築する方法を解説しよう．</p>
</div>
<div class="paragraph">
<p><strong>Elastic Container Service (ECS)</strong> とは， Docker を使った計算機クラスターを AWS 上に作成するためのツールである．
ECS の概要を示したのが <a href="#ecs_overview">Figure 40</a> である．</p>
</div>
<div class="paragraph">
<p>ECS は，タスク (Task) と呼ばれる単位で管理された計算ジョブを受け付ける．
システムにタスクが投入されると，ECS はまず最初にタスクで指定された Docker イメージを外部レジストリからダウンロードしてくる．
外部レジストリとしては， DockerHub や AWS 独自の Docker レジストリである <strong>ECR (Elastic Container Registry)</strong> を指定することができる．</p>
</div>
<div class="paragraph">
<p>ECS の次の重要な役割はタスクの配置である．
予め定義されたクラスター内で，計算負荷が小さい仮想インスタンスを選び出し，そこに Docker イメージを配置することで指定された計算タスクが開始される．
"計算負荷が小さい仮想インスタンスを選び出す" と言ったが，具体的にどのような戦略・ポリシーでこの選択を行うかは，ユーザーの指定したパラメータに従う．</p>
</div>
<div class="paragraph">
<p>またクラスターのスケーリングもECSにおける重要な概念である．
スケーリングとは，クラスター内のインスタンスの計算負荷をモニタリングし，計算負荷に応じてインスタンスの起動・停止を行う操作を指す．
クラスター全体の計算負荷が指定された閾値 (例えば80%の稼働率) を超えていた場合，新たな仮想インスタンスをクラスター内に立ち上げる操作を scale-out (スケールアウト) と呼び，
負荷が減った場合に不要なインスタンスを停止する操作を scale-in (スケールイン) と呼ぶ．
クラスターのスケーリングは， ECS が他の AWS のサービスと連携することで実現される．
具体的には， EC2 の <strong>Auto scaling group (ASG)</strong> や <strong>Fargate</strong> の２つの選択肢が多くの場合選択される．
<strong>ASG</strong> については <a href="#sec_aws_batch">Section 9</a>, Fargate については <a href="#sec_fargate_qabot">Section 8</a> でより詳細に解説する．</p>
</div>
<div class="paragraph">
<p>これら一連のタスクの管理を， ECS は自動でやってくれる．
クラスターのスケーリングやタスクの配置に関してのパラメータを一度指定してしまえば，ユーザーは (ほとんどなにも考えずに) 大量のジョブを投入することができる．
クラスターのスケーリングによってジョブの量にちょうど十分なだけのインスタンスが起動し，ジョブが完了した後は不要なインスタンスはインスタンスすべて停止される．</p>
</div>
<div class="paragraph">
<p>さて，ここまで少し説明的な話が続いてしまったが，次章からは早速 Docker と AWS を使って大規模な並列計算システムを構築する</p>
</div>
<div id="ecs_overview" class="imageblock text-center">
<div class="content">
<img src="imgs/ecs.png" alt="ecs" width="500">
</div>
<div class="title">Figure 40. ECS の概要</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="sec_fargate_qabot">8. Hands-on #3: AWSで自動質問回答ボットを走らせる</h2>
<div class="sectionbody">
<div class="paragraph">
<p>ハンズオン第三回では，前章で学んだ Docker と ECS を使うことで，大規模化可能な機械学習システムの最もシンプルなものを実装する．</p>
</div>
<div class="paragraph">
<p>具体的には， Transformer と呼ばれるディープラーニングのモデルを使った自然言語処理を利用することで，
英語で与えられた質問への回答を自動で生成するボットを作成してみる．
特に，何百何千もの質問に同時に対応できるように，単一のサーバーに展開するのではなく，リクエストに応じて複数のサーバーを自動的に起動し，並列でジョブを実行させるシステムを設計する．
まさに，初歩的ながら， Siri・Alexa・Google assistant のようなシステムを作り上げるのである！</p>
</div>
<div class="paragraph">
<p>ハンズオンのソースコードはこちらのリンクにある &#8658; <a href="https://github.com/tomomano/intro-aws-2021/tree/main/handson/qa-bot" class="bare">https://github.com/tomomano/intro-aws-2021/tree/main/handson/qa-bot</a></p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>通常の機械学習のワークフローでは，モデルの訓練 &#8658; 推論 (データへの適用) が基本的な流れである．
しかしながら， GPU を使ったモデルの訓練はやや難易度が高いため，次章 (<a href="#sec_aws_batch">Section 9</a>) で取り扱う．
本章は，クラウド上でのクラスターの構築・タスクの管理などの概念に慣れるため，よりシンプルな実装で実現できる推論計算の並列化を紹介する．</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>このハンズオンでは 1CPU/4GB RAM の Fargate インスタンスを使用する．
計算の実行には 0.025 $/hour のコストが発生することに注意．</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="_fargate">8.1. Fargate</h3>
<div class="imageblock">
<div class="content">
<img src="imgs/aws_logos/Fargate.png" alt="Fargate" width="100">
</div>
<div class="title">Figure 41. Fargate のロゴ</div>
</div>
<div class="paragraph">
<p>ハンズオンに入っていく前に， <strong>Fargate</strong> という AWS の機能を知っておく必要がある．</p>
</div>
<div class="paragraph">
<p>ECS の概要を示した <a href="#ecs_overview">Figure 40</a> をもう一度見てみよう．
この図で， ECS の管理下にあるクラスターが示されているが，このクラスターの中で計算を行う実体としては二つの選択肢がある．
<strong>EC2 あるいは Fargate</strong> のいずれかである．
EC2 を用いた場合は，先の章で説明したような流れでインスタンスが起動し，計算が実行される．
しかし， EC2 クラスターの作成・管理は技術的な難易度がやや高いので，次章 (<a href="#sec_aws_batch">Section 9</a>) で説明することにする．</p>
</div>
<div class="paragraph">
<p>Fargate とは， <strong>ECS での利用に特化</strong>して設計された，<strong>コンテナを使用した計算タスク</strong>を走らせるための仕組みである．
計算を走らせるという点では EC2 と役割は似ているが， Fargate は EC2 インスタンスのような物理的実体は持たない．
ECS の利用に専用設計がされているがために， ECS のクラスターとして Fargate を選択すると，とても簡単な設定・プログラムで，非常にパワフルかつスケーラブルな計算システムを構築することができる．
(クラスターのスケーリングが容易な分，Fargate にはいくつかの制限が伴う．
例えば GPU を用いた計算は Fargate ではできない．)</p>
</div>
<div class="paragraph">
<p>Fargate では， EC2 と同様に CPU とメモリーのサイズを必要な分だけ指定できる．
執筆時点では， CPU は 0.25 - 4 コア， RAM は 0.5 - 30 GB の間で選択することができる (<a href="https://docs.aws.amazon.com/AmazonECS/latest/developerguide/AWS_Fargate.html">公式ドキュメンテーション参照</a>)．</p>
</div>
<div class="paragraph">
<p>以上が Fargate の概要であったが，くどくど言葉で説明してもなかなかピンとこないだろう．
ここからは実際に手を動かしながら， ECS と Fargate を使った並列タスクの処理の仕方を学んでいこう．</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>厳密には， ECS に付与するクラスターには EC2 と Fargate のハイブリッドを使用することも可能である．</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>"Fargate は EC2 インスタンスのような物理的実体は持たない"，と上に書いたが，少し語弊があるかもしれない．
Fargate も，データセンターのどこかの CPU 上で起動するので，物理的な実体はどこかには必ず存在する．
しかし，EC2 インスタンスと違って，例えば SSH でログインすることは基本的に想定されていないし，なにかのソフトウェアをインストールしたりなどの概念も存在しない (基本的に Docker を介してすべてのプログラムが実行される)．
その意味で "物理的実体を持たない" と表現したのである．
実は， Fargate は <a href="#sec_serverless">Section 11</a> で紹介する， serverless architecture の重要な構成要素の一つである．</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_準備_2">8.2. 準備</h3>
<div class="paragraph">
<p>本ハンズオンの実行には，第一回ハンズオンで説明した準備 (<a href="#handson_01_prep">Section 4.1</a>) が整っていることを前提とする．
それ以外に必要な準備はない．</p>
</div>
</div>
<div class="sect2">
<h3 id="_transformer_を用いた_question_answering_プログラム">8.3. Transformer を用いた question-answering プログラム</h3>
<div class="paragraph">
<p>このハンズオンで開発する，自動質問回答システムをより具体的に定義しよう．
次のような文脈 (context) と質問 (question) が与えられた状況を想定する．</p>
</div>
<div class="listingblock">
<div class="content">
<pre>context: Albert Einstein (14 March 1879 – 18 April 1955) was a German-born theoretical physicist who developed the theory of relativity, one of the two pillars of modern physics (alongside quantum mechanics). His work is also known for its influence on the philosophy of science. He is best known to the general public for his mass–energy equivalence formula E = mc2, which has been dubbed \"the world's most famous equation\". He received the 1921 Nobel Prize in Physics \"for his services to theoretical physics, and especially for his discovery of the law of the photoelectric effect\", a pivotal step in the development of quantum theory.

question: In what year did Einstein win the Nobel prize?</pre>
</div>
</div>
<div class="paragraph">
<p>今回作成する自動回答システムは，このような問題に対して， context に含まれる文字列から正解となる言葉を見つけ出すものとする．
上の問題では，次のような回答を返すべきである．</p>
</div>
<div class="listingblock">
<div class="content">
<pre>answer: 1921</pre>
</div>
</div>
<div class="paragraph">
<p>人間にとっては，このような文章を理解することは容易であるが，コンピュータにそれをやらせることはなかなか難しいことは容易に想像ができるだろう．
しかし，近年の深層学習を使った自然言語処理の進歩は著しく，上で示したような例題などは，極めて高い正答率で回答できるモデルを作ることができる．</p>
</div>
<div class="paragraph">
<p>今回は， <a href="https://github.com/huggingface/transformers">huggingface/transformers</a> で公開されている学習済みの言語モデルを利用することで，上で定義した問題を解く Q&amp;A ボットを作る．
この Q&amp;A ボットは <a href="https://en.wikipedia.org/wiki/Transformer_(machine_learning_model)">Transformer</a>
と呼ばれるモデルを使った自然言語処理に支えられえている (<a href="#transformer_architecture">Figure 42</a>)．
このプログラムを， Docker にパッケージしたものが <a href="https://gitlab.com/tomomano/intro-aws/container_registry/" class="bare">https://gitlab.com/tomomano/intro-aws/container_registry/</a> に <code>handson03</code> という名前で用意してある．
クラウドの設計に入る前に，まずはこのプログラムを単体で動かしてみよう．</p>
</div>
<div class="paragraph">
<p>なお，今回は学習済みのモデルを用いているので，私達が行うのは，与えられた入力をモデルに投げて予測を行う (推論) のみである．
推論の演算は， CPU だけでも十分高速に行うことができるので，コストの削減と，よりシンプルにシステムを設計をする目的で，このハンズオンでは GPU は利用しない．
一般的に， ニューラルネットは学習のほうが圧倒的に計算コストが大きく，そのような場合に GPU はより威力を発揮する．</p>
</div>
<div id="transformer_architecture" class="imageblock text-center">
<div class="content">
<img src="imgs/transformer.png" alt="transformer" width="400">
</div>
<div class="title">Figure 42. Transformer モデルアーキテクチャ (画像出典: <a href="https://arxiv.org/abs/1706.03762">Vaswani+ 2017</a>)</div>
</div>
<div class="paragraph">
<p>次のコマンドで，今回使う Docker image を ローカルにダウンロード (pull) してこよう．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>docker pull registry.gitlab.com/tomomano/intro-aws/handson03:latest</code></pre>
</div>
</div>
<div class="paragraph">
<p>pull できたら，早速この Docker に質問を投げかけてみよう．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ context</span><span class="o">=</span><span class="s2">"Albert Einstein (14 March 1879 – 18 April 1955) was a German-born theoretical physicist who developed the theory of relativity, one of the two pillars of modern physics (alongside quantum mechanics). His work is also known for its influence on the philosophy of science. He is best known to the general public for his mass–energy equivalence formula E = mc2, which has been dubbed </span><span class="se">\"</span><span class="s2">the world's most famous equation</span><span class="se">\"</span><span class="s2">. He received the 1921 Nobel Prize in Physics </span><span class="se">\"</span><span class="s2">for his services to theoretical physics, and especially for his discovery of the law of the photoelectric effect</span><span class="se">\"</span><span class="s2">, a pivotal step in the development of quantum theory."</span>
<span class="nv">$ question</span><span class="o">=</span><span class="s2">"In what year did Einstein win the Nobel prize ?"</span>
<span class="nv">$ </span>docker run registry.gitlab.com/tomomano/intro-aws/handson03:latest <span class="s2">"</span><span class="k">${</span><span class="nv">context</span><span class="k">}</span><span class="s2">"</span> <span class="s2">"</span><span class="k">${</span><span class="nv">question</span><span class="k">}</span><span class="s2">"</span> foo <span class="nt">--no_save</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>今回用意した Docker image は，第一引数に context となる文字列を，第二引数に question に相当する文字列を受けつける．
第三引数，第四引数については，クラウドに展開するときの実装上の都合なので，今は気にしなくてよい．</p>
</div>
<div class="paragraph">
<p>上のコマンドを実行すると，以下のような出力が得られるはずである．</p>
</div>
<div class="listingblock">
<div class="content">
<pre>{'score': 0.9881729286683587, 'start': 437, 'end': 441, 'answer': '1921'}</pre>
</div>
</div>
<div class="paragraph">
<p>"score" は正解の自信度を表す数字で， [0,1] の範囲で与えられる．
"start", "end" は， context 中の何文字目が正解に相当するかを示しており， "answer" が正解と予測された文字列である．</p>
</div>
<div class="paragraph">
<p>1921 年という，正しい答えが返ってきていることに注目してほしい．</p>
</div>
<div class="paragraph">
<p>もう少し難しい質問を投げかけてみよう．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ question</span><span class="o">=</span><span class="s2">"Why did Einstein win the Nobel prize ?"</span>
<span class="nv">$ </span>docker run registry.gitlab.com/tomomano/intro-aws/handson03:latest <span class="s2">"</span><span class="k">${</span><span class="nv">context</span><span class="k">}</span><span class="s2">"</span> <span class="s2">"</span><span class="k">${</span><span class="nv">question</span><span class="k">}</span><span class="s2">"</span> foo <span class="nt">--no_save</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>出力：</p>
</div>
<div class="listingblock">
<div class="content">
<pre>{'score': 0.5235594527494207, 'start': 470, 'end': 506, 'answer': 'his services to theoretical physics,'}</pre>
</div>
</div>
<div class="paragraph">
<p>今度は， score が 0.52 と，少し自信がないようだが，それでも正しい答えにたどりつけていることがわかる．</p>
</div>
<div class="paragraph">
<p>このように， ディープラーニングに支えられた言語モデルを用いることで，なかなかに賢い Q-A ボットを実現できていることがわかる．
以降では，このプログラムをクラウドに展開することで，大量の質問に自動で対応できるようなシステムを設計していく．</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>今回使用する Question &amp; Answering システムには， DistilBERT という Transformer を基にした言語モデルが用いられている．
興味のある読者は， <a href="https://arxiv.org/abs/1910.01108">原著論文</a> を参照してもらいたい．
また， huggingface/transformers の DistilBert についてのドキュメンテーションは <a href="https://huggingface.co/transformers/model_doc/distilbert.html">こちら</a>．</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p><a href="https://github.com/huggingface/transformers">huggingface/transformers</a> には，様々な最新の言語モデルが実装されている．
解けるタスクも， question-answering だけでなく，翻訳や要約など複数用意されている．
興味のある読者は， <a href="https://huggingface.co/transformers/index.html">ドキュメンテーション</a> を参照．</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>今回提供する Docker のソースコードは <a href="https://github.com/tomomano/intro-aws-2021/tree/main/handson/qa-bot/docker" class="bare">https://github.com/tomomano/intro-aws-2021/tree/main/handson/qa-bot/docker</a> にある．</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_アプリケーションの説明_3">8.4. アプリケーションの説明</h3>
<div class="paragraph">
<p>このハンズオンで作成するアプリケーションの概要を <a href="#handson_03_architecture">Figure 43</a> に示す．</p>
</div>
<div id="handson_03_architecture" class="imageblock text-center">
<div class="content">
<img src="imgs/handson-03/handson-03-architecture.png" alt="hands-on 03 architecture" width="600">
</div>
<div class="title">Figure 43. ハンズオン#3で作製するアプリケーションのアーキテクチャ</div>
</div>
<div class="paragraph">
<p>簡単にまとめると，以下のような設計である．</p>
</div>
<div class="ulist">
<ul>
<li>
<p>クライアントは，質問を AWS 上のアプリケーションに送信する．</p>
</li>
<li>
<p>質問のタスクは ECS によって処理される．</p>
</li>
<li>
<p>ECS は， GitLab container registry から， Docker image をダウンロードする．</p>
</li>
<li>
<p>次に，ECS はクラスター内に新たな仮想インスタンスを立ち上げ，ダウンロードされた Docker image をこの新規インスタンスに配置する．</p>
<div class="ulist">
<ul>
<li>
<p>このとき，ひとつの質問に対し一つの仮想インスタンスを立ち上げることで，複数の質問を並列的に処理できるようにする．</p>
</li>
</ul>
</div>
</li>
<li>
<p>ジョブが実行される．</p>
</li>
<li>
<p>ジョブの実行結果 (質問への回答) は， データベース (DynamoDB) に書き込まれる．</p>
</li>
<li>
<p>最後に，クライアントは DynamoDB から質問への回答を読み取る．</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>それでは，プログラムのソースコードを見てみよう (<a href="https://gitlab.com/tomomano/intro-aws/-/tree/master/handson/03-qa-bot/app.py">/handson/03-qa-bot/app.py</a>)．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="python"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
</pre></td><td class="code"><pre><span class="k">class</span> <span class="nc">EcsClusterQaBot</span><span class="p">(</span><span class="n">core</span><span class="o">.</span><span class="n">Stack</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scope</span><span class="p">:</span> <span class="n">core</span><span class="o">.</span><span class="n">App</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">scope</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <i class="conum" data-value="1"></i><b>(1)</b>
        <span class="c1"># dynamoDB table to store questions and answers
</span>        <span class="n">table</span> <span class="o">=</span> <span class="n">dynamodb</span><span class="o">.</span><span class="n">Table</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="s">"EcsClusterQaBot-Table"</span><span class="p">,</span>
            <span class="n">partition_key</span><span class="o">=</span><span class="n">dynamodb</span><span class="o">.</span><span class="n">Attribute</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="s">"item_id"</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">dynamodb</span><span class="o">.</span><span class="n">AttributeType</span><span class="o">.</span><span class="n">STRING</span>
            <span class="p">),</span>
            <span class="n">billing_mode</span><span class="o">=</span><span class="n">dynamodb</span><span class="o">.</span><span class="n">BillingMode</span><span class="o">.</span><span class="n">PAY_PER_REQUEST</span><span class="p">,</span>
            <span class="n">removal_policy</span><span class="o">=</span><span class="n">core</span><span class="o">.</span><span class="n">RemovalPolicy</span><span class="o">.</span><span class="n">DESTROY</span>
        <span class="p">)</span>

        <i class="conum" data-value="2"></i><b>(2)</b>
        <span class="n">vpc</span> <span class="o">=</span> <span class="n">ec2</span><span class="o">.</span><span class="n">Vpc</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="s">"EcsClusterQaBot-Vpc"</span><span class="p">,</span>
            <span class="n">max_azs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="p">)</span>

        <i class="conum" data-value="3"></i><b>(3)</b>
        <span class="n">cluster</span> <span class="o">=</span> <span class="n">ecs</span><span class="o">.</span><span class="n">Cluster</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="s">"EcsClusterQaBot-Cluster"</span><span class="p">,</span>
            <span class="n">vpc</span><span class="o">=</span><span class="n">vpc</span><span class="p">,</span>
        <span class="p">)</span>

        <i class="conum" data-value="4"></i><b>(4)</b>
        <span class="n">taskdef</span> <span class="o">=</span> <span class="n">ecs</span><span class="o">.</span><span class="n">FargateTaskDefinition</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="s">"EcsClusterQaBot-TaskDef"</span><span class="p">,</span>
            <span class="n">cpu</span><span class="o">=</span><span class="mi">1024</span><span class="p">,</span> <span class="c1"># 1 CPU
</span>            <span class="n">memory_limit_mib</span><span class="o">=</span><span class="mi">4096</span><span class="p">,</span> <span class="c1"># 4GB RAM
</span>        <span class="p">)</span>

        <span class="c1"># grant permissions
</span>        <span class="n">table</span><span class="o">.</span><span class="n">grant_read_write_data</span><span class="p">(</span><span class="n">taskdef</span><span class="o">.</span><span class="n">task_role</span><span class="p">)</span>
        <span class="n">taskdef</span><span class="o">.</span><span class="n">add_to_task_role_policy</span><span class="p">(</span>
            <span class="n">iam</span><span class="o">.</span><span class="n">PolicyStatement</span><span class="p">(</span>
                <span class="n">effect</span><span class="o">=</span><span class="n">iam</span><span class="o">.</span><span class="n">Effect</span><span class="o">.</span><span class="n">ALLOW</span><span class="p">,</span>
                <span class="n">resources</span><span class="o">=</span><span class="p">[</span><span class="s">"*"</span><span class="p">],</span>
                <span class="n">actions</span><span class="o">=</span><span class="p">[</span><span class="s">"ssm:GetParameter"</span><span class="p">]</span>
            <span class="p">)</span>
        <span class="p">)</span>

        <i class="conum" data-value="5"></i><b>(5)</b>
        <span class="n">container</span> <span class="o">=</span> <span class="n">taskdef</span><span class="o">.</span><span class="n">add_container</span><span class="p">(</span>
            <span class="s">"EcsClusterQaBot-Container"</span><span class="p">,</span>
            <span class="n">image</span><span class="o">=</span><span class="n">ecs</span><span class="o">.</span><span class="n">ContainerImage</span><span class="o">.</span><span class="n">from_registry</span><span class="p">(</span>
                <span class="s">"registry.gitlab.com/tomomano/intro-aws/handson03:latest"</span>
            <span class="p">),</span>
        <span class="p">)</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>ここでは，回答の結果を書き込むためのデータベースを用意している． DynamoDB については， Serverless architecture の章で扱うので，今は気にしなくてよい．</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>ここでは，ハンズオン #1, #2 で行ったのと同様に， VPC を定義している．</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>ここで， ECS のクラスター (cluster) を定義している．
クラスターとは，仮想サーバーのプールのことであり，クラスターの中に複数の仮想インスタンスを配置する．</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>ここで，実行するタスクを定義している (task definition)．</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>ここで， タスクの実行で使用する Docker image を定義している．</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="_ecs_と_fargate">8.4.1. ECS と Fargate</h4>
<div class="paragraph">
<p>ECS と Fargate の部分について，コードをくわしく見てみてみよう．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="python"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
</pre></td><td class="code"><pre><span class="n">cluster</span> <span class="o">=</span> <span class="n">ecs</span><span class="o">.</span><span class="n">Cluster</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="s">"EcsClusterQaBot-Cluster"</span><span class="p">,</span>
    <span class="n">vpc</span><span class="o">=</span><span class="n">vpc</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">taskdef</span> <span class="o">=</span> <span class="n">ecs</span><span class="o">.</span><span class="n">FargateTaskDefinition</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="s">"EcsClusterQaBot-TaskDef"</span><span class="p">,</span>
    <span class="n">cpu</span><span class="o">=</span><span class="mi">1024</span><span class="p">,</span> <span class="c1"># 1 CPU
</span>    <span class="n">memory_limit_mib</span><span class="o">=</span><span class="mi">4096</span><span class="p">,</span> <span class="c1"># 4GB RAM
</span><span class="p">)</span>

<span class="n">container</span> <span class="o">=</span> <span class="n">taskdef</span><span class="o">.</span><span class="n">add_container</span><span class="p">(</span>
    <span class="s">"EcsClusterQaBot-Container"</span><span class="p">,</span>
    <span class="n">image</span><span class="o">=</span><span class="n">ecs</span><span class="o">.</span><span class="n">ContainerImage</span><span class="o">.</span><span class="n">from_registry</span><span class="p">(</span>
        <span class="s">"registry.gitlab.com/tomomano/intro-aws/handson03:latest"</span>
    <span class="p">),</span>
<span class="p">)</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p><code>cluster =</code> の箇所で，空の ECS クラスターを定義している．</p>
</div>
<div class="paragraph">
<p>次に， <code>taskdef=ecs.FargateTaskDefinition</code> の箇所で， Fargate インスタンスを使ったタスクを定義しており，特にここでは 1 CPU, 4GB RAM というマシンスペックを指定している．
また，このようにして定義されたタスクは，デフォルトで1タスクにつき1インスタンスが使用される．</p>
</div>
<div class="paragraph">
<p>最後に， <code>container =</code> の箇所で，タスクの実行でで使用する Docker image を定義している．
ここでは， GitLab container registry に置いてある image をダウンロードしてくるよう指定している．</p>
</div>
<div class="paragraph">
<p>このようにわずか数行のコードであるが，これだけで上で説明したような，タスクのスケジューリングなどが自動で実行される．</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>上のコードで <code>cpu=1024</code> と指定されているのに注目してほしい．
これは CPU ユニットと呼ばれる数で， 以下の換算表に従って仮想CPU (virtual CPU; vCPU) が割り当てられる．
1024 が 1 CPU に相当する．
0.25 や 0.5 vCPU などの数字は，それぞれ実効的に 1/4, 1/2 の CPU 時間が割り当てられることを意味する．
また， CPU ユニットによって使用できるメモリー量も変わってくる．
例えば， 1024 CPU ユニットを選択した場合は， 2 から 8 GB の範囲でのみメモリー量を指定することができる．
最新の情報は <a href="https://docs.aws.amazon.com/AmazonECS/latest/developerguide/AWS_Fargate.html">公式ドキュメンテーション</a> を参照のこと．</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 4. CPU　ユニットと 指定可能なメモリー量の換算表</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">CPU ユニット</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">メモリーの値</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">256 (.25 vCPU)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.5 GB, 1 GB, 2 GB</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">512 (.5 vCPU)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1 GB, 2 GB, 3 GB, 4 GB</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">1024 (1 vCPU)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2 GB, 3 GB, 4 GB, 5 GB, 6 GB, 7 GB, 8 GB</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">2048 (2 vCPU)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Between 4 GB and 16 GB in 1-GB increments</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">4096 (4 vCPU)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Between 8 GB and 30 GB in 1-GB increments</p></td>
</tr>
</tbody>
</table>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_スタックのデプロイ_2">8.5. スタックのデプロイ</h3>
<div class="paragraph">
<p>スタックの中身が理解できたところで，早速スタックをデプロイしてみよう．</p>
</div>
<div class="paragraph">
<p>デプロイの手順は，これまでのハンズオンとほとんど共通である．
SSH によるログインの必要がないので，むしろ単純なくらいである．
ここでは，コマンドのみ列挙する (<code>#</code> で始まる行はコメントである)．
それぞれの意味を忘れてしまった場合は，ハンズオン1, 2に戻って復習していただきたい．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="c"># プロジェクトのディレクトリに移動</span>
<span class="nv">$ </span><span class="nb">cd </span>intro-aws/handson/03-qa-bot

<span class="c"># venv を作成し，依存ライブラリのインストールを行う</span>
<span class="nv">$ </span>python3 <span class="nt">-m</span> venv .env
<span class="nv">$ </span><span class="nb">source</span> .env/bin/activate
<span class="nv">$ </span>pip <span class="nb">install</span> <span class="nt">-r</span> requirements.txt

<span class="c"># AWS の認証情報をセットする</span>
<span class="c"># 自分自身の認証情報に置き換えること！</span>
<span class="nb">export </span><span class="nv">AWS_ACCESS_KEY_ID</span><span class="o">=</span>XXXXXX
<span class="nb">export </span><span class="nv">AWS_SECRET_ACCESS_KEY</span><span class="o">=</span>YYYYYY
<span class="nb">export </span><span class="nv">AWS_DEFAULT_REGION</span><span class="o">=</span>ap-northeast-1

<span class="c"># デプロイを実行</span>
<span class="nv">$ </span>cdk deploy</code></pre>
</div>
</div>
<div class="paragraph">
<p>デプロイのコマンドが無事に実行されれば， <a href="#handson_03_cdk_output">Figure 44</a> のような出力が得られるはずである．</p>
</div>
<div id="handson_03_cdk_output" class="imageblock text-center">
<div class="content">
<img src="imgs/handson-03/cdk_output.png" alt="cdk output" width="700">
</div>
<div class="title">Figure 44. CDKデプロイ実行後の出力</div>
</div>
<div class="paragraph">
<p>AWS コンソールにログインして，デプロイされたスタックを確認してみよう．
コンソールから，ECS のページに行くと <a href="#handson_03_ecs_console">Figure 45</a> のような画面が表示されるはずである．</p>
</div>
<div class="paragraph">
<p>Cluster というのが，先ほど説明したとおり，複数の仮想インスタンスを束ねる一つの単位である．
この時点ではひとつもタスクが走っていないので，タスクの数字はすべて0になっている．
この画面にはまたすぐ戻ってくるので，開いたままにしておこう．</p>
</div>
<div id="handson_03_ecs_console" class="imageblock text-center">
<div class="content">
<img src="imgs/handson-03/ecs_console.png" alt="ecs_console" width="700">
</div>
<div class="title">Figure 45. ECS コンソール画面</div>
</div>
</div>
<div class="sect2">
<h3 id="_タスクの実行">8.6. タスクの実行</h3>
<div class="paragraph">
<p>それでは，早速，質問を実行してみよう．</p>
</div>
<div class="paragraph">
<p>ECS にタスクを投入するのはやや複雑なので，タスクの投入を簡単にするプログラム (<code>run_task.py</code>) を用意した (<a href="https://gitlab.com/tomomano/intro-aws/-/tree/master/handson/03-qa-bot/run_task.py">/handson/03-qa-bot/run_task.py</a>)．</p>
</div>
<div class="paragraph">
<p>次のようなコマンドで，ECSクラスターに新しい質問を投入することができる．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>python run_task.py ask <span class="s2">"A giant peach was flowing in the river. She picked it up and brought it home. Later, a healthy baby was born from the peach. She named the baby Momotaro."</span> <span class="s2">"What is the name of the baby?"</span></code></pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p><code>run_task.py</code> を実行するには， 環境変数によって AWS の認証情報が設定されていることが前提である．</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>"ask" の引数に続き，文脈 (context) と質問を引数として渡している．</p>
</div>
<div class="paragraph">
<p>上のコマンドを実行すると， "Waiting for the task to finish&#8230;&#8203;" と出力が表示され，回答を得るまでしばらく待たされることになる．
この間， AWS では， ECS がタスクを受理し，新しい Fargate のインスタンスを起動し， Docker image をそのインスタンスに配置する，という一連の処理がなされている．
AWS コンソールから，この一連の様子をモニタリングしてみよう．</p>
</div>
<div class="paragraph">
<p>先ほどの ECS コンソール画面にもどり，クラスターの名前をクリックすることで，クラスターの詳細画面を開く．
次に， "Tasks" という名前のタブがあるので，それを開く (<a href="#ecs_task_monitoring">Figure 46</a>)．
すると，実行中のタスクの一覧が表示されるだろう．</p>
</div>
<div id="ecs_task_monitoring" class="imageblock text-center">
<div class="content">
<img src="imgs/handson-03/ecs_task_monitoring.png" alt="ecs_task_monitoring" width="700">
</div>
<div class="title">Figure 46. ECS のタスクの実行状況をモニタリング</div>
</div>
<div class="paragraph">
<p><a href="#ecs_task_monitoring">Figure 46</a> で見て取れるように， "Desired status = RUNNING", "Last status = PENDING" となっていることから，この時点では，タスクを実行するための準備している段階である，ということがわかる．
Fargate のインスタンスを起動し， Docker image を配置するまでおよそ1-2分の時間がかかる．</p>
</div>
<div class="paragraph">
<p>しばらく待つうちに， Status が "RUNNING" に遷移し，計算が始まる．
計算が終わると， Status は "STOPPED" に遷移し， ECS によって Fargate インスタンスは自動的にシャットダウンされる．</p>
</div>
<div class="paragraph">
<p><a href="#ecs_task_monitoring">Figure 46</a> の画面から， "Task" の列にあるタスクIDクリックすることで，タスクの詳細画面を開いてみよう (<a href="#ecs_task_detail">Figure 47</a>)．
"Launch type = FARGATE", "Last status = STOPPED" など，タスクの情報が表示されている．
また， "Logs" のタブを開くことで， container の吐き出した実行ログを閲覧することができる．</p>
</div>
<div id="ecs_task_detail" class="imageblock text-center">
<div class="content">
<img src="imgs/handson-03/ecs_task_detail.png" alt="ecs_task_detail" width="700">
</div>
<div class="title">Figure 47. 質問タスクの実行結果</div>
</div>
<div class="paragraph">
<p>さて， <code>run_task.py</code> を実行したコマンドラインに戻ってきてみると， <a href="#ask_question_output">Figure 48</a> のような出力が得られているはずである．
"Momotaro" という正しい回答が返ってきている！</p>
</div>
<div id="ask_question_output" class="imageblock text-center">
<div class="content">
<img src="imgs/handson-03/ask_question_output.png" alt="ask_question_output" width="700">
</div>
<div class="title">Figure 48. 質問タスクの実行結果</div>
</div>
</div>
<div class="sect2">
<h3 id="_タスクの同時実行">8.7. タスクの同時実行</h3>
<div class="paragraph">
<p>さて，先ほどはたった一つの質問を投入したわけだが，今回設計したアプリケーションは， ECS と Fargate を使うことで同時にたくさんの質問を処理することができる．
実際に，たくさんの質問を一度に投入してみよう．</p>
</div>
<div class="paragraph">
<p><code>run_task.py</code> に <code>ask_many</code> というオプションを付けることで，複数の質問を一度に送信できる．
質問の内容は <a href="https://gitlab.com/tomomano/intro-aws/-/tree/master/handson/03-qa-bot/problems.json">/handson/03-qa-bot/problems.json</a> に定義されている．</p>
</div>
<div class="paragraph">
<p>次のようなコマンドを実行しよう．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>python run_task.py ask_many</code></pre>
</div>
</div>
<div class="paragraph">
<p>このコマンドを実行した後で，先ほどの ECS コンソールに行き，タスクの一覧を見てみよう (<a href="#ecs_many_tasks">Figure 49</a>)．
複数の Fargate インスタンスが起動され，タスクが並列に実行されているのがわかる．</p>
</div>
<div id="ecs_many_tasks" class="imageblock text-center">
<div class="content">
<img src="imgs/handson-03/ecs_many_tasks.png" alt="ecs_many_tasks" width="700">
</div>
<div class="title">Figure 49. 複数の質問タスクを同時に投入する</div>
</div>
<div class="paragraph">
<p>すべてのタスクのステータスが "STOPPED" になったことを確認した上で，質問への回答を取得しよう．
それには，次のコマンドを実行すれば良い．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>python run_task.py list_answers</code></pre>
</div>
</div>
<div class="paragraph">
<p>結果として， <a href="#ask_many_output">Figure 50</a> のような出力が得られるだろう．
それなりに複雑な文章問題に対し，高い正答率で回答できていることがわかるだろう．</p>
</div>
<div id="ask_many_output" class="imageblock text-center">
<div class="content">
<img src="imgs/handson-03/ask_many_output.png" alt="ask_many_output" width="700">
</div>
<div class="title">Figure 50. <code>$ python run_task.py list_answers</code> の実行結果</div>
</div>
<div class="paragraph">
<p>おめでとう！
ここまでついてこれた読者は，とても初歩的ながらも，ディープラーニングによる言語モデルを使って自動で質問への回答を生成するシステムを創り上げることができた！
それも，数百の質問にも同時に対応できるような，とても高いスケーラビリティーを持ったシステムである！</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p><code>run_task.py</code> で質問を投入し続けると，回答を記録しているデータベースにどんどんエントリーが溜まっていく．
これらのエントリーをすべて消去するには，次のコマンドを使う．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>python run_task.py clear</code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_スタックの削除_2">8.8. スタックの削除</h3>
<div class="paragraph">
<p>これにて，第三回ハンズオンは終了である．最後にスタックを削除しよう．</p>
</div>
<div class="paragraph">
<p>スタックを削除するには，次のコマンドを実行すればよい．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>cdk destroy</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_講義第二回目のまとめ">8.9. 講義第二回目のまとめ</h3>
<div class="paragraph">
<p>ここまでが，第二回目の講義の内容である．第一回に引き続き盛りだくさんの内容であったが，ついてこれたであろうか？</p>
</div>
<div class="paragraph">
<p>第二回では，ディープラーニングの計算をクラウドで実行するため， GPU 搭載型の EC2 インスタンスの起動について解説した．
その際， CUDA や PyTorch などのディープラーニング使うソフトウェアのインストールの手間を省くため， DLAMI を利用した．
さらに，ハンズオン第二回では，クラウドで起動した仮想サーバーを使って， MNIST 文字認識タスクを解くニューラルネットを学習させた．</p>
</div>
<div class="paragraph">
<p>また，より大規模な機械学習アプリケーションを作るための手段として， Docker と ECS による動的に計算リソースが管理されるクラスターの作り方の初歩を説明した．
その応用として，英語で与えられた文章問題への回答を自動で生成するボットをクラウドに展開した．</p>
</div>
<div class="paragraph">
<p>もちろん，この講義で紹介したプログラムはごく初歩的なものなので，現実的な問題を解くためにはプログラムのいろいろな側面を精緻化していく必要がある．
しかしながら，このような技術を応用することでどのようにして現実世界の問題を解くのか，なんとなくイメージが伝わっただろうか？</p>
</div>
<div class="paragraph">
<p>第三回では，さらにレベルアップし， Serverless architecture という最新のクラウドの設計方法について解説する．
その応用として，簡単な SNS サービスをゼロから実装する予定である．
お楽しみに！</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="sec_aws_batch">9. Hands-on #4: AWS Batch を使って機械学習のハイパーパラメータサーチを並列化する</h2>
<div class="sectionbody">
<div class="paragraph">
<p>ハンズオン第三回では， ECS と Fargate を使って自動質問回答システムを構築した．
シンプルながらも，複数の質問が送られた場合には並列にジョブが実行され，ユーザーに答えが返されるシステムを作ることができた．
ここでは，既に学習済みの言語モデルを用いてアプリケーションを構築した．
しかし，機械学習のワークフローでは，まずは自分で作ったモデルを訓練することが最初のステップにあるはずである．
そこで，ハンズオン第四回では，クラウドを用いて機械学習の訓練を並列化・高速化することを考える．</p>
</div>
<div class="paragraph">
<p>具体的には，本ハンズオンでは深層学習におけるハイパーパラメータ最適化を取り上げる．
ハイパーパラメータとは，勾配降下法によって最適化されるニューラルネットのパラメータの外にあるパラメータのことであり，具体的にはモデルの層の幅・深さなどネットワークのアーキテクチャに関わるもの，学習率やモメンタムなどパラメータの更新則に関わるものなどが含まる．
深層学習においてハイパーパラメータの調整はとても重要なタスクである．
しかしながら，ハイパーパラメータを調整するには，少しづつ条件を変えながら何度もニューラルネットを学習させる必要があり，多くの計算時間がかかる．
本ハンズオンでは，クラウドの強力な計算リソースを利用し並列的にニューラルネットの訓練を実行することで，この問題を高速に解く方法を学んでいこう．</p>
</div>
<div class="paragraph">
<p>このハンズオンは，本書で扱うハンズオンの中でも最も難易度が高いものだ (もう少し正確に言うなら，最もステップ数が多い)．
内容が少し難しく感じる読者もいるかもしれないが，頑張ってついてきてほしい．</p>
</div>
<div class="sect2">
<h3 id="_auto_scaling_groups_asg">9.1. Auto scaling groups (ASG)</h3>
<div class="paragraph">
<p>ハンズオンに入っていく前に， <strong>Auto scaling groups (ASG)</strong> と呼ばれる EC2 の概念を知っておく必要がある．</p>
</div>
<div class="paragraph">
<p>ECS の概要を示した <a href="#ecs_overview">Figure 40</a> を振り返って見てほしい．
前章 (<a href="#sec_fargate_qabot">Section 8</a>) でも説明したが， ECS のクラスターで計算を担う実体としては EC2 と Fargate を指定することができる．
Fargate については，前章で記述した．
クラスターで EC2 が選択された場合について，以下に簡単に説明を行っていきたい．</p>
</div>
<div class="paragraph">
<p>EC2 クラスターには <strong>Auto scaling groups (ASG)</strong> と呼ばれるサービスが配置される．
ASG はクラスターのスケーリングを担っており，ASG によって新しいインスタンスの起動や，不要になったインスタンスの停止が実行される．
どのような基準でインスタンスの起動・停止を行うかのルールのことを，<strong>スケーリングポリシー</strong>と呼ぶ．
ASG にはユーザーの指定したスケーリングポリシーを定義することが可能である．
例えば，クラスター全体の稼働率 (負荷) を 80% に維持する，かつ，起動インスタンスの上限は100台とする，などのポリシーを設定できる．
あるいはユーザーの作成したカスタムのプログラムでスケーリングを制御することも可能である．
ECS と ASG が協調することで，フレキシブルかつ効率的なタスクの配置とクラスターのスケーリングが可能になるのである．</p>
</div>
</div>
<div class="sect2">
<h3 id="_aws_batch">9.2. AWS Batch</h3>
<div class="imageblock">
<div class="content">
<img src="imgs/aws_logos/Batch.png" alt="Batch" width="100">
</div>
<div class="title">Figure 51. AWS Batch のロゴ</div>
</div>
<div class="paragraph">
<p>上記で説明したように， ECS と ASG を組み合わせることで，所望の計算クラスターを構築することが可能である．
しかしながら， ECS と ASG にはかなり込み入った設定が必要であり，初心者にとっても経験者にとってもなかなか面倒なプログラミングが要求される．
そこで， ECS と ASG によるクラスターの設計を自動化してくれるサービスが提供されている．
それが <strong>AWS Batch</strong> である．</p>
</div>
<div class="paragraph">
<p>AWS Batch はその名の通りバッチ (Batch) 化されたジョブ (入力データだけが異なる独立した演算が繰り返し実行されること) を想定している．
多くの科学計算や機械学習がバッチ計算に当てはまる．
例えば，初期値のパラメータを変えてシミュレーションを走らせる，といったケースだ．
AWS Batch を用いることの利点は，クラスターのスケーリングやジョブの割り振りはすべて自動で実行され，
ユーザーはクラウドの背後で起こっている詳細を気にすることなく，大量のジョブを投入することのできるシステムが手に入る点である．</p>
</div>
<div class="paragraph">
<p>AWS Batch では，ジョブの投入・管理をスムーズに行うため，次のような概念が定義されている (<a href="#fig_batch_concept">Figure 52</a>)．
まず， <code>Job</code> というのが，AWS Batch によって実行されるひとつひとつの計算の単位である．
<code>Job Definitions</code> とは Job の内容を定義するものであり，これには実行されるべき Docker のイメージのアドレスや，割り当てる CPU・RAM の容量，環境変数などの設定が含まれる．
ユーザーが Job の実行を実行すると， Job は <code>Job Queues</code> に入る．
Job queues とは，実行されるのを待っているジョブの待ち列のことであり，時間的に最も先頭に投入されたジョブが最初に実行される．
また，複数の queue を配置し， queue ごとに priority (優先度) を設定することが可能であり， priority の高い queue に溜まった Job が優先的に実行される．
<code>Compute environment</code> とは，先述したクラスターとほぼ同義の概念であり，計算が実際に実行される場所 (EC2 や Fargate からなるクラスター) を指す．
Compute environment には，使用する EC2 のインスタンスタイプや同時に起動するインスタンス数の上限などの簡易なスケーリングポリシーが指定されている．
Job queues は Compute environment の空き状況を監視しており， それに応じて Job を Compute environment に投下する．</p>
</div>
<div class="paragraph">
<p>以上が AWS Batch を使用する上で理解しておかなければならない概念であるが，くどくど言葉で説明してもなかなかピンとこないだろう．
ここからは，実際に自分で手を動かしながら学んでいこう．</p>
</div>
<div id="fig_batch_concept" class="imageblock text-center">
<div class="content">
<img src="imgs/aws_batch/batch_concepts.png" alt="batch concepts" width="700">
</div>
<div class="title">Figure 52. AWS Batch の主要な概念</div>
</div>
</div>
<div class="sect2">
<h3 id="_準備_3">9.3. 準備</h3>
<div class="paragraph">
<p>本ハンズオンの実行には，第一回ハンズオンで説明した準備 (<a href="#handson_01_prep">Section 4.1</a>) が整っていることを前提とする．
それ以外に必要な準備はない．</p>
</div>
</div>
<div class="sect2">
<h3 id="_mnist_手書き文字認識_再訪">9.4. MNIST 手書き文字認識 (再訪)</h3>
<div class="paragraph">
<p>今回のハンズオンでは，機械学習のハイパーパラメータ調整を取り上げると冒頭で述べた．
その最もシンプルな例題として， <a href="#sec_mnist_using_jupyter">Section 6.8</a> で扱った MNIST 手書き文字認識の問題を再度取り上げよう．
<a href="#sec_mnist_using_jupyter">Section 6.8</a> では，適当にチョイスしたハイパーパラメータを用いてモデルの訓練を行った．
ここで使用したプログラムの中でのハイパーパラメータとしては，確率的勾配降下法 (SGD) における学習率やモメンタムが含まれる．
コードでいうと，以下の行が該当する．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="python"><span class="n">optimizer</span> <span class="o">=</span> <span class="n">optim</span><span class="o">.</span><span class="n">SGD</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">momentum</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>ここで使用された 学習率 (<code>lr=0.01</code>) や モメンタム (<code>momentum=0.5</code>) は恣意的に選択された値であり，これがベストな数値であるのかはわからない．
たまたまこのチョイスが最適であるかもしれないし，もっと高い精度を出すハイパーパラメータの組が存在するかもしれない．
この問題に答えるため，ハイパーパラメータサーチを行おう．
今回は，最もシンプルなアプローチとして，<strong>グリッドサーチ</strong>によるハイパーパラメータサーチを行おう．</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">ハイパーパラメータの最適化について</div>
<div class="paragraph">
<p>機械学習のハイパーパラメータの最適化には大きく３つのアプローチが挙げられる．
グリッドサーチ法，ランダムサーチ法，そしてベイズ最適化による方法である．</p>
</div>
<div class="paragraph">
<p>グリッドサーチ法とは，ハイパーパラメータの組をある範囲の中で可能な組み合わせをすべて計算し，最適なパラメータの組を見出す方法である．
最もシンプルかつ確実な方法であるが，すべての組み合わせの可能性を愚直に計算するので計算コストが大きい．</p>
</div>
<div class="paragraph">
<p>ランダムサーチ法とは，ハイパーパラメータの組をある範囲の中でランダムに抽出し，大量に試行されたランダムな組の中から最適なパラメータの組を見出す方法である．
すべての可能性を網羅的に探索できるわけではないが，調整すべきパラメータの数が多数ある場合に，グリッドサーチよりも効率的に広い探索空間をカバーすることができる．</p>
</div>
<div class="paragraph">
<p>ベイズ最適化を用いた方法では，過去の探索結果から次にどの組み合わせを探索すべきかという指標を計算し，次に探索するパラメータを決定する．
これによりグリッドサーチやランダムサーチよりも少ない試行回数で最適なパラメータにたどり着くことができる．</p>
</div>
<div class="paragraph">
<p>並列化の観点でいうと，グリッドサーチとランダムサーチは各ハイパーパラメータの組の計算は独立に実行することができるため並列化が容易である．
このように独立したジョブとして分割・並列化可能な問題を Embarrassingly parallel な問題と呼ぶ (直訳すると"恥ずかしいほど並列化可能な問題"，ということになる)．
Embarrassingly parallel な問題はクラウドの強力な計算リソースを用いることで，非常なシンプルな実装で解くことができる．
この章ではこのようなタイプの並列計算を取り上げる．</p>
</div>
<div class="paragraph">
<p>一方，ベイズ最適化による方法は，過去の結果をもとに次の探索が決定されるので，並列化はそれほど単純ではない．
最近では <a href="https://optuna.org/">optuna</a> などのハイパーパラメータ探索のためのライブラリが発達しており，ベイズ最適化の数理的な処理を自動で実行してくれるので便利である．
これらのライブラリを使うと，もし一台のコンピュータ (ノード) の中に複数の GPU が存在する場合は，並列に計算を実行することができる．
しかしながら，一台のノードにとどまらず，複数のノードをまたいだ並列化は，高度なプログラミングテクニックが必要とされるだけでなく，ノード間の接続様式などクラウドのアーキテクチャにも深く依存するものである．
本書ではここまで高度なクラウドの使用方法には立ち入らない．</p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="sec_run_mnist_docker_local">9.5. ローカルで Docker を実行</h3>
<div class="paragraph">
<p>まずは，本ハンズオンで使用する Docker image をローカルで計算してみよう．</p>
</div>
<div class="paragraph">
<p>Docker image のソースコードは <a href="https://github.com/tomomano/intro-aws-2021/tree/main/handson/aws-batch/docker">handson/aws-batch/docker</a> にある．
基本的に <a href="#sec_mnist_using_jupyter">Section 6.8</a> のハンズオンを元にし，本ハンズオン専用の軽微な変更が施してある．
興味のある読者はソースコードも含めて読んでいただきたい．</p>
</div>
<div class="paragraph">
<p>次のコマンドで Docker image をローカルに pull してこよう．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>docker pull XXXXXXXXXXXXXX</code></pre>
</div>
</div>
<div class="paragraph">
<p>Pull できたら，次のコマンドでコンテナを起動し，実行する．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>docker run <span class="nt">-it</span> mymnist python3 main.py <span class="nt">--lr</span> 0.1 <span class="nt">--momentum</span> 0.5 <span class="nt">--epochs</span> 100</code></pre>
</div>
</div>
<div class="paragraph">
<p>上記のコマンドを実行すると，指定したハイパーパラメータ (学習率とモメンタム) を使ってニューラルネットの最適化が始まる．
学習を行う最大のエポック数は <code>--epochs</code> パラメータで指定する．
<a href="#sec_jupyter_and_deep_learning">Section 6</a> のハンズオンで見たような， Loss の低下がコマンドライン上に出力されるだろう (<a href="#fig_mnist_log_output">Figure 53</a>)．</p>
</div>
<div id="fig_mnist_log_output" class="imageblock text-center">
<div class="content">
<img src="imgs/aws_batch/mnist_log_output.png" alt="mnist log" width="600">
</div>
<div class="title">Figure 53. Docker を実行した際の出力</div>
</div>
<div class="paragraph">
<p>上に示したコマンドを使うと，計算は CPU を使って実行される．
もし，ローカルの計算機に GPU が備わっており， <a href="https://github.com/NVIDIA/nvidia-docker">nvidia-docker</a> の設定が済んでいるいるならば，
以下のコマンドにより GPU を使って計算を実行することができる．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>docker run <span class="nt">-it</span> <span class="nt">--gpus</span> all mymnist python3 main.py <span class="nt">--lr</span> 0.1 <span class="nt">--momentum</span> 0.5 <span class="nt">--epochs</span> 100</code></pre>
</div>
</div>
<div class="paragraph">
<p>上のコマンドでは，<code>--gpus all</code> というパラメータが加わった．</p>
</div>
<div class="paragraph">
<p>CPU/GPU どちらで実行した場合でも，エポックを重ねるにつれて訓練データ (Train データ) の Loss は単調に減少していくのが見て取れるだろう．
一方，<strong>検証データ (Validation データ) の Loss および Accuracy は，ある程度まで減少した後，それ以上性能が向上しない</strong>ことに気がつくだろう．
これを実際にプロットしてみると <a href="#fig_loss_epoch_profile">Figure 54</a> のようになるはずである．</p>
</div>
<div id="fig_loss_epoch_profile" class="imageblock text-center">
<div class="content">
<img src="imgs/aws_batch/loss_epoch_profile.png" alt="loss epochs" width="600">
</div>
<div class="title">Figure 54. (左) Train/Validation データそれぞれの Loss のエポックごとの変化． (右) Validation データの Accuracy のエポックごとの変化</div>
</div>
<div class="paragraph">
<p>これは<strong>オーバーフィッティング</strong>と呼ばれる現象で，ニューラルネットが訓練データに過度に最適化され，訓練データの外のデータに対しての精度 (汎化性能) が向上していないことを示している．
このような場合の対処法として， <strong>Early stopping</strong> と呼ばれるテクニックが知られている．
Early stopping とは，訓練データの Loss を追跡し，それが減少から増加に転じるエポックで学習をうち止め，そのエポックでのウェイトパラメータを採用する，というものである．
本ハンズオンでも， Early stopping によって訓練の終了を判断し，モデルの性能評価を行っていく．</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>機械学習では基本的な概念であるが，教師あり学習によってモデルを訓練する際に使うデータセットは <strong>訓練 (Train)</strong>，<strong>検証 (Validation)</strong>，<strong>テスト (Test)</strong> データに分割する．
訓練データとは，モデルのウェイトパラメータの最適化に使用されるデータセットである．
検証データとは， Early stopping によって過学習のタイミングを判断したり，ハイパーパラメータの調整を行ったりするのに用いるデータセットである．
最後に，テストデータとは，ハイパーパラメータの調整も済んで最終的に出来上がったモデルの性能を評価するために用いるデータセットである．
論文などで報告するモデルのベンチマークの結果は，基本的にテストデータに対しての性能である．</p>
</div>
<div class="paragraph">
<p>しばしば見かける重大な間違いが，テストデータを使ってハイパーパラメータを調整する，という行為である．
これは絶対に行ってはいけない．
というのは，このやり方だとテストデータに最適にフィットするようなハイパーパラメータが意図的に選択されてしまっているからである．
モデルの性能を正しく評価するには，訓練に一度も使われていないデータを用いなければならない．</p>
</div>
<div class="paragraph">
<p>MNIST 手書き文字データセットでは，訓練データとして 60,000 枚，テストデータとして 10,000 枚の画像が与えられている．
本ハンズオンで使用するコードでは，訓練データのうち 80% の 48,000 枚を訓練データとして使用し，残り 20% の 12,000 枚を検証データとして用いている．
詳しくは，ソースコードを参照のこと．</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_アプリケーションの説明_4">9.6. アプリケーションの説明</h3>
<div class="paragraph">
<p>このハンズオンで作成するアプリケーションの概要を <a href="#fig_batch_architecture">Figure 55</a> に示す．</p>
</div>
<div id="fig_batch_architecture" class="imageblock text-center">
<div class="content">
<img src="imgs/aws_batch/architecture.png" alt="architecture" width="600">
</div>
<div class="title">Figure 55. アプリケーションのアーキテクチャ</div>
</div>
<div class="paragraph">
<p>簡単にまとめると，以下のような設計である．</p>
</div>
<div class="ulist">
<ul>
<li>
<p>クライアントは，あるハイパーパラメータの組を指定して Batch にジョブを提出する</p>
</li>
<li>
<p>Batch はジョブを受け取ると， EC2 からなるクラスターで計算を実行する</p>
</li>
<li>
<p>クラスター内では <code>g4dn.xlarge</code> インスタンスが起動する</p>
</li>
<li>
<p>Docker image は， AWS 内に用意された ECR (Elastic Container Registry) から取得される</p>
</li>
<li>
<p>複数のジョブが投下された場合は，その数だけのインスタンスが起動し並列に実行される．</p>
</li>
<li>
<p>各ジョブによる計算の結果は S3 に保存される</p>
</li>
<li>
<p>最後にクライアントは S3 から結果をダウンロードし，最適なハイパーパラメータの組を決定する</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>それでは，プログラムのソースコードを見てみよう (<a href="https://github.com/tomomano/intro-aws-2021/blob/main/handson/aws-batch/app.py">handson/aws-batch/app.py</a>)．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="python"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
</pre></td><td class="code"><pre>
<span class="k">class</span> <span class="nc">SimpleBatch</span><span class="p">(</span><span class="n">core</span><span class="o">.</span><span class="n">Stack</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scope</span><span class="p">:</span> <span class="n">core</span><span class="o">.</span><span class="n">App</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">scope</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># S3 bucket to store data <i class="conum" data-value="1"></i><b>(1)</b>
</span>        <span class="n">bucket</span> <span class="o">=</span> <span class="n">s3</span><span class="o">.</span><span class="n">Bucket</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="s">"bucket"</span><span class="p">,</span>
            <span class="n">removal_policy</span><span class="o">=</span><span class="n">core</span><span class="o">.</span><span class="n">RemovalPolicy</span><span class="o">.</span><span class="n">DESTROY</span><span class="p">,</span>
            <span class="n">auto_delete_objects</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">vpc</span> <span class="o">=</span> <span class="n">ec2</span><span class="o">.</span><span class="n">Vpc</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="s">"vpc"</span><span class="p">,</span>
            <span class="n">max_azs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">cidr</span><span class="o">=</span><span class="s">"10.10.0.0/23"</span><span class="p">,</span>
            <span class="n">subnet_configuration</span><span class="o">=</span><span class="p">[</span>
                <span class="n">ec2</span><span class="o">.</span><span class="n">SubnetConfiguration</span><span class="p">(</span>
                    <span class="n">name</span><span class="o">=</span><span class="s">"public"</span><span class="p">,</span>
                    <span class="n">subnet_type</span><span class="o">=</span><span class="n">ec2</span><span class="o">.</span><span class="n">SubnetType</span><span class="o">.</span><span class="n">PUBLIC</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">],</span>
            <span class="n">nat_gateways</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="p">)</span>

        <i class="conum" data-value="2"></i><b>(2)</b>
        <span class="n">managed_env</span> <span class="o">=</span> <span class="n">batch</span><span class="o">.</span><span class="n">ComputeEnvironment</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="s">"managed-env"</span><span class="p">,</span>
            <span class="n">compute_resources</span><span class="o">=</span><span class="n">batch</span><span class="o">.</span><span class="n">ComputeResources</span><span class="p">(</span>
                <span class="n">vpc</span><span class="o">=</span><span class="n">vpc</span><span class="p">,</span>
                <span class="n">allocation_strategy</span><span class="o">=</span><span class="n">batch</span><span class="o">.</span><span class="n">AllocationStrategy</span><span class="o">.</span><span class="n">BEST_FIT</span><span class="p">,</span>
                <span class="n">desiredv_cpus</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                <span class="n">maxv_cpus</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span>
                <span class="n">minv_cpus</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                <span class="n">instance_types</span><span class="o">=</span><span class="p">[</span>
                    <span class="n">ec2</span><span class="o">.</span><span class="n">InstanceType</span><span class="p">(</span><span class="s">"g4dn.xlarge"</span><span class="p">)</span>
                <span class="p">],</span>
            <span class="p">),</span>
            <span class="n">managed</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
            <span class="n">compute_environment_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">stack_name</span> <span class="o">+</span> <span class="s">"compute-env"</span>
        <span class="p">)</span>

        <i class="conum" data-value="3"></i><b>(3)</b>
        <span class="n">job_queue</span> <span class="o">=</span> <span class="n">batch</span><span class="o">.</span><span class="n">JobQueue</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="s">"job-queue"</span><span class="p">,</span>
            <span class="n">compute_environments</span><span class="o">=</span><span class="p">[</span>
                <span class="n">batch</span><span class="o">.</span><span class="n">JobQueueComputeEnvironment</span><span class="p">(</span>
                    <span class="n">compute_environment</span><span class="o">=</span><span class="n">managed_env</span><span class="p">,</span>
                    <span class="n">order</span><span class="o">=</span><span class="mi">100</span>
                <span class="p">)</span>
            <span class="p">],</span>
            <span class="n">job_queue_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">stack_name</span> <span class="o">+</span> <span class="s">"job-queue"</span>
        <span class="p">)</span>

        <i class="conum" data-value="4"></i><b>(4)</b>
        <span class="n">job_role</span> <span class="o">=</span> <span class="n">iam</span><span class="o">.</span><span class="n">Role</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="s">"job-role"</span><span class="p">,</span>
            <span class="n">assumed_by</span><span class="o">=</span><span class="n">iam</span><span class="o">.</span><span class="n">CompositePrincipal</span><span class="p">(</span>
                <span class="n">iam</span><span class="o">.</span><span class="n">ServicePrincipal</span><span class="p">(</span><span class="s">"ecs-tasks.amazonaws.com"</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="c1"># allow read and write access to S3 bucket
</span>        <span class="n">bucket</span><span class="o">.</span><span class="n">grant_read_write</span><span class="p">(</span><span class="n">job_role</span><span class="p">)</span>

        <span class="c1"># create a ECR repository to push docker image <i class="conum" data-value="5"></i><b>(5)</b>
</span>        <span class="n">repo</span> <span class="o">=</span> <span class="n">ecr</span><span class="o">.</span><span class="n">Repository</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="s">"repository"</span><span class="p">,</span>
            <span class="n">removal_policy</span><span class="o">=</span><span class="n">core</span><span class="o">.</span><span class="n">RemovalPolicy</span><span class="o">.</span><span class="n">DESTROY</span><span class="p">,</span>
        <span class="p">)</span>

        <i class="conum" data-value="6"></i><b>(6)</b>
        <span class="n">job_def</span> <span class="o">=</span> <span class="n">batch</span><span class="o">.</span><span class="n">JobDefinition</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="s">"job-definition"</span><span class="p">,</span>
            <span class="n">container</span><span class="o">=</span><span class="n">batch</span><span class="o">.</span><span class="n">JobDefinitionContainer</span><span class="p">(</span>
                <span class="n">image</span><span class="o">=</span><span class="n">ecs</span><span class="o">.</span><span class="n">ContainerImage</span><span class="o">.</span><span class="n">from_ecr_repository</span><span class="p">(</span><span class="n">repo</span><span class="p">),</span>
                <span class="n">command</span><span class="o">=</span><span class="p">[</span><span class="s">"python3"</span><span class="p">,</span> <span class="s">"main.py"</span><span class="p">],</span>
                <span class="n">vcpus</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
                <span class="n">gpu_count</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                <span class="n">memory_limit_mib</span><span class="o">=</span><span class="mi">12000</span><span class="p">,</span>
                <span class="n">job_role</span><span class="o">=</span><span class="n">job_role</span><span class="p">,</span>
                <span class="n">environment</span><span class="o">=</span><span class="p">{</span>
                    <span class="s">"BUCKET_NAME"</span><span class="p">:</span> <span class="n">bucket</span><span class="o">.</span><span class="n">bucket_name</span>
                <span class="p">}</span>
            <span class="p">),</span>
            <span class="n">job_definition_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">stack_name</span> <span class="o">+</span> <span class="s">"job-definition"</span><span class="p">,</span>
            <span class="n">timeout</span><span class="o">=</span><span class="n">core</span><span class="o">.</span><span class="n">Duration</span><span class="o">.</span><span class="n">hours</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span>
        <span class="p">)</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>で，計算結果を保存するための S3 バケットを用意している</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>で， Compute environment を定義している．
ここでは <code>g4dn.xlarge</code> のインスタンスタイプを使用するとし，最大の vCPU 使用数は 64 と指定している．</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>で， &lt;2&gt; で作成した Compute environment と紐付いた Job queue を定義している．</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>で， Job が計算結果を S3 に書き込むことができるよう， IAM ロールを定義している．</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>では， Docker image を配置するための ECR を定義している．</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>で Job definition を作成している．
ここでは，4 vCPU， 12000 MB (=12GB) の RAM を使用するように指定している．
また，今後必要となる環境変数 (<code>BUCKET_NAME</code>) を設定している．
さらに， &lt;4&gt; で作った IAM を付与している．</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p><code>g4dn.xlarge</code> は 4 vCPU が割り当てられているので，上のプログラムで最大の vCPU 使用数が 64 だとすると，最大で 16 台のインスタンスが同時に起動することになる．</p>
</div>
<div class="paragraph">
<p>ここで注意が一点ある．
AWS では各アカウントごとに EC2 で起動できるインスタンスの上限が設定されている．
この上限は AWS コンソールにログインし， EC2コンソールの左側メニューバーの <code>Limits</code> をクリックすることで確認できる (<a href="#fig_ec2_limits">Figure 56</a>)．
<code>g4dn.xlarge</code> (EC2 の区分でいうと G ファミリーに属する) の制限を確認するには， <code>Running On-Demand All G instances</code> という名前の項目を見る．
ここにある数字が， AWS によって課されたアカウントの上限であり，この上限を超えたインスタンスを起動することはできない．
もし，自分の用途に対して上限が低すぎる場合は，上限の緩和申請を行うことができる．
詳しくは <a href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-resource-limits.html">公式ドキュメンテーション</a> を参照のこと．</p>
</div>
<div id="fig_ec2_limits" class="imageblock text-center">
<div class="content">
<img src="imgs/aws_batch/ec2_limits.png" alt="EC2 limits" width="700">
</div>
<div class="title">Figure 56. EC2コンソールから各種の上限を確認する</div>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_スタックのデプロイ_3">9.7. スタックのデプロイ</h3>
<div class="paragraph">
<p>スタックの中身が理解できたところで，早速スタックをデプロイしてみよう．</p>
</div>
<div class="paragraph">
<p>デプロイの手順は，これまでのハンズオンとほとんど共通である．
ここでは，コマンドのみ列挙する (# で始まる行はコメントである)．
それぞれの意味を忘れてしまった場合は，前のハンズオンに戻って復習していただきたい．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="c"># プロジェクトのディレクトリに移動</span>
<span class="nv">$ </span><span class="nb">cd </span>handson/aws-batch

<span class="c"># venv を作成し，依存ライブラリのインストールを行う</span>
<span class="nv">$ </span>python3 <span class="nt">-m</span> venv .env
<span class="nv">$ </span><span class="nb">source</span> .env/bin/activate
<span class="nv">$ </span>pip <span class="nb">install</span> <span class="nt">-r</span> requirements.txt

<span class="c"># AWS の認証情報をセットする</span>
<span class="c"># 自分自身の認証情報に置き換えること！</span>
<span class="nb">export </span><span class="nv">AWS_ACCESS_KEY_ID</span><span class="o">=</span>XXXXXX
<span class="nb">export </span><span class="nv">AWS_SECRET_ACCESS_KEY</span><span class="o">=</span>YYYYYY
<span class="nb">export </span><span class="nv">AWS_DEFAULT_REGION</span><span class="o">=</span>ap-northeast-1

<span class="c"># デプロイを実行</span>
<span class="nv">$ </span>cdk deploy</code></pre>
</div>
</div>
<div class="paragraph">
<p>デプロイのコマンドが無事に実行されたことが確認できたら，AWS コンソールにログインして，デプロイされたスタックを確認してみよう．
コンソールの検索バーで <code>batch</code> と入力し， AWS Batch の管理画面を開く (<a href="#fig_batch_console">Figure 57</a>)．</p>
</div>
<div id="fig_batch_console" class="imageblock text-center">
<div class="content">
<img src="imgs/aws_batch/batch_console.png" alt="batch console" width="700">
</div>
<div class="title">Figure 57. AWSBatch のコンソール画面 (ダッシュボード)</div>
</div>
<div class="paragraph">
<p>まず目を向けてほしいのが，画面の一番下にある Compute environment overview の中の <code>SimpleBatchcompute-env</code> という名前の項目だ．
Compute environment とは，先ほど述べたとおり，計算が実行される環境 (クラスターと読み替えても良い) である．
上のプログラムで指定したとおり， <code>g4dn.xlarge</code> が実際に使用されるインスタンスタイプとして表示されている．
また，この時点ではひとつのジョブが走っていないので， <code>desired vCPUs</code> は 0 になっている．</p>
</div>
<div class="paragraph">
<p>次に，Job queue overview にある <code>SimpleBatch-queue</code> という項目に注目してほしい．
ここでは実行待ちのジョブ・実行中のジョブ・実行が完了したジョブを一覧で確認することができる．</p>
</div>
</div>
<div class="sect2">
<h3 id="_docker_image_を_ecr_に配置する">9.8. Docker image を ECR に配置する</h3>
<div class="paragraph">
<p>さて， Batch がジョブを実行するには，どこか指定された場所から Docker image をダウンロード (pull) してくる必要がある．
前回のハンズオン (<a href="#sec_fargate_qabot">Section 8</a>) では，公開設定にしてある GitHub Container Registry から Docker image を pull してきた．
今回のハンズオンでは， AWS から提供されているコンテナ置き場である <strong>ECR (Elastic Container Registry)</strong> に image を配置するという設計を採用する．
Batch は ECR から image を pull してくることで，タスクを実行する (<a href="#fig_batch_architecture">Figure 55</a>)．
ECR を利用する利点は，自分だけがアクセスすることのできるプライベートな image の置き場所を用意できる点である．</p>
</div>
<div class="paragraph">
<p>スタックのソースコードでいうと，以下の箇所が ECR を定義している．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="python"><i class="conum" data-value="1"></i><b>(1)</b>
<span class="n">repo</span> <span class="o">=</span> <span class="n">ecr</span><span class="o">.</span><span class="n">Repository</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="s">"repository"</span><span class="p">,</span>
    <span class="n">removal_policy</span><span class="o">=</span><span class="n">core</span><span class="o">.</span><span class="n">RemovalPolicy</span><span class="o">.</span><span class="n">DESTROY</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">job_def</span> <span class="o">=</span> <span class="n">batch</span><span class="o">.</span><span class="n">JobDefinition</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="s">"job-definition"</span><span class="p">,</span>
    <span class="n">container</span><span class="o">=</span><span class="n">batch</span><span class="o">.</span><span class="n">JobDefinitionContainer</span><span class="p">(</span>
        <span class="n">image</span><span class="o">=</span><span class="n">ecs</span><span class="o">.</span><span class="n">ContainerImage</span><span class="o">.</span><span class="n">from_ecr_repository</span><span class="p">(</span><span class="n">repo</span><span class="p">),</span> <i class="conum" data-value="2"></i><b>(2)</b>
        <span class="o">...</span>
    <span class="p">),</span>
    <span class="o">...</span>
<span class="p">)</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>で，新規の ECR を作成している．</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>で Job definition を定義する中で， image を &lt;1&gt; で作った ECR から取得するように指定している．
同時に， Job definition には ECR へのアクセス権が自動的に付与されることになる．</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>さて，スタックをデプロイした時点では， ECR は空っぽである．
ここに自分のアプリケーションで使う Docker image を push してあげる必要がある．</p>
</div>
<div class="paragraph">
<p>そのために，まずは AWS コンソールから ECR の画面を開こう (検索バーに <code>Elastic Container Registry</code> と入力すると出てくる)．
<code>Private</code> というタブを選択すると， <code>simplebatch-repositoryXXXXXX</code> という名前のレポジトリが見つかるだろう (<a href="#fig_ecr_console1">Figure 58</a>)．</p>
</div>
<div id="fig_ecr_console1" class="imageblock text-center">
<div class="content">
<img src="imgs/aws_batch/ecr_console1.png" alt="ecr console" width="700">
</div>
<div class="title">Figure 58. ECR のコンソール画面</div>
</div>
<div class="paragraph">
<p>次に，このレポジトリの名前をクリックするとレポジトリの詳細画面に遷移する．
そうしたら，画面右上にある <code>View push commands</code> というボタンをクリックする．
すると <a href="#fig_ecr_push_command">Figure 59</a> のようなポップアップ画面が立ち上がる．</p>
</div>
<div id="fig_ecr_push_command" class="imageblock text-center">
<div class="content">
<img src="imgs/aws_batch/ecr_push_command.png" alt="ecr push command" width="700">
</div>
<div class="title">Figure 59. ECR への push コマンド</div>
</div>
<div class="paragraph">
<p>このポップアップ画面で表示されている４つのコマンドを順番に実行していくことで，手元の Docker image を ECR に push することができる．</p>
</div>
<div class="paragraph">
<p>push を実行する前に， AWS の認証情報が設定されていることを確認しよう．
その上で，ハンズオンのソースコードの中にある <code>docker/</code> という名前のディレクトリに移動する．
そうしたら，ポップアップ画面で表示されたコマンドを上から順に実行していく．</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>ポップアップで表示されるコマンドの2つめを見てみると <code>docker build -t XXXXX .</code> となっている．
最後の <code>.</code> が重要で，これは， <em>現在のディレクトリにある Dockerfile を使って image をビルドせよ</em> という意味である．
このような理由で， <code>Dockerfile</code> が置いてあるディレクトリに移動する必要がある．</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>4つめのコマンドには少し時間がかかるかもしれないが，これが完了するとめでたく image が ECR に配置されたことになる．
もう一度 ECR のコンソールを見てみると，確かに image が配置されていることが確認できる (<a href="#fig_ecr_console2">Figure 60</a>)．</p>
</div>
<div class="paragraph">
<p>これで，AWS Batch を使ってジョブを実行させるための最後の準備が完了した．</p>
</div>
<div id="fig_ecr_console2" class="imageblock text-center">
<div class="content">
<img src="imgs/aws_batch/ecr_console2.png" alt="ecr console 2" width="700">
</div>
<div class="title">Figure 60. ECR へ image の配置が完了した</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>今回のハンズオンで紹介するアプリケーションは， Docker image を置き換えることで，ユーザー自身の計算ジョブを実行することが可能である．
興味のある読者は，自分自身の Docker image を ECR に配置し，ジョブを実行してみると良い．</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_job_を実行する_まずはひとつだけ">9.9. Job を実行する (まずはひとつだけ)</h3>
<div class="paragraph">
<p>さて，ここからは実際に AWS Batch にジョブを投入する方法を見ていこう．</p>
</div>
<div class="paragraph">
<p>ハンズオンのディレクトリの <code>notebook/</code> というディレクトリの中に， <code>run_single.ipynb</code> というファイルが見つかるはずである (<code>.ipynb</code> は Jupyter notebook のファイル形式)．
これを Jupyter notebook から開こう．</p>
</div>
<div class="paragraph">
<p>今回のハンズオンでは， <code>venv</code> による仮想環境の中に Jupyter notebook もインストール済みである．
なので，以下のコマンドで Jupyter notebook を立ち上げる．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="c"># .env の仮想環境にいることを確認</span>
<span class="o">(</span>.env<span class="o">)</span> <span class="nv">$ </span><span class="nb">cd </span>notebook
<span class="o">(</span>.env<span class="o">)</span> <span class="nv">$ </span>jupyter notebook</code></pre>
</div>
</div>
<div class="paragraph">
<p>Jupyter notebook が起動したら， <code>run_single.ipynb</code> を開く．</p>
</div>
<div class="paragraph">
<p>最初の [1], [3] 番のセルは，ジョブをサブミットするための関数 (<code>submit_job()</code>) を定義している．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="python"><span class="c1"># [1]
</span><span class="kn">import</span> <span class="nn">boto3</span>
<span class="kn">import</span> <span class="nn">argparse</span>

<span class="c1"># [2]
</span><span class="k">def</span> <span class="nf">submit_job</span><span class="p">(</span><span class="n">lr</span><span class="p">:</span><span class="nb">float</span><span class="p">,</span> <span class="n">momentum</span><span class="p">:</span><span class="nb">float</span><span class="p">,</span> <span class="n">epochs</span><span class="p">:</span><span class="nb">int</span><span class="p">,</span> <span class="n">profile_name</span><span class="o">=</span><span class="s">"default"</span><span class="p">):</span>
    <span class="c1"># 省略...</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><code>submit_job()</code> 関数について簡単に説明しよう．
<a href="#sec_run_mnist_docker_local">Section 9.5</a> で， MNIST を学習する Docker をローカルで実行したとき，以下のようなコマンドを使用した．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>docker run <span class="nt">-it</span> mymnist python3 main.py <span class="nt">--lr</span> 0.1 <span class="nt">--momentum</span> 0.5 <span class="nt">--epochs</span> 100</code></pre>
</div>
</div>
<div class="paragraph">
<p>ここで， <code>python3 main.py --lr 0.1 --momentum 0.5 --epochs 100</code> の部分が， Docker に渡されるコマンドである．</p>
</div>
<div class="paragraph">
<p>AWS Batch でジョブを実行する際も，同じようなコマンドを Docker に渡せば良い．
<code>submit_job()</code> 関数は，このコマンドの文字列を生成し，ジョブに渡している．
コードでは以下の部分が該当する．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="python"><span class="n">containerOverrides</span><span class="o">=</span><span class="p">{</span>
    <span class="s">"command"</span><span class="p">:</span> <span class="p">[</span><span class="s">"python3"</span><span class="p">,</span> <span class="s">"main.py"</span><span class="p">,</span>
                <span class="s">"--lr"</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">lr</span><span class="p">),</span>
                <span class="s">"--momentum"</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">momentum</span><span class="p">),</span>
                <span class="s">"--epochs"</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">epochs</span><span class="p">),</span>
                <span class="s">"--uploadS3"</span><span class="p">,</span> <span class="s">"true"</span><span class="p">]</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>続いて， [4] 番のセルに移ろう．
ここでは，上記の <code>submit_job()</code> 関数を用いて， 学習率 = 0.01, モメンタム = 0.1 を指定したジョブを投入する．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="python"><span class="n">submit_job</span><span class="p">(</span><span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>AWS の認証情報は， Jupyter notebook の内部から再度定義する必要がある．
これを手助けするため， notebook の [2] 番のセル (デフォルトではすべてコメントアウトされている) を用意した．
これを使うにはコメントアウトを解除すればよい．
このセルを実行すると， AWS の認証情報を入力する対話的なプロンプトが表示される．
プロンプトに従って aws secret key などを入力することで， (Jupyter のセッションに固有な) 環境変数に AWS の認証情報が記録される．</p>
</div>
<div class="paragraph">
<p>もう一つの認証方法として， <code>sumit_job()</code> 関数に <code>profile_name</code> というパラメータを用意した．
もし <code>~/.aws/credentials</code> に認証情報が書き込まれているのならば (詳しくは <a href="#aws_cli_install">Section 15.2</a>)， <code>profile_name</code> に使用したいプロファイルの名前を渡すだけで，
認証を行うことができる．</p>
</div>
<div class="paragraph">
<p>慣れている読者は後者のほうが便利であると感じるだろう．</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>[4] 番のセルを実行したら，ジョブが実際に投入されたかどうかを AWS コンソールから確認してみよう．
AWS Batch の管理コンソールを開くと， <a href="#fig_batch_running_job">Figure 61</a> のような画面が表示されるだろう．</p>
</div>
<div id="fig_batch_running_job" class="imageblock text-center">
<div class="content">
<img src="imgs/aws_batch/batch_running_job.png" alt="batch running job" width="700">
</div>
<div class="title">Figure 61. AWS Batch でジョブが実行されている様子</div>
</div>
<div class="paragraph">
<p><a href="#fig_batch_running_job">Figure 61</a> で赤で囲った箇所に注目してほしい．
ひとつのジョブが投入されると，それは <code>SUBMITTED</code> という状態を経て <code>RUNNABLE</code> という状態に遷移する．
<code>RUNNABLE</code> とは， ジョブを実行するためのインスタンスが Compute Environment に不足しているため，新たなインスタンスが起動されるのを待っている状態に相当する．
インスタンスの準備が整うと，ジョブの状態は <code>STARTING</code> を経て <code>RUNNING</code> に至る．</p>
</div>
<div class="paragraph">
<p>次に，ジョブのステータスが <code>RUNNING</code> のときの Compute Environment の <code>Desired vCPU</code> を見てみよう (<a href="#fig_batch_running_job">Figure 61</a> で紫で囲った箇所)．
ここで 4 と表示されているのは， <code>g4dn.xlarge</code> インスタンス一つ分の vCPU の数である．
ジョブの投入に応じて，それを実行するのに最低限必要な EC2 インスタンスが起動されたことが確認できる．
(興味のある人は， EC2 コンソールも同時に覗いてみるとよい)．</p>
</div>
<div class="paragraph">
<p>しばらく経つと，ジョブの状態は <code>RUNNING</code> から <code>SUCCEEDED</code> (あるいは何らかの理由でエラーが発生したときには <code>FAILED</code>) に遷移する．
今回のハンズオンで使っている MNIST の学習はだいたい 10 分くらいで完了するはずである．
ジョブの状態が <code>SUCCEEDED</code> になるまで見届けよう．</p>
</div>
<div class="paragraph">
<p>ジョブが完了すると，学習の結果 (エポックごとの Loss と Accuracy を記録した CSV ファイル) は S3 に保存される．
AWS コンソールからこれを確認しよう．</p>
</div>
<div class="paragraph">
<p>S3 のコンソールに行くと <code>simplebatch-bucketXXXXXXX</code> (XXXX の部分はユーザーによって異なる) という名前のバケットが見つかるはずである．
これをクリックして中身を見てみると， <code>metrics_lr0.0100_m0.1000.csv</code> という名前の CSV があることが確認できるだろう (<a href="#fig_s3_saved_file">Figure 62</a>)．
これが， 学習率 = 0.01, モメンタム = 0.1 として学習を行ったときの結果である．</p>
</div>
<div id="fig_s3_saved_file" class="imageblock text-center">
<div class="content">
<img src="imgs/aws_batch/s3_saved_file.png" alt="s3 saved file" width="700">
</div>
<div class="title">Figure 62. ジョブの実行結果は S3 に保存される</div>
</div>
<div class="paragraph">
<p>さて，ここで <code>run_single.ipynb</code> に戻ってこよう．
[5] から [9] 番のセルでは，学習結果の CSV ファイルをダウンロードしてきて，結果の確認と可視化を行っている．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="python"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
</pre></td><td class="code"><pre><span class="c1"># [5]
</span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="n">pd</span>
<span class="kn">import</span> <span class="nn">io</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>

<span class="c1"># [6]
</span><span class="k">def</span> <span class="nf">read_table_from_s3</span><span class="p">(</span><span class="n">bucket_name</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">profile_name</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">profile_name</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">session</span> <span class="o">=</span> <span class="n">boto3</span><span class="o">.</span><span class="n">Session</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">session</span> <span class="o">=</span> <span class="n">boto3</span><span class="o">.</span><span class="n">Session</span><span class="p">(</span><span class="n">profile_name</span><span class="o">=</span><span class="n">profile_name</span><span class="p">)</span>
    <span class="n">s3</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">resource</span><span class="p">(</span><span class="s">"s3"</span><span class="p">)</span>
    <span class="n">bucket</span> <span class="o">=</span> <span class="n">s3</span><span class="o">.</span><span class="n">Bucket</span><span class="p">(</span><span class="n">bucket_name</span><span class="p">)</span>

    <span class="n">obj</span> <span class="o">=</span> <span class="n">bucket</span><span class="o">.</span><span class="n">Object</span><span class="p">(</span><span class="n">key</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">"Body"</span><span class="p">)</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">df</span>

<span class="c1"># [7]
</span><span class="n">df</span> <span class="o">=</span> <span class="n">read_table_from_s3</span><span class="p">(</span>
    <span class="s">"simplebatch-bucket43879c71-mbqaltx441fu"</span><span class="p">,</span>
    <span class="s">"metrics_lr0.0100_m0.1000.csv"</span>
<span class="p">)</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>[7] を実行する際，最初の引数のバケットの名前を，<strong>自分自身のバケットの名前に置き換える</strong>ことに注意しよう．
(先ほど S3 コンソールから確認した <code>simplebatch-bucketXXXX</code> のことである．)</p>
</div>
<div class="paragraph">
<p>[9] 番のセルで， CSV のデータをプロットしている (<a href="#fig_loss_epoch_profile2">Figure 63</a>)．
ローカルで実行したときと同じように， AWS Batch を用いて MNIST モデルを訓練することに成功した！</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="python"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
</pre></td><td class="code"><pre><span class="n">fig</span><span class="p">,</span> <span class="p">(</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">)</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span>
<span class="n">x</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">df</span><span class="p">[</span><span class="s">"train_loss"</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s">"Train"</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">df</span><span class="p">[</span><span class="s">"val_loss"</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s">"Val"</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">df</span><span class="p">[</span><span class="s">"val_accuracy"</span><span class="p">])</span>

<span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s">"Epochs"</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s">"Loss"</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

<span class="n">ax2</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s">"Epochs"</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s">"Accuracy"</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div id="fig_loss_epoch_profile2" class="imageblock text-center">
<div class="content">
<img src="imgs/aws_batch/loss_epoch_profile2.png" alt="loss_epoch_profile2" width="600">
</div>
<div class="title">Figure 63. AWS Batch で行った MNIST モデルの学習の結果</div>
</div>
</div>
<div class="sect2">
<h3 id="_並列にたくさんの_job_を実行する">9.10. 並列にたくさんの Job を実行する</h3>
<div class="paragraph">
<p>さて，ここからが最後の仕上げである．
ここまでのハンズオンで構築した AWS Batch のシステムを使って，ハイパーパラメータサーチを実際に行おう．</p>
</div>
<div class="paragraph">
<p>先ほど実行した <code>run_single.ipynb</code> と同じディレクトリにある <code>run_sweep.ipynb</code> を開く．</p>
</div>
<div class="paragraph">
<p>セル [1], [2], [3] は <code>run_single.ipynb</code> と同一である．
セル[4] の for ループを使って，グリッド状にハイパーパラメータの組み合わせを用意し， batch にジョブを投入している．</p>
</div>
<div class="paragraph">
<p>セル [4] を実行したら， Batch のコンソールを開こう．
先ほどと同様に，ジョブのステータスは <code>SUBMITTED</code> &gt; <code>RUNNABLE</code> &gt; <code>STARTING</code> &gt; <code>RUNNING</code> と移り変わっていくことがわかるだろう．
最終的に 9 個のジョブがすべて <code>RUNNING</code> の状態になることを確認しよう (<a href="#fig_batch_many_parallel_jobs">Figure 64</a>)．
また，このとき Compute environment の <code>Desired vCPUs</code> は 4x9=36 となっていることを確認しよう (<a href="#fig_batch_many_parallel_jobs">Figure 64</a>)．</p>
</div>
<div id="fig_batch_many_parallel_jobs" class="imageblock text-center">
<div class="content">
<img src="imgs/aws_batch/batch_many_parallel_jobs.png" alt="batch many parallel jobs" width="700">
</div>
<div class="title">Figure 64. 複数のジョブを同時投入したときの Batch コンソール</div>
</div>
<div class="paragraph">
<p>次に，Batch のコンソールの左側のメニューから <code>Jobs</code> をクリックしてみよう．
ここでは，実行中の Job の一覧が確認することができる (<a href="#fig_batch_parallel_job_list">Figure 65</a>)．
Job のステータスでフィルタリングをすることも可能である．
9個のジョブがどれも <code>RUNNING</code> 状態にあることが確認できるだろう．</p>
</div>
<div id="fig_batch_parallel_job_list" class="imageblock text-center">
<div class="content">
<img src="imgs/aws_batch/batch_parallel_job_list.png" alt="batch many parallel jobs" width="700">
</div>
<div class="title">Figure 65. 複数のジョブを同時投入したときの Job 一覧</div>
</div>
<div class="paragraph">
<p>今度は EC2 コンソールを見てみよう．
左のメニューから <code>Instances</code> を選択すると， <a href="#fig_ec2_instances_list">Figure 66</a> に示すような起動中のインスタンスの一覧が表示される．
<code>g4dn.xlarge</code> が 9 台稼働しているのが確認できる．
Batch がジョブの投下に合わせて必要な数のインスタンスを起動してくれたのだ！</p>
</div>
<div id="fig_ec2_instances_list" class="imageblock text-center">
<div class="content">
<img src="imgs/aws_batch/ec2_instances_list.png" alt="ec2 instances list" width="700">
</div>
<div class="title">Figure 66. 複数のジョブを同時投入したときの EC2 インスタンスの一覧</div>
</div>
<div class="paragraph">
<p>ここまで確認できたら，それぞれの Job が終了するまでしばらく待とう (だいたい 15 分くらいで終わる)．
すべてのジョブが終了すると，ダッシュボードの <code>SUCCEEDED</code> が 9 となっているはずだ (&lt;&lt;&gt;&gt;)．
また， Compute environment の <code>Desired vCPUs</code> も 0 に落ちていることを確認しよう．
最後に EC2 コンソールに行って，すべての g4dn インスタンスが停止していることを確認しよう．</p>
</div>
<div class="paragraph">
<p>以上から， AWS Batch を使うことで，ジョブの投入に応じて自動的に EC2 インスタンスが起動され，ジョブの完了とともに直ちにインスタンスの停止が行われる一連の挙動を観察することができた．</p>
</div>
<div class="paragraph">
<p>さて，再び <code>run_sweep.ipynb</code> に戻ってこよう．</p>
</div>
<div class="paragraph">
<p>[5] 以降のセルでは，グリッドサーチの結果を可視化している．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="python"><span class="c1"># [5]
</span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="n">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="kn">import</span> <span class="nn">io</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>

<span class="c1"># [6]
</span><span class="k">def</span> <span class="nf">read_table_from_s3</span><span class="p">(</span><span class="n">bucket_name</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">profile_name</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">profile_name</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">session</span> <span class="o">=</span> <span class="n">boto3</span><span class="o">.</span><span class="n">Session</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">session</span> <span class="o">=</span> <span class="n">boto3</span><span class="o">.</span><span class="n">Session</span><span class="p">(</span><span class="n">profile_name</span><span class="o">=</span><span class="n">profile_name</span><span class="p">)</span>
    <span class="n">s3</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">resource</span><span class="p">(</span><span class="s">"s3"</span><span class="p">)</span>
    <span class="n">bucket</span> <span class="o">=</span> <span class="n">s3</span><span class="o">.</span><span class="n">Bucket</span><span class="p">(</span><span class="n">bucket_name</span><span class="p">)</span>

    <span class="n">obj</span> <span class="o">=</span> <span class="n">bucket</span><span class="o">.</span><span class="n">Object</span><span class="p">(</span><span class="n">key</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">"Body"</span><span class="p">)</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">df</span>

<span class="c1"># [7]
</span><span class="n">grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">lr</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">([</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.001</span><span class="p">]):</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">m</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">([</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">]):</span>
        <span class="n">key</span> <span class="o">=</span> <span class="n">f</span><span class="s">"metrics_lr{lr:0.4f}_m{m:0.4f}.csv"</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">read_table_from_s3</span><span class="p">(</span><span class="s">"simplebatch-bucket43879c71-mbqaltx441fu"</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
        <span class="n">grid</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s">"val_accuracy"</span><span class="p">]</span><span class="o">.</span><span class="nb">max</span><span class="p">()</span>

<span class="c1"># [8]
</span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="s">'equal'</span><span class="p">)</span>

<span class="n">c</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">pcolor</span><span class="p">(</span><span class="n">grid</span><span class="p">,</span> <span class="n">edgecolors</span><span class="o">=</span><span class="s">'w'</span><span class="p">,</span> <span class="n">linewidths</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
        <span class="n">text</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">j</span><span class="o">+</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">f</span><span class="s">"{grid[i, j]:0.1f}"</span><span class="p">,</span>
                       <span class="n">ha</span><span class="o">=</span><span class="s">"center"</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s">"center"</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s">"w"</span><span class="p">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>最終的に出力されるプロットが <a href="#fig_grid_search_result">Figure 67</a> である．</p>
</div>
<div id="fig_grid_search_result" class="imageblock text-center">
<div class="content">
<img src="imgs/aws_batch/grid_search_result.png" alt="grid_search_result" width="400">
</div>
<div class="title">Figure 67. ハイパーパラメータのグリッドサーチの結果</div>
</div>
<div class="paragraph">
<p>このプロットから，差は僅かであるが，学習率が 0.1 のときに精度は最大となることがわかる．
また，学習率 0.1 のときはモメンタムを変えても大きな差は生じないことが見て取れる．</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>今回のパラメータサーチは学習用として極めて単純化されたものである点は承知いただきたい．</p>
</div>
<div class="paragraph">
<p>例えば，今回は学習率が 0.1 が最も良いとされたが，それは訓練のエポックを 100 に限定しているからかもしれない．
学習率が低いとその分訓練に必要なエポック数も多くなる．
訓練のエポック数をもっと増やせばまた違った結果が観察される可能性はある．</p>
</div>
<div class="paragraph">
<p>また，今回は MNIST の訓練データ 60,000 枚のうち， 48,000 枚を訓練データ，残り 12,000 枚を検証データとして用いた．
この分割は乱数を固定してランダムに行ったが，もしこの分割によるデータのバイアスを気にするならば，分割の乱数を変えて複数回モデルの評価を行う (<strong>k-fold cross-validation</strong>) のも，より精緻なアプローチとして考えられる．</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>以上のようにして， CNN を用いた MNIST 分類モデルのハイパーパラメータの最適化の一連の流れを体験した．
今回紹介したスタックは， ECR に置く Docker イメージを入れ替えることで，任意のプログラムを実行することができる．
興味にある読者は，ぜひ自分自身のアプリケーションを実行してもらいたい．</p>
</div>
</div>
<div class="sect2">
<h3 id="_スタックの削除_3">9.11. スタックの削除</h3>
<div class="paragraph">
<p>これにて，本ハンズオンは終了である．最後にスタックを削除しよう．</p>
</div>
<div class="paragraph">
<p>今回のスタックを削除するにあたり，ECR に配置された Docker のイメージは手動で削除されなければならない．
(これをしないと， <code>cdk destroy</code> を実行したときにエラーになってしまう．
これは CloudFormation の仕様なのでどうしようもない)．</p>
</div>
<div class="paragraph">
<p>ECR の Docker image を削除するには， ECR のコンソールに行き，イメージが配置されたレポジトリを開く．
そして，画面右上の <code>DELETE</code> ボタンを押して削除する (<a href="#fig_delete_ecr">Figure 68</a>)．</p>
</div>
<div id="fig_delete_ecr" class="imageblock text-center">
<div class="content">
<img src="imgs/aws_batch/delete_ecr.png" alt="delete_ecr" width="700">
</div>
<div class="title">Figure 68. ECR から Docker image を削除する</div>
</div>
<div class="paragraph">
<p>これが完了したうえで，次のコマンドでスタックを削除する．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>cdk destroy</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_web_サービスの作り方">10. Web サービスの作り方</h2>
<div class="sectionbody">
<div class="paragraph">
<p>ここからが，第三回目の講義の内容になる．</p>
</div>
<div class="paragraph">
<p>これまでの講義では，仮想サーバーをクラウド上に起動し，そこで計算を走らせる方法について解説をしてきた．
最初に，EC2上に個人で使用するためのサーバーを立ち上げ，機械学習の計算を実践した．
第二回の最後では，大規模な機械学習システムのもっとも初歩的なものとして， ECS と Docker を使ったクラスターを作成する方法を解説した．
ここまで紹介したクラウドの計算の利用は，個人的な用途に限られていたが，クラウドの重要な側面のひとつとして，広く一般に使ってもらえるような計算サービス・データベースを提供する，というものが挙げられるだろう．</p>
</div>
<div class="paragraph">
<p>今回の講義は，前回までとは少し方向性を変え，どのようにしてクラウド上にアプリケーションを展開し，広く一般の人に使ってもらうか，という点を講義したいと思う．
講義を通じて，どのように世の中のウェブサービスが出来上がっているのかを知り，さらにどうやって自分でそのようなアプリケーションを作るのか，という点を学んでもらう．
その過程で， Serverless アーキテクチャという最新のクラウド設計手法を解説する．</p>
</div>
<div class="sect2">
<h3 id="_ウェブサービスの仕組みtwitter_を例に">10.1. ウェブサービスの仕組み&#8201;&#8212;&#8201;Twitter を例に</h3>
<div class="paragraph">
<p>あなたがパソコンやスマートフォンから Twitter, Facebook, YouTube などのウェブサービスにアクセスしたとき，
実際にどのようなことが行われ，ページがロードされているのだろうか？</p>
</div>
<div class="paragraph">
<p>ここは知っている人も多いと思うので簡潔な説明にとどめるが， <a href="https://twitter.com">Twitter</a> を具体例として，背後にあるサーバーとクライアントの間の通信を概説しよう．
概念図としては <a href="#web_server">Figure 69</a> のような通信がクライアントとサーバーの間で行われていることになる．</p>
</div>
<div id="web_server" class="imageblock text-center">
<div class="content">
<img src="imgs/web_server.png" alt="web_server" width="700">
</div>
<div class="title">Figure 69. クライアントと Web サーバーの通信の概念図</div>
</div>
<div class="paragraph">
<p>前提として，クライアントとサーバーの通信は <strong>HTTP (Hypertext Transfer Protocol)</strong> を使って行われる．
また，最近では，暗号化された HTTP である <strong>HTTPS</strong> を用いることがスタンダードになってきている．
第一のステップとして，クライアントは HTTP(S) 通信によってサーバーから静的なコンテンツを取得する．
静的なコンテンツとは， <strong>HTML (Hyptertext Markup Language)</strong> で記述されたウェブページの文書本体， <strong>CSS (Cascading Style Sheets)</strong> で記述されたページのデザインやレイアウトファイル，そして <strong>JavaScript (JS)</strong> で記述されたページの動的な挙動を定義したプログラム，が含まれる．
Twitter を含む現代的なウェブアプリケーションの設計では，この静的なファイル群はページの”枠”を定義するだけで，中身となるコンテンツ (e.g. ツイートの一覧) は別途 <strong>API (Application Programming Interface)</strong> によって取得されなければならない．
そこで，クライアントは先ほど取得された JavaScript で定義されたプログラムに従って，サーバーに API を送信し，ツイートや画像データを取得する．
この際，テキストデータのやり取りには <strong>JSON (JavaScript Object Notation)</strong> というフォーマットが用いられることが多い．
画像や動画などのコンテンツも同様にAPIにより取得される．
このようにして取得されたテキストや画像が，HTMLの文書に埋め込まれることで，最終的にユーザーに提示されるページが完成するのである．
また，新しいツイートを投稿するときにも，クライアントから API を通じてサーバーのデータベースにデータが書き込まれる．</p>
</div>
</div>
<div class="sect2">
<h3 id="sec_rest_api">10.2. REST API</h3>
<div class="paragraph">
<p>API (Application Programming Interface) とはこれまで何度も出てきた言葉であるが，ここではよりフォーマルな定義付けを行う．
API とはあるソフトウェア・アプリケーションが，外部のソフトウェアに対しコマンドやデータをやりするための"媒介"の一般的総称である．
とくに，ウェブサービスの文脈では，サーバーが外界に対して提示しているコマンドの一覧のことを意味する．
クライアントは，提示されている API から適切なコマンドを使うことによって，所望のデータを取得したり，あるいはサーバーにデータを送信したりする．</p>
</div>
<div class="paragraph">
<p>特に， <strong>REST (Representational State Transfer)</strong> とよばれる設計思想に基づいた API が現在では最も一般的に使われている．
REST に従った API のことを <strong>REST API</strong> あるいは <strong>RESTful API</strong> と呼んだりする．</p>
</div>
<div class="paragraph">
<p>REST API は， <a href="#rest_api">Figure 70</a> に示したような <strong>Method</strong> と <strong>URI (Universal Resource Identifier)</strong> の組からなる．</p>
</div>
<div id="rest_api" class="imageblock text-center">
<div class="content">
<img src="imgs/rest_api.png" alt="rest_api" width="700">
</div>
<div class="title">Figure 70. REST API</div>
</div>
<div class="paragraph">
<p>Method (メソッド) とは，"どのような操作を行いたいか"を抽象的に表す ("動詞"と捉えてもよい)．
REST API では典型的には <a href="#rest_api_methods">Table 5</a> に示したメソッドが用いられる．</p>
</div>
<div class="paragraph">
<p>一方， URI は，操作が行われる対象 (リソースとも呼ばれる) を表す．
メソッドが動詞であることに対して， URI は"目的語"であると捉えても良い．
<a href="#rest_api">Figure 70</a> の例で言えば， <code>/status/home_timeline</code> というリソース (ホームタイムラインのツイートの一覧) を取得せよ，という意味になる．</p>
</div>
<table id="rest_api_methods" class="tableblock frame-all grid-all stretch">
<caption class="title">Table 5. REST API Methods</caption>
<colgroup>
<col style="width: 25%;">
<col style="width: 75%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">メソッド</th>
<th class="tableblock halign-left valign-top">動作</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">GET</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">要素を取得する</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">POST</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">新しい要素を作成する</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">PUT</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">既存の要素を新しい要素と置き換える</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">PATCH</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">既存の要素の一部を更新する</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">DELETE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">要素を削除する</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>REST API のメソッドには， <a href="#rest_api_methods">Table 5</a> で挙げたもの以外に， HTTP プロトコルで定義されている他のメソッド (OPTIONS, TRACE など) を用いることもできるが，あまり一般的ではない．</p>
</div>
<div class="paragraph">
<p>また，これらのメソッドだけでは動詞として表現し切れないこともあるが，URIのパスなどでより意味を明確にすることもある．
メソッドの使い方も，要素を削除する際は必ず <code>DELETE</code> を使わなければならない，という決まりもなく，例えば， Twitter API でツイートを消す API は <code>POST statuses/destroy/:id</code> で定義されている．</p>
</div>
<div class="paragraph">
<p>最終的には，各ウェブサービスが公開している API ドキュメンテーションを読んで，それぞれの API がどんな操作をするのかをしっかりと調べる必要がある．</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="_twitter_api">10.2.1. Twitter API</h4>
<div class="paragraph">
<p>もう少し具体的にウェブサービスのAPIを体験する目的で，ここでは Twitter のAPIを見てみよう．</p>
</div>
<div class="paragraph">
<p>Twitter が提供している API の一覧は <a href="https://developer.twitter.com/en/docs/api-reference-index">このページ</a> で見ることができる．
いくつかの代表的な API を <a href="#tab_twitter_api">Table 6</a> にまとめた．</p>
</div>
<table id="tab_twitter_api" class="tableblock frame-all grid-all stretch">
<caption class="title">Table 6. Twitter API</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>GET /statuses/home_time_line</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ホームのタイムラインのツイートの一覧を取得する．</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>GET statuses/show/:id</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>:id</code> で指定されたツイートの詳細情報を取得する．</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>POST statuses/update</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">新しいツイートを投稿する．</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>POST statuses/retweet/:id</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>:id</code> で指定されたツイートをリツイートする．</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>POST favorites/create/:id</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>:id</code> で指定されたツイートを"いいね"する．</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>POST statuses/destroy/:id</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>:id</code> で指定されたツイートを削除する．</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Twitter のアプリまたはウェブサイトを開くと，背後では上記のような API が実行され，結果としてGUIのページがレンダリングされている．
また， Twitter 上でボット (bot) を作るときは，開発者がこれらのAPIを自動で呼ぶようなプログラムを記述することで出来上がっている．</p>
</div>
<div class="paragraph">
<p>このように， API はあらゆるウェブサービスを作る上で一番基礎となる要素である．
次からの章では，どのようにしてクラウド上に API を構築していくかを解説しよう．</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="sec_serverless">11. Serverless architecture</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Serverless Architecture あるいは Serverless Computing とは， 従来とは全くアプローチの異なるクラウドシステムの設計方法である．
歴史的には， AWS が2014年に発表した <a href="https://aws.amazon.com/lambda/">Lamba</a> がサーバーレスアーキテクチャの最初の先駆けとされている．
その後， Google や Microsoft などのクラウドプラットフォームも同様の機能の提供を開始している．
サーバーレスアーキテクチャの利点は，スケーラブルなクラウドシステムを安価かつ簡易に作成できる点であり，近年いたるところで導入が進んでいる．</p>
</div>
<div class="paragraph">
<p>Serverless とは，文字通りの意味としてはサーバーなしで計算をするということになるが，それは一体どういう意味だろうか？
サーバーレスについて説明するためには，まずは従来的な， "serverful" と呼ばれるようなシステムについて解説しなければならない．</p>
</div>
<div class="sect2">
<h3 id="chap_serverful_cloud">11.1. Serverful クラウド (従来型)</h3>
<div class="paragraph">
<p>従来的なクラウドシステムのスケッチを <a href="#serverful">Figure 71</a> に示す．
クライアントから送信されたリクエストは，まず最初にAPIサーバーに送られる．
API サーバーでは，リクエストの内容に応じてタスクが実行される．
タスクには，APIサーバーだけで完結できるものもあるが，多くの場合，データベースの読み書きが必要である．
データベースには，データベース専用の独立したサーバーマシンが用いられることが一般的である．
また，画像や動画などもデータは，また別のストレージサーバーに保存されることが一般的である．
これらの APIサーバー，データベースサーバー，ストレージサーバーはそれぞれ独立したサーバーマシンであり， AWS では EC2 を使った仮想インスタンスを想定してもらったら良い．</p>
</div>
<div class="paragraph">
<p>多くのウェブサービスでは，多数のクライアントからのリクエストを処理するため，複数のサーバーマシンがクラウド内で起動し，負荷を分散するような設計がなされている．
クライアントから来たリクエストを計算容量に余裕のあるサーバーに振り分けるような操作を <strong>Load balancing</strong> とよび，そのような操作を担当するマシンのことを <strong>Load balancer</strong> という．</p>
</div>
<div class="paragraph">
<p>Load balancing の目的でたくさんのインスタンスを起動するのはよいのだが，それぞれがなんの計算もせず，ただ新しいタスクが来るのを待っているようではコストと電力の無駄遣いである．
したがって，全てのサーバーが常に目標とする計算負荷を維持するよう，計算の負荷に応じてクラスター内の仮想サーバーの数を動的に増減させるような仕組みが必要である．
そのような仕組みを<strong>クラスターのスケーリング</strong>とよび，負荷の増大に応答して新しい仮想インスタンスをクラスターに追加する操作を <strong>scale-out</strong>，負荷の減少に応答してインスタンスをシャットダウンする操作を <strong>scale-in</strong> と呼ぶ．
クラスターのスケーリングは，各インスタンスを監視・統括するようなひとつ階層が上のサーバーを配置することで自動的に実行されるような設計がなされる．
クラスターのスケーリングは， API サーバーではもちろんのこと，データベースサーバー・ストレージサーバーでも必要になることが多い．
<strong>クラウドシステム内すべてのインスタンスで，負荷が均一になるような調整が必要なのである．</strong></p>
</div>
<div id="serverful" class="imageblock text-center">
<div class="content">
<img src="imgs/serverful.png" alt="serverful" width="700">
</div>
<div class="title">Figure 71. Serverful なクラウドシステム</div>
</div>
</div>
<div class="sect2">
<h3 id="_serverless_クラウドへ">11.2. Serverless クラウドへ</h3>
<div class="paragraph">
<p>上述したように，従来のクラウドシステムの設計で非常に重要なのが，クラスターのスケーリングである．
コストパフォーマンスを最大化するには，各サーバーの稼働率を100%に近づけるようなスケーリングのパラメータの調整が必要である．
しかしながら，クラスターのスケーリングの最適化はかなり手間のかかる作業である．</p>
</div>
<div class="paragraph">
<p>さらに問題を複雑にするのは，APIサーバーで処理されるべきタスクが，非一様である点である．
非一様であるとは，例えばタスクAは3000ミリ秒の実行時間と 512MB のメモリーを消費し，別のタスクBは1000ミリ秒の実行時間と 128MB のメモリーを消費する，というような状況を差している．
一つのサーバーマシンが計算負荷が異なる複数のタスクを処理する場合，クラスターのスケーリングはより複雑になる．
この状況をシンプルにするために，１サーバーで実行するタスクは１種類に限る，という設計も可能であるが，そうするとで生まれる弊害も多い (ほとんど使われないタスクに対してもサーバー一台をまるまる割り当てなければならない = ほとんどアイドリング状態になってしまう，など)．</p>
</div>
<div class="paragraph">
<p>もっとシンプルで見通しの良いクラウドシステムのスケーリングの仕組みはないだろうか？</p>
</div>
<div class="paragraph">
<p>従来の serverful なシステムでの最大の問題点は，<strong>サーバーをまるまる占有してしまう</strong>という点にある．
すなわち， EC2 インスタンスを起動したとき，そのインスタンスは起動したユーザーだけが使えるものであり，<strong>計算のリソース (CPUやRAM) が独占的に割り当てられた状態</strong>になる．
固定した計算資源の割り当てがされてしまっているので，<strong>インスタンスの計算負荷が0%であろうが100%であろうが，均一の使用料金が起動時間に比例</strong>して発生する．</p>
</div>
<div class="paragraph">
<p>サーバーレスアーキテクチャは，このような <strong>独占的に割り当てられた計算リソースというものを完全に廃止する．</strong>
サーバーレスアーキテクチャでは，計算のリソースは，クラウドプロバイダーが全て管理する．
クライアントは，仮想インスタンスを一台まるごと借りるのではなく，<strong>実行したいプログラムをクラウドに提出する</strong>．
クラウドプロバイダーは，自身の持つ巨大な計算リソースから空きを探し，提出されたプログラムを実行し，実行結果をクライアントに返す．
以上を図示すると， <a href="#serverless">Figure 72</a> のようになる．</p>
</div>
<div id="serverless" class="imageblock text-center">
<div class="content">
<img src="imgs/serverless.png" alt="serverless" width="700">
</div>
<div class="title">Figure 72. 従来のクラウドと Serverless クラウドの比較</div>
</div>
<div class="paragraph">
<p>サーバーレスクラウドを利用することで，<strong>クラウドのコストは実際に使用した計算の総量 (CPU稼働時間) で決定される</strong>ことになる．
これは，計算の実行総量に関わらずインスタンスの起動時間で料金が決定されていた従来のシステムと比べて大きな違いである．
一方で，クライアントが同時に大量のタスクを送信した場合でも，クラウドプロバイダー側はその需要に応えることのできるような計算リソースを瞬時に割り当てることができるので，非常に高いスケーラビリティを実現することができる．</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>従来型の(仮想インスタンスをたくさん起動するような)クラウドシステムは，<strong>賃貸</strong>と似ているかもしれない．
部屋を借りるというのは，その部屋でどれだけの時間を過ごそうが，月々の家賃は一定である．
同様に，仮想サーバーも，それがどれほどの計算を行っているかに関わらず，一定の料金が時間ごとに発生する．</p>
</div>
<div class="paragraph">
<p>一方で，サーバーレスクラウドは，<strong>電気・水道・ガス料金</strong> と似ている．
こちらは， (ある程度の基本料金はあるかもしれないが) 実際に使用した分で料金が決定されている．
サーバーレスクラウドも，実際に計算を行った総時間で料金が決まる仕組みになっている．</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_lambda">11.3. Lambda</h3>
<div class="paragraph">
<p><span class="image"><img src="imgs/aws_logos/Lambda.png" alt="Lambda" width="100"></span></p>
</div>
<div class="paragraph">
<p>AWS でサーバーレスコンピューティングの中心を担うのが， <a href="https://aws.amazon.com/lambda/">Lambda</a> である．</p>
</div>
<div class="paragraph">
<p>Lambda の使い方を <a href="#lambda_workflow">Figure 73</a> に図示している．
Lambda の仕組みはシンプルで，まずユーザーは実行したいプログラムを予め登録しておく．
プログラムは， Python, Node.js, ruby などの主要な言語がサポートされている．
そして，プログラムを実行したいときに，そのプログラムを実行 (invoke する)コマンドを Lambda に送信する．
Lambda では， invoke のリクエストを受け取ると直ちに (数ミリセカンドから数百ミリセカンドのレイテンシーで) プログラムの実行を開始する．
そして，実行結果をクライアントやその他の計算機に返す．</p>
</div>
<div id="lambda_workflow" class="imageblock text-center">
<div class="content">
<img src="imgs/lambda_workflow.png" alt="lambda_workflow" width="500">
</div>
<div class="title">Figure 73. AWS Lambda</div>
</div>
<div class="paragraph">
<p>このように，Lambda は仮想インスタンスを専有することはない．
invoke のリクエストが来たときにのみ，動的に起動し，実行の終了とともに速やかにシャットダウンされる．
また，同時に複数のリクエストが来た場合でも， AWS はそれらを実行するための計算リソースを割り当て，並列的に処理を行ってくれる．
原理上は，<strong>数千から数万のリクエストが同時に来たとしても， Lambda はそれらを同時に実行することができる</strong>．
このような，占有された仮想サーバーの存在なしに，動的に関数を実行するサービスを <strong>FaaS (Function as a Service)</strong> と呼ぶ．</p>
</div>
<div class="paragraph">
<p>Lambda では 128MB から 3008MB のメモリーを使用することができる (2020/06時点)．
実行時間は100ミリ秒の単位で記録され，実行時間に比例して料金が決定される．
<a href="#lambda_pricing">Table 7</a> は Lambda の利用料金の利用料金表である．</p>
</div>
<table id="lambda_pricing" class="tableblock frame-all grid-all stretch">
<caption class="title">Table 7. Lambda の料金表</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Memory (MB)</th>
<th class="tableblock halign-left valign-top">Price per 100ms</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">128</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">$0.0000002083</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">512</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">$0.0000008333</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">1024</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">$0.0000016667</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">3008</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">$0.0000048958</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>例えば， 128MB のメモリーを使用する関数を，それぞれ200ミリ秒，合計で100万回実行した場合，
0.0000002083 * 2 * 10^6 = <strong>$0.4</strong> の料金となる．
ウェブサーバーのデータベースの更新など簡単な計算であれば，200ミリ秒程度で実行できる関数も多いことから，100万回データベースの更新を行ったとしても，たった $0.4 しかコストが発生しないことになる．</p>
</div>
</div>
<div class="sect2">
<h3 id="_サーバーレスストレージ_s3">11.4. サーバーレスストレージ: S3</h3>
<div class="paragraph">
<p><span class="image"><img src="imgs/aws_logos/S3.png" alt="S3" width="100"></span></p>
</div>
<div class="paragraph">
<p>サーバーレスの概念は，ストレージにも拡張されている．</p>
</div>
<div class="paragraph">
<p>従来的なストレージ (ファイルシステム) では，必ずホストとなるマシンと OS が存在しなければならない．
従って，それほどパワーは必要ないまでも，ある程度の CPU リソースを割かなければならない．
また，従来的なファイルシステムでは，データ領域のサイズは最初に作成するときに決めなければならず，後から容量を増加させることはしばしば困難である
(ZFS などのファイルシステムを使えばある程度は自由にファイルシステムのサイズを増減できるが)．
よって，従来的なクラウドでは，ストレージを借りるときには予めディスクのサイズを指定せねばならず，ディスクの容量が空であろうと満杯であろうと，同じ利用料金が発生することになる．</p>
</div>
<div class="paragraph">
<p><a href="https://aws.amazon.com/s3/">Simple Storage Service (S3)</a> は，サーバーレスなストレージシステムを提供する．
S3 では，予めデータ保存領域の上限は定められていない．
データを入れれば入れた分だけ，保存領域は拡大していく
(仕様上はペタバイトスケールのデータを保存することが可能である)．
ストレージにかかる料金も，保存してあるデータの総容量で決定される．</p>
</div>
<div class="paragraph">
<p>その他，データの冗長化やバックアップなど，通常ならば CPU が介在しなければならない操作も， API を通じて行うことができる．
これらの観点から， S3 も サーバーレスクラウドの一部として取り扱われることが一般的である．</p>
</div>
<div id="s3_vs_filesystem" class="imageblock text-center">
<div class="content">
<img src="imgs/s3_vs_filesystem.png" alt="s3_vs_filesystem" width="700">
</div>
<div class="title">Figure 74. S3 と従来的なファイルシステムの比較</div>
</div>
<div class="paragraph">
<p>S3 の料金は，保存してあるデータの総容量と，外部へのデータ転送の総量で決定される (<a href="https://aws.amazon.com/s3/pricing/?nc=sn&amp;loc=4">参考</a>)．
執筆時点では，データの保存には $0.025 per GB per month のコストが発生する．
従って，1000GB のデータを S3 に一ヶ月保存した場合， $25 の料金が発生することになる．
また， S3 はデータを外に取り出す際の通信にもコストが発生する．
執筆時点では，S3 からインターネットを通じて外部にデータを転送すると $0.114 per GB のコストが発生する．
データを S3 に入れる (data-in) 通信は無料で行える．
また， AWS の 同じ Region 内のサービス (Lambda など) にデータを転送するのは無料である．
AWS の Region をまたいだデータの転送には， $0.09 per GB のコストが発生する．</p>
</div>
</div>
<div class="sect2">
<h3 id="_サーバーレスデータベース_dynamodb">11.5. サーバーレスデータベース: DynamoDB</h3>
<div class="paragraph">
<p><span class="image"><img src="imgs/aws_logos/DynamoDB.png" alt="S3" width="100"></span></p>
</div>
<div class="paragraph">
<p>サーバーレスの概念は，データベースにも適用することができる．</p>
</div>
<div class="paragraph">
<p>ここでいうデータベースとは， Web サービスなどにおけるユーザー情報を記録しておくための保存領域のことを指している．
従来的に有名なデータベースとしては
<a href="https://www.mysql.com/">MySQL</a>,
<a href="https://www.postgresql.org/">PostgreSQL</a>,
<a href="https://www.mongodb.com/">MongoDB</a>
などが挙げられる．
データベースと普通のストレージの違いは，データの検索機能にある．
普通のストレージではデータは単純にディスクに書き込まれるだけだが，
データベースでは検索がより効率的になるようなデータの配置がされたり，
頻繁にアクセスされるデータはメモリーにキャッシュされるなどの機能が備わっている．
これにより，巨大なデータの中から，興味のある要素を高速に取得することができる．</p>
</div>
<div class="paragraph">
<p>このような検索機能を実現するには，当然 CPU の存在が必須である．
従って，従来的なデータベースを構築する際は，ストレージ領域に加えて，たくさんのCPUを搭載したマシンが用いられることが多い．
また，格納するデータが巨大な場合は複数マシンにまたがった分散型のシステムが設計される．
分散型システムの場合は， <a href="#chap_serverful_cloud">Section 11.1</a> で議論したようにデータベースへのアクセス負荷に応じて適切なスケーリングがなされる必要がある．</p>
</div>
<div class="paragraph">
<p><a href="https://aws.amazon.com/dynamodb/">DynamoDB</a> は，サーバーレスなデータベースである．</p>
</div>
<div class="paragraph">
<p>DynamoDB は分散型のデータベースであるが，データベースのスケーリングは AWS によって行われる．
ユーザーとしては，特になにも考えずに，送りたいだけのリクエストをデータベースに送信すればよい．
データベースへの負荷が増減したときのスケーリングは， DynamoDB が自動で行ってくれる．</p>
</div>
</div>
<div class="sect2">
<h3 id="_その他のサーバーレスクラウドの構成要素">11.6. その他のサーバーレスクラウドの構成要素</h3>
<div class="paragraph">
<p>その他，サーバーレスクラウドを構成するための構成要素を以下にあげる．
API Gateway については，ハンズオン#5 で触れる．</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://aws.amazon.com/api-gateway/">API Gateway</a>: API を構築する際のルーティングを担う．</p>
</li>
<li>
<p><a href="https://aws.amazon.com/fargate/">Fargate</a>: ハンズオン第三回で触れた Fargate も，サーバーレスクラウドの要素の一部である．
Lambda では実行できないような，メモリーや複数CPUを要するような計算などを行うために用いる．</p>
</li>
<li>
<p><a href="https://aws.amazon.com/sns/">Simple Notification Service (SNS)</a>: サーバーレスのサービス間 (Lambda と DynamoDB など) でイベントをやり取りするためのサービス．</p>
</li>
<li>
<p><a href="https://aws.amazon.com/step-functions/">Step Functions</a>: サーバーレスのサービス間のオーケストレーションを担う．</p>
</li>
</ul>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p><strong>サーバーレスアーキテクチャは万能か？</strong></p>
</div>
<div class="paragraph">
<p>この問への答えは，筆者は NO であると考える．</p>
</div>
<div class="paragraph">
<p>ここまで，サーバーレスの利点を強調して説明をしてきたが，まだまだ新しい技術なだけに，欠点，あるいはサーバーフルなシステムに劣る点は，数多くある．</p>
</div>
<div class="paragraph">
<p>ひとつ大きな欠点をあげるとすれば，サーバーレスのシステムは各クラウドプラットフォームに固有なものなので，特定のプラットフォームでしか運用できないシステムになってしまう点であろう．
AWS で作成したサーバーレスのシステムを， Google のクラウドに移植するには，かなり大掛かりなプログラムの書き換えが必要になる．
一方， serverful なシステムであれば，プラットフォーム間のマイグレーションは比較的簡単に行うことができる．
クラウドプロバイダーとしては，自社のシステムへの依存度を強めることで，顧客を離さないようにするという狙いがあるのだろう&#8230;&#8203;</p>
</div>
<div class="paragraph">
<p>その他，サーバーレスコンピューティングの欠点や今後の課題などは，次の論文で詳しく議論されている．
興味のある読者は読んでみると良い．</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://arxiv.org/abs/1812.03651">Hellerstein et al., "Serverless Computing: One Step Forward, Two Steps Back" arXiv (2018)</a></p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_hands_on_4_サーバーレス入門">12. Hands-on #4: サーバーレス入門</h2>
<div class="sectionbody">
<div class="paragraph">
<p>第四回目のハンズオンでは，サーバーレスクラウドを構成する主要な構成要素について，実際に動かしながら学んでもらう．</p>
</div>
<div class="paragraph">
<p>今回のハンズオンで触れるのは以下の3つである．</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Lambda: サーバーレスの計算エンジン</p>
</li>
<li>
<p>DynamoDB: サーバーレス・データベース</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>ハンズオンのソースコードはこちらのリンクに置いてある &#8658; <a href="https://gitlab.com/tomomano/intro-aws/-/tree/master/handson/04-serverless" class="bare">https://gitlab.com/tomomano/intro-aws/-/tree/master/handson/04-serverless</a></p>
</div>
<div class="sect2">
<h3 id="_lambda_ハンズオン">12.1. Lambda ハンズオン</h3>
<div class="paragraph">
<p>ここでは，ショートハンズオンとして，実際に AWS 上に Lambda を使った関数を定義し，計算を実行してみよう．
ここでは， AWS CDK を利用してとてもシンプルな Lambda の関数を作成する．</p>
</div>
<div class="paragraph">
<p>ハンズオンのソースコードはこちらに置いてある &#8658; <a href="https://gitlab.com/tomomano/intro-aws/-/tree/master/handson/04-serverless/lambda" class="bare">https://gitlab.com/tomomano/intro-aws/-/tree/master/handson/04-serverless/lambda</a></p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>このハンズオンは，基本的に <a href="https://aws.amazon.com/free/?all-free-tier.sort-by=item.additionalFields.SortRank&amp;all-free-tier.sort-order=asc">AWS Lambda の無料枠</a> の範囲内で実行することができる．</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><a href="https://gitlab.com/tomomano/intro-aws/-/tree/master/handson/04-serverless/lambda/app.py">app.py</a> にデプロイするプログラムが書かれている．
中身を見てみよう．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="python"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
</pre></td><td class="code"><pre><i class="conum" data-value="1"></i><b>(1)</b>
<span class="n">FUNC</span> <span class="o">=</span> <span class="s">"""
import time
from random import choice, randint
def handler(event, context):
    time.sleep(randint(2,5))
    pokemon = ["Charmander", "Bulbasaur", "Squirtle"]
    message = "Congratulations! You are given " + choice(pokemon)
    print(message)
    return message
"""</span>

<span class="k">class</span> <span class="nc">SimpleLambda</span><span class="p">(</span><span class="n">core</span><span class="o">.</span><span class="n">Stack</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scope</span><span class="p">:</span> <span class="n">core</span><span class="o">.</span><span class="n">App</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">scope</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <i class="conum" data-value="2"></i><b>(2)</b>
        <span class="n">handler</span> <span class="o">=</span> <span class="n">_lambda</span><span class="o">.</span><span class="n">Function</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="s">'LambdaHandler'</span><span class="p">,</span>
            <span class="n">runtime</span><span class="o">=</span><span class="n">_lambda</span><span class="o">.</span><span class="n">Runtime</span><span class="o">.</span><span class="n">PYTHON_3_7</span><span class="p">,</span>
            <span class="n">code</span><span class="o">=</span><span class="n">_lambda</span><span class="o">.</span><span class="n">Code</span><span class="o">.</span><span class="n">from_inline</span><span class="p">(</span><span class="n">FUNC</span><span class="p">),</span>
            <span class="n">handler</span><span class="o">=</span><span class="s">"index.handler"</span><span class="p">,</span>
            <span class="n">memory_size</span><span class="o">=</span><span class="mi">128</span><span class="p">,</span>
            <span class="n">timeout</span><span class="o">=</span><span class="n">core</span><span class="o">.</span><span class="n">Duration</span><span class="o">.</span><span class="n">seconds</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span>
            <span class="n">dead_letter_queue_enabled</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
        <span class="p">)</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>ここで， Lambda で実行されるべき関数を定義している．
これは非常に単純な関数で，2-5秒のランダムな時間スリープした後，["Charmander", "Bulbasaur", "Squirtle"] のいずれかの文字列をランダムに返す (これらは初代ポケットモンスターのゲームでオーキド博士にもらうヒトカゲ・フシギダネ・ゼニガメのことだ)・</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>次に， Lambda の関数の諸々のパラメータを設定している．
それぞれのパラメータの意味は，文字通りの意味なので明瞭であるが，以下に解説する．
<div class="ulist">
<ul>
<li>
<p><code>runtime=_lambda.Runtime.PYTHON_3_7</code>:
ここでは， Python3.7 を使って上記で定義された関数を実行せよ，と指定している．
Python3.7 の他に， Node.js, Java, Ruby, Go などの言語を指定することが可能である．</p>
</li>
<li>
<p><code>code=_lambda.Code.from_inline(FUNC)</code>:
実行されるべき関数が書かれたコードを指定する．
ここでは， <code>FUNC=&#8230;&#8203;</code> で定義した文字列を渡しているが，文字列以外にもファイルのパスを渡すことも可能である．</p>
</li>
<li>
<p><code>handler="index.handler"</code>:
これは，コードの中にいくつかのサブ関数が含まれているときに，メインとサブを区別するためのパラメータである．
<code>handler</code> という名前の関数をメイン関数として実行せよ，という意味である．</p>
</li>
<li>
<p><code>memory_size=128</code>:
メモリーは 128MB を最大で使用することを指定している．
メモリーオーバーした場合は</p>
</li>
<li>
<p><code>timeout=core.Duration.seconds(10)</code>
タイムアウト時間を10秒に設定している．
10秒以内に関数の実行が終了しなかった場合，エラーが返される．</p>
</li>
<li>
<p><code>dead_letter_queue_enabled=True</code>:
アドバンストな設定なので説明は省略する．</p>
</li>
</ul>
</div></td>
</tr>
</table>
</div>
<div class="paragraph">
<p>上記のプログラムを実行することで， Lambda 関数がクラウド上に作成される．
早速デプロイしてみよう．</p>
</div>
<div class="sect3">
<h4 id="_デプロイ">12.1.1. デプロイ</h4>
<div class="paragraph">
<p>デプロイの手順は，これまでのハンズオンとほとんど共通である．
ここでは，コマンドのみ列挙する (<code>#</code> で始まる行はコメントである)．
それぞれの意味を忘れてしまった場合は，ハンズオン1, 2に戻って復習していただきたい．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="c"># プロジェクトのディレクトリに移動</span>
<span class="nv">$ </span><span class="nb">cd </span>intro-aws/handson/04-serverless/lambda

<span class="c"># venv を作成し，依存ライブラリのインストールを行う</span>
<span class="nv">$ </span>python3 <span class="nt">-m</span> venv .env
<span class="nv">$ </span><span class="nb">source</span> .env/bin/activate
<span class="nv">$ </span>pip <span class="nb">install</span> <span class="nt">-r</span> requirements.txt

<span class="c"># AWS の認証情報をセットする</span>
<span class="c"># 自分自身の認証情報に置き換えること！</span>
<span class="nb">export </span><span class="nv">AWS_ACCESS_KEY_ID</span><span class="o">=</span>XXXXXX
<span class="nb">export </span><span class="nv">AWS_SECRET_ACCESS_KEY</span><span class="o">=</span>YYYYYY
<span class="nb">export </span><span class="nv">AWS_DEFAULT_REGION</span><span class="o">=</span>ap-northeast-1

<span class="c"># デプロイを実行</span>
<span class="nv">$ </span>cdk deploy</code></pre>
</div>
</div>
<div class="paragraph">
<p>デプロイのコマンドが無事に実行されれば， <a href="#handson_04_lambda_cdk_output">Figure 75</a> のような出力が得られるはずである．
ここで表示されている <code>SimpleLambda.FunctionName = XXXX</code> の XXXX の文字列は後で使うのでメモしておこう．</p>
</div>
<div id="handson_04_lambda_cdk_output" class="imageblock text-center">
<div class="content">
<img src="imgs/handson-04/handson_04_lambda_cdk_output.png" alt="cdk output" width="700">
</div>
<div class="title">Figure 75. CDKデプロイ実行後の出力</div>
</div>
<div class="paragraph">
<p>AWS コンソールにログインして，デプロイされたスタックを確認してみよう．
コンソールから，Lambda のページに行くと <a href="#handson_04_lambda_console_func_list">Figure 76</a> のような画面から Lambda の関数の一覧が確認できる．</p>
</div>
<div id="handson_04_lambda_console_func_list" class="imageblock text-center">
<div class="content">
<img src="imgs/handson-04/lambda_console_func_list.png" alt="cdk output" width="700">
</div>
<div class="title">Figure 76. Lambda コンソール - 関数の一覧</div>
</div>
<div class="paragraph">
<p>今回のアプリケーションで作成したのが <code>SimpleLambda-YYYY</code> という名前のついた関数だ．
関数の名前をクリックして，詳細を見てみる．
すると <a href="#handson_04_lambda_console_func_detail">Figure 77</a> のような画面が表示されるはずだ．
先ほどプログラムの中で定義したPythonの関数がエディターから確認することができる．
また，下の方にスクロールすると，関数の各種設定も確認することができる．</p>
</div>
<div id="handson_04_lambda_console_func_detail" class="imageblock text-center">
<div class="content">
<img src="imgs/handson-04/lambda_console_func_detail.png" alt="lambda_console_func_detail" width="700">
</div>
<div class="title">Figure 77. Lambda コンソール - 関数の詳細</div>
</div>
</div>
<div class="sect3">
<h4 id="_lambda_関数の実行">12.1.2. Lambda 関数の実行</h4>
<div class="paragraph">
<p>それでは，作成した Lambda 関数を実際に実行 (invoke) してみよう．
AWS の API を使うことで，関数の実行をスタートすることができる．
今回は， <a href="https://gitlab.com/tomomano/intro-aws/-/tree/master/handson/04-serverless/lambda/invoke_one.py">invoke_one.py</a> に関数を実行するための簡単なプログラムを提供している．
興味のある読者はコードを読んでもらいたい．</p>
</div>
<div class="paragraph">
<p>以下のコマンドで，Lambda の関数を実行する．
コマンドの <code>XXXX</code> の部分はは，先ほどデプロイしたときに <code>SimpleLambda.FunctionName = XXXX</code> で得られた XXXX の文字列で置換する．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>python invoke_one.py XXXX</code></pre>
</div>
</div>
<div class="paragraph">
<p>すると， <code>"Congratulations! You are given Squirtle"</code> という出力が得られるはずだ．
とてもシンプルではあるが，クラウド上で先ほどの関数が走り，乱数が生成された上で，ポケモンが選択されて出力が返されている．
上のコマンドを何度か打ってみて，実行のごとに違うポケモンが返されることを確認しよう．</p>
</div>
<div class="paragraph">
<p>さて，上のコマンドは，一度につき一回の関数を実行したわけであるが， Lambda の本領は一度に大量のタスクを同時に実行できる点である．
そこで，今度は一度に100個のタスクを同時に送信してみよう．</p>
</div>
<div class="paragraph">
<p>以下のコマンドを実行する．
XXXX の部分は上と同様に置き換える．
第二引数の <code>100</code> は 100個のタスクを投入せよ，という意味である．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>python invoke_many.py XXXX 100</code></pre>
</div>
</div>
<div class="paragraph">
<p>すると以下のような出力が得られるはずだ．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash">....................................................................................................
Submitted 100 tasks to Lambda!</code></pre>
</div>
</div>
<div class="paragraph">
<p>実際に，100 個のタスクが同時に実行されていることを確認しよう．
<a href="#handson_04_lambda_console_func_detail">Figure 77</a> の画面に戻り， "Monitoring" というタブがあるので，それをクリックする．
すると， <a href="#handson_04_lambda_console_monitoring">Figure 78</a> のようなグラフが表示されるだろう．</p>
</div>
<div id="handson_04_lambda_console_monitoring" class="imageblock text-center">
<div class="content">
<img src="imgs/handson-04/lambda_console_monitoring.png" alt="lambda_console_monitoring" width="700">
</div>
<div class="title">Figure 78. Lambda コンソール - 関数の実行のモニタリング</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p><a href="#handson_04_lambda_console_monitoring">Figure 78</a> のグラフの更新には数分かかることがあるので，なにも表示されない場合は少し待つ．</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><a href="#handson_04_lambda_console_monitoring">Figure 78</a> で "Invocations" が関数が何度実行されたかを意味している．
たしかに100回実行されていることがわかる．
さらに， "Concurrent executions" が何個のタスクが同時に行われたかを示している．
ここでは 96 となっていることから，96個のタスクが並列的に実行されたことを意味している．
(これが，100とならないのは，タスクの開始のコマンドが送られたのが完全には同タイミングではないことに起因する)</p>
</div>
<div class="paragraph">
<p>このように，非常にシンプルではあるが， Lambda を使うことで，同時並列的に処理を実行することのできるクラウドシステムを簡単に作ることができた．</p>
</div>
<div class="paragraph">
<p>もしこのようなことを従来的な serverful なクラウドで行おうとした場合，クラスターのスケーリングなど多くのコードを書くことに加えて，いろいろなパラメータを調節する必要がある．</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>興味がある人は，一気に1000個などのジョブを投入してみると良い．
が，あまりやりすぎると Lambda の無料利用枠を超えて料金が発生してしまうので注意．</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_スタックの削除_4">12.1.3. スタックの削除</h4>
<div class="paragraph">
<p>最後にスタックを削除しよう．</p>
</div>
<div class="paragraph">
<p>スタックを削除するには，次のコマンドを実行すればよい．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>cdk destroy</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_dynamodb_ハンズオン">12.2. DynamoDB ハンズオン</h3>
<div class="paragraph">
<p>ここでは，ショートハンズオンとして，新しい DynamoDB のテーブルを作成する．
そして実際にそこにデータの読み書きを行ってみる．</p>
</div>
<div class="paragraph">
<p>ハンズオンのソースコードはこちらに置いてある &#8658; <a href="https://gitlab.com/tomomano/intro-aws/-/tree/master/handson/04-serverless/dynamodb" class="bare">https://gitlab.com/tomomano/intro-aws/-/tree/master/handson/04-serverless/dynamodb</a></p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>このハンズオンは，基本的に <a href="https://aws.amazon.com/free/?all-free-tier.sort-by=item.additionalFields.SortRank&amp;all-free-tier.sort-order=asc">AWS DynamoDB の無料枠</a> の範囲内で実行することができる．</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><a href="https://gitlab.com/tomomano/intro-aws/-/tree/master/handson/04-serverless/dynamodb/app.py">app.py</a> にデプロイするプログラムが書かれている．
中身を見てみよう．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="python"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
</pre></td><td class="code"><pre><span class="k">class</span> <span class="nc">SimpleDynamoDb</span><span class="p">(</span><span class="n">core</span><span class="o">.</span><span class="n">Stack</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scope</span><span class="p">:</span> <span class="n">core</span><span class="o">.</span><span class="n">App</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">scope</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="n">table</span> <span class="o">=</span> <span class="n">ddb</span><span class="o">.</span><span class="n">Table</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="s">"SimpleTable"</span><span class="p">,</span>
            <span class="n">partition_key</span><span class="o">=</span><span class="n">ddb</span><span class="o">.</span><span class="n">Attribute</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="s">"item_id"</span><span class="p">,</span>
                <span class="nb">type</span><span class="o">=</span><span class="n">ddb</span><span class="o">.</span><span class="n">AttributeType</span><span class="o">.</span><span class="n">STRING</span>
            <span class="p">),</span>
            <span class="n">billing_mode</span><span class="o">=</span><span class="n">ddb</span><span class="o">.</span><span class="n">BillingMode</span><span class="o">.</span><span class="n">PAY_PER_REQUEST</span><span class="p">,</span>
            <span class="n">removal_policy</span><span class="o">=</span><span class="n">core</span><span class="o">.</span><span class="n">RemovalPolicy</span><span class="o">.</span><span class="n">DESTROY</span>
        <span class="p">)</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>以上のコードで，最低限の設定がなされた空の DynamoDB テーブルを作成することができる．
それぞれのパラメータの意味を簡単に解説しよう．</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>partition_key</code>:
全ての DynamoDB テーブルには Partition Key が定義されていなければならない．
Partition key とは，テーブル内のレコードごとに固有のIDのことである．
同一の Partition key を持った要素はテーブルの中に一つしか存在することはできない．
また， Partition key が定義されていない要素はテーブルの中に存在することはできない．
ここでは，Partition key に <code>item_id</code> という名前をつけている．</p>
</li>
<li>
<p><code>billing_mode</code>:
<code>ddb.BillingMode.PAY_PER_REQUEST</code> を基本的に選択しておけばよい</p>
</li>
<li>
<p><code>removal_policy</code>:
省略</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="_デプロイ_2">12.2.1. デプロイ</h4>
<div class="paragraph">
<p>デプロイの手順は，これまでのハンズオンとほとんど共通である．
ここでは，コマンドのみ列挙する (<code>#</code> で始まる行はコメントである)．
それぞれの意味を忘れてしまった場合は，ハンズオン1, 2に戻って復習していただきたい．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="c"># プロジェクトのディレクトリに移動</span>
<span class="nv">$ </span><span class="nb">cd </span>intro-aws/handson/04-serverless/dynamodb

<span class="c"># venv を作成し，依存ライブラリのインストールを行う</span>
<span class="nv">$ </span>python3 <span class="nt">-m</span> venv .env
<span class="nv">$ </span><span class="nb">source</span> .env/bin/activate
<span class="nv">$ </span>pip <span class="nb">install</span> <span class="nt">-r</span> requirements.txt

<span class="c"># AWS の認証情報をセットする</span>
<span class="c"># 自分自身の認証情報に置き換えること！</span>
<span class="nb">export </span><span class="nv">AWS_ACCESS_KEY_ID</span><span class="o">=</span>XXXXXX
<span class="nb">export </span><span class="nv">AWS_SECRET_ACCESS_KEY</span><span class="o">=</span>YYYYYY
<span class="nb">export </span><span class="nv">AWS_DEFAULT_REGION</span><span class="o">=</span>ap-northeast-1

<span class="c"># デプロイを実行</span>
<span class="nv">$ </span>cdk deploy</code></pre>
</div>
</div>
<div class="paragraph">
<p>デプロイのコマンドが無事に実行されれば， <a href="#handson_04_dynamodb_cdk_output">Figure 79</a> のような出力が得られるはずである．
ここで表示されている <code>SimpleDynamoDb.TableName = XXXX</code> の XXXX の文字列は後で使うのでメモしておこう．</p>
</div>
<div id="handson_04_dynamodb_cdk_output" class="imageblock text-center">
<div class="content">
<img src="imgs/handson-04/handson_04_dynamodb_cdk_output.png" alt="cdk output" width="700">
</div>
<div class="title">Figure 79. CDKデプロイ実行後の出力</div>
</div>
<div class="paragraph">
<p>AWS コンソールにログインして，デプロイされたスタックを確認してみよう．
コンソールから， DynamoDB のページに行き，左のメニューバーから "Tables" を選択する．
すると， <a href="#handson_04_dynamodb_table_list">Figure 80</a> のような画面からテーブルの一覧が確認できる．</p>
</div>
<div id="handson_04_dynamodb_table_list" class="imageblock text-center">
<div class="content">
<img src="imgs/handson-04/dynamodb_table_list.png" alt="cdk output" width="700">
</div>
<div class="title">Figure 80. CDKデプロイ実行後の出力</div>
</div>
<div class="paragraph">
<p>今回のアプリケーションで作成したのが SimpleDynamoDb-YYYY という名前のついたテーブルだ．
テーブルの名前をクリックして，詳細を見てみる．
すると <a href="#handson_04_dynamodb_table_detail">Figure 81</a> のような画面が表示されるはずだ．
"Items" のタブをクリックすると，テーブルの中のレコードを確認することができる．
現時点ではなにもデータを書き込んでいないので，空である．</p>
</div>
<div id="handson_04_dynamodb_table_detail" class="imageblock text-center">
<div class="content">
<img src="imgs/handson-04/dynamodb_table_detail.png" alt="cdk output" width="700">
</div>
<div class="title">Figure 81. CDKデプロイ実行後の出力</div>
</div>
</div>
<div class="sect3">
<h4 id="_データの読み書き">12.2.2. データの読み書き</h4>
<div class="paragraph">
<p>それでは，上で作ったテーブルを使ってデータの読み書きを実践してみよう．
ここでは Python と <a href="https://boto3.amazonaws.com/v1/documentation/api/latest/index.html">boto3</a> ライブラリを用いた方法を紹介する．</p>
</div>
<div class="paragraph">
<p>まず最初に， boto3 ライブラリを用意する．
次に，テーブルの名前から <code>Table</code> オブジェクトを作成する．
"XXXX" の部分を自分がデプロイしたテーブルの名前 (<a href="#handson_04_dynamodb_cdk_output">Figure 79</a>) に置き換えた上で，以下のコードを実行しよう．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="python"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno">1
2
3
4
</pre></td><td class="code"><pre><span class="kn">import</span> <span class="nn">boto3</span>
<span class="n">ddb</span> <span class="o">=</span> <span class="n">boto3</span><span class="o">.</span><span class="n">resource</span><span class="p">(</span><span class="s">'dynamodb'</span><span class="p">)</span>

<span class="n">table</span> <span class="o">=</span> <span class="n">ddb</span><span class="o">.</span><span class="n">Table</span><span class="p">(</span><span class="s">"XXXX"</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>新しいデータを書き込むには次のコードを実行する．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="python"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="code"><pre><span class="n">table</span><span class="o">.</span><span class="n">put_item</span><span class="p">(</span>
   <span class="n">Item</span><span class="o">=</span><span class="p">{</span>
       <span class="s">'item_id'</span><span class="p">:</span> <span class="s">'bec7c265-46e2-4065-91d8-80b2e8dcc9c2'</span><span class="p">,</span>
       <span class="s">'first_name'</span><span class="p">:</span> <span class="s">'John'</span><span class="p">,</span>
       <span class="s">'last_name'</span><span class="p">:</span> <span class="s">'Doe'</span><span class="p">,</span>
       <span class="s">'age'</span><span class="p">:</span> <span class="mi">25</span><span class="p">,</span>
    <span class="p">}</span>
<span class="p">)</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>テーブルの中のデータを，そのデータの Partition key を使って読み出すには，次のコードを実行する．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="python"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno">1
2
3
</pre></td><td class="code"><pre><span class="n">table</span><span class="o">.</span><span class="n">get_item</span><span class="p">(</span>
   <span class="n">Key</span><span class="o">=</span><span class="p">{</span><span class="s">"item_id"</span><span class="p">:</span> <span class="s">'bec7c265-46e2-4065-91d8-80b2e8dcc9c2'</span><span class="p">}</span>
<span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">"Item"</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>テーブルの中にあるデータを全て読み出したければ以下のコードを実行する．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="python"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno">1
</pre></td><td class="code"><pre><span class="n">table</span><span class="o">.</span><span class="n">scan</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">"Items"</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_大量のデータの読み書き">12.2.3. 大量のデータの読み書き</h4>
<div class="paragraph">
<p>DynamoDB の利点は，最初に述べた通り，負荷に応じて自在にその処理能力を拡大できる点である．</p>
</div>
<div class="paragraph">
<p>そこで，ここでは一度に大量のデータを書き込む場合をシミュレートしてみよう．
<a href="https://gitlab.com/tomomano/intro-aws/-/tree/master/handson/04-serverless/dynamodb/batch_rw.py">batch_rw.py</a> に，一度に大量の書き込みを実行するためのプログラムが書いてある．</p>
</div>
<div class="paragraph">
<p>次のコマンドを実行してみよう (XXXX は自分のテーブルの名前に置き換える)．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>python batch_rw.py XXXX write 1000</code></pre>
</div>
</div>
<div class="paragraph">
<p>このコマンドを実行することで，ランダムなデータが1000個データベースに書き込まれる．</p>
</div>
<div class="paragraph">
<p>さらに，データベースの検索をかけてみよう．
今回書き込んだデータには <code>age</code> という属性に1から50のランダムな整数が割り当てられている．
<code>age</code> が2以下であるような要素だけを拾ってくるには，以下のコマンドを実行すればよい．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>python batch_rw.py XXXX search_under_age 2</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_hands_on_5_bashoutter">13. Hands-on #5: Bashoutter</h2>
<div class="sectionbody">
<div class="paragraph">
<p>さて，最終回となるハンズオン第五回では，これまで学んできたサーバーレスクラウドの技術を使って，簡単なウェブサービスを作ってみよう．
具体的には，人々が自分の作った俳句を投稿するSNSサービス (<strong>Bashoutter</strong> と名付ける) を作成してみよう．
これまでの講義の集大成として，コードの長さとしては最も長くなっているが，頑張ってついてきてもらいたい．
最終的には， <a href="#handson_05_bashoutter">Figure 82</a> のような，ミニマルではあるがとても現代風な SNS サイトが完成する！</p>
</div>
<div class="paragraph">
<p>ハンズオンのソースコードはこちらのリンクに置いてある &#8658; <a href="https://gitlab.com/tomomano/intro-aws/-/tree/master/handson/05-bashoutter" class="bare">https://gitlab.com/tomomano/intro-aws/-/tree/master/handson/05-bashoutter</a></p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>このハンズオンは，基本的に <a href="https://aws.amazon.com/free/?all-free-tier.sort-by=item.additionalFields.SortRank&amp;all-free-tier.sort-order=asc">AWS の無料枠</a> の範囲内で実行することができる．</p>
</div>
</td>
</tr>
</table>
</div>
<div id="handson_05_bashoutter" class="imageblock text-center">
<div class="content">
<img src="imgs/handson-05/bashoutter.png" alt="bashoutter" width="700">
</div>
<div class="title">Figure 82. ハンズオン#5で作製する SNS アプリケーション "Bashoutter"</div>
</div>
<div class="sect2">
<h3 id="_準備_4">13.1. 準備</h3>
<div class="paragraph">
<p>本ハンズオンの実行には，第一回ハンズオンで説明した準備 (<a href="#handson_01_prep">Section 4.1</a>) が整っていることを前提とする．それ以外に必要な準備はない．</p>
</div>
</div>
<div class="sect2">
<h3 id="_アプリケーションの説明_5">13.2. アプリケーションの説明</h3>
<div class="sect3">
<h4 id="_api">13.2.1. API</h4>
<div class="paragraph">
<p>今回のアプリケーションでは，人々からの俳句の投稿を受け付けたり，投稿された俳句の一覧を取得する，といった機能を実装したい．
そこで， <a href="#tab_handson_05_api">Table 8</a> に示すような４つの API を今回は実装する．</p>
</div>
<table id="tab_handson_05_api" class="tableblock frame-all grid-all stretch">
<caption class="title">Table 8. Hands-on #5 で実装するAPI</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>GET /haiku</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">俳句の一覧を取得する</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>POST /haiku</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">新しい俳句を投稿する</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>PATCH /haiku/{item_id}</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>{item_id}</code> で指定された俳句にお気に入り票を一つ入れる</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>DELETE /haiku/{item_id}</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>{item_id}</code> で指定された俳句を削除する</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>それぞれのAPIのパラメータおよび返り値の詳細は， <a href="https://gitlab.com/tomomano/intro-aws/-/blob/master/handson/05-bashoutter/specs/swagger.yml" class="bare">https://gitlab.com/tomomano/intro-aws/-/blob/master/handson/05-bashoutter/specs/swagger.yml</a> に定義してある．</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p><strong>Open API Specification</strong> (OAS; 少し以前は Swagger Specification と呼ばれていた) は， REST API のための記述フォーマットである．
OAS に従って API の仕様が記述されていると，簡単にドキュメンテーションを生成したり，クライアントアプリケーションを自動生成することができる．
<a href="https://gitlab.com/tomomano/intro-aws/-/blob/master/handson/05-bashoutter/specs/swagger.yml">今回用意したAPI仕様</a> も， OAS に従って書いてあるので，非常に見やすいドキュメンテーションを瞬時に生成することができる．
詳しくは <a href="https://swagger.io/docs/specification/about/">このページ</a> などを参照．</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_アプリケーションアーキテクチャ">13.2.2. アプリケーションアーキテクチャ</h4>
<div class="paragraph">
<p>このハンズオンで作成するアプリケーションの概要を <a href="#handson_05_architecture">Figure 83</a> に示す．</p>
</div>
<div id="handson_05_architecture" class="imageblock text-center">
<div class="content">
<img src="imgs/handson-05/handson-05-architecture.png" alt="hands-on 05 architecture" width="600">
</div>
<div class="title">Figure 83. ハンズオン#5で作製するアプリケーションのアーキテクチャ</div>
</div>
<div class="paragraph">
<p>簡単にまとめると，以下のような設計である．</p>
</div>
<div class="ulist">
<ul>
<li>
<p>クライアントからの API リクエストは， <strong>API Gateway</strong> (後述)にまず送信され， API の URI に従って指定された Lambda 関数へ転送される．</p>
</li>
<li>
<p>それぞれの API のパスごとに独立した Lambda が用意されている．</p>
</li>
<li>
<p>俳句の情報 (作者，俳句本体，投稿日時など) を記録するためのデータベース (DynamoDB) を用意する．</p>
</li>
<li>
<p>各 Lambda 関数には， DynamoDB へのアクセス権を付与する．</p>
</li>
<li>
<p>最後に，ウェブブラウザからコンテンツを表示できるよう， ウェブページの静的コンテンツを配信するための S3 バケットを用意する．クライアントはこの S3 バケットにアクセスすることで HTML/CSS/JS などのコンテンツを取得する．</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>それでは，プログラムのソースコードを見てみよう (<a href="https://gitlab.com/tomomano/intro-aws/-/tree/master/handson/05-bashoutter/app.py">/handson/05-bashoutter/app.py</a>)．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="python"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno">  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
</pre></td><td class="code"><pre><span class="k">class</span> <span class="nc">Bashoutter</span><span class="p">(</span><span class="n">core</span><span class="o">.</span><span class="n">Stack</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scope</span><span class="p">:</span> <span class="n">core</span><span class="o">.</span><span class="n">App</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">scope</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <i class="conum" data-value="1"></i><b>(1)</b>
        <span class="c1"># dynamoDB table to store haiku
</span>        <span class="n">table</span> <span class="o">=</span> <span class="n">ddb</span><span class="o">.</span><span class="n">Table</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="s">"Bashoutter-Table"</span><span class="p">,</span>
            <span class="n">partition_key</span><span class="o">=</span><span class="n">ddb</span><span class="o">.</span><span class="n">Attribute</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="s">"item_id"</span><span class="p">,</span>
                <span class="nb">type</span><span class="o">=</span><span class="n">ddb</span><span class="o">.</span><span class="n">AttributeType</span><span class="o">.</span><span class="n">STRING</span>
            <span class="p">),</span>
            <span class="n">billing_mode</span><span class="o">=</span><span class="n">ddb</span><span class="o">.</span><span class="n">BillingMode</span><span class="o">.</span><span class="n">PAY_PER_REQUEST</span><span class="p">,</span>
            <span class="n">removal_policy</span><span class="o">=</span><span class="n">core</span><span class="o">.</span><span class="n">RemovalPolicy</span><span class="o">.</span><span class="n">DESTROY</span>
        <span class="p">)</span>

        <i class="conum" data-value="2"></i><b>(2)</b>
        <span class="n">bucket</span> <span class="o">=</span> <span class="n">s3</span><span class="o">.</span><span class="n">Bucket</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="s">"Bashoutter-Bucket"</span><span class="p">,</span>
            <span class="n">website_index_document</span><span class="o">=</span><span class="s">"index.html"</span><span class="p">,</span>
            <span class="n">public_read_access</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
            <span class="n">removal_policy</span><span class="o">=</span><span class="n">core</span><span class="o">.</span><span class="n">RemovalPolicy</span><span class="o">.</span><span class="n">DESTROY</span>
        <span class="p">)</span>
        <span class="n">s3_deploy</span><span class="o">.</span><span class="n">BucketDeployment</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="s">"BucketDeployment"</span><span class="p">,</span>
            <span class="n">destination_bucket</span><span class="o">=</span><span class="n">bucket</span><span class="p">,</span>
            <span class="n">sources</span><span class="o">=</span><span class="p">[</span><span class="n">s3_deploy</span><span class="o">.</span><span class="n">Source</span><span class="o">.</span><span class="n">asset</span><span class="p">(</span><span class="s">"./gui/dist"</span><span class="p">)],</span>
            <span class="n">retain_on_delete</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">common_params</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s">"runtime"</span><span class="p">:</span> <span class="n">_lambda</span><span class="o">.</span><span class="n">Runtime</span><span class="o">.</span><span class="n">PYTHON_3_7</span><span class="p">,</span>
            <span class="s">"environment"</span><span class="p">:</span> <span class="p">{</span>
                <span class="s">"TABLE_NAME"</span><span class="p">:</span> <span class="n">table</span><span class="o">.</span><span class="n">table_name</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <i class="conum" data-value="3"></i><b>(3)</b>
        <span class="c1"># define Lambda functions
</span>        <span class="n">get_haiku_lambda</span> <span class="o">=</span> <span class="n">_lambda</span><span class="o">.</span><span class="n">Function</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="s">"GetHaiku"</span><span class="p">,</span>
            <span class="n">code</span><span class="o">=</span><span class="n">_lambda</span><span class="o">.</span><span class="n">Code</span><span class="o">.</span><span class="n">from_asset</span><span class="p">(</span><span class="s">"api"</span><span class="p">),</span>
            <span class="n">handler</span><span class="o">=</span><span class="s">"api.get_haiku"</span><span class="p">,</span>
            <span class="n">memory_size</span><span class="o">=</span><span class="mi">512</span><span class="p">,</span>
            <span class="o">**</span><span class="n">common_params</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">post_haiku_lambda</span> <span class="o">=</span> <span class="n">_lambda</span><span class="o">.</span><span class="n">Function</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="s">"PostHaiku"</span><span class="p">,</span>
            <span class="n">code</span><span class="o">=</span><span class="n">_lambda</span><span class="o">.</span><span class="n">Code</span><span class="o">.</span><span class="n">from_asset</span><span class="p">(</span><span class="s">"api"</span><span class="p">),</span>
            <span class="n">handler</span><span class="o">=</span><span class="s">"api.post_haiku"</span><span class="p">,</span>
            <span class="o">**</span><span class="n">common_params</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">patch_haiku_lambda</span> <span class="o">=</span> <span class="n">_lambda</span><span class="o">.</span><span class="n">Function</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="s">"PatchHaiku"</span><span class="p">,</span>
            <span class="n">code</span><span class="o">=</span><span class="n">_lambda</span><span class="o">.</span><span class="n">Code</span><span class="o">.</span><span class="n">from_asset</span><span class="p">(</span><span class="s">"api"</span><span class="p">),</span>
            <span class="n">handler</span><span class="o">=</span><span class="s">"api.patch_haiku"</span><span class="p">,</span>
            <span class="o">**</span><span class="n">common_params</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">delete_haiku_lambda</span> <span class="o">=</span> <span class="n">_lambda</span><span class="o">.</span><span class="n">Function</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="s">"DeleteHaiku"</span><span class="p">,</span>
            <span class="n">code</span><span class="o">=</span><span class="n">_lambda</span><span class="o">.</span><span class="n">Code</span><span class="o">.</span><span class="n">from_asset</span><span class="p">(</span><span class="s">"api"</span><span class="p">),</span>
            <span class="n">handler</span><span class="o">=</span><span class="s">"api.delete_haiku"</span><span class="p">,</span>
            <span class="o">**</span><span class="n">common_params</span><span class="p">,</span>
        <span class="p">)</span>

        <i class="conum" data-value="4"></i><b>(4)</b>
        <span class="c1"># grant permissions
</span>        <span class="n">table</span><span class="o">.</span><span class="n">grant_read_data</span><span class="p">(</span><span class="n">get_haiku_lambda</span><span class="p">)</span>
        <span class="n">table</span><span class="o">.</span><span class="n">grant_read_write_data</span><span class="p">(</span><span class="n">post_haiku_lambda</span><span class="p">)</span>
        <span class="n">table</span><span class="o">.</span><span class="n">grant_read_write_data</span><span class="p">(</span><span class="n">patch_haiku_lambda</span><span class="p">)</span>
        <span class="n">table</span><span class="o">.</span><span class="n">grant_read_write_data</span><span class="p">(</span><span class="n">delete_haiku_lambda</span><span class="p">)</span>

        <i class="conum" data-value="5"></i><b>(5)</b>
        <span class="c1"># define API Gateway
</span>        <span class="n">api</span> <span class="o">=</span> <span class="n">apigw</span><span class="o">.</span><span class="n">RestApi</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="s">"BashoutterApi"</span><span class="p">,</span>
            <span class="n">default_cors_preflight_options</span><span class="o">=</span><span class="n">apigw</span><span class="o">.</span><span class="n">CorsOptions</span><span class="p">(</span>
                <span class="n">allow_origins</span><span class="o">=</span><span class="n">apigw</span><span class="o">.</span><span class="n">Cors</span><span class="o">.</span><span class="n">ALL_ORIGINS</span><span class="p">,</span>
                <span class="n">allow_methods</span><span class="o">=</span><span class="n">apigw</span><span class="o">.</span><span class="n">Cors</span><span class="o">.</span><span class="n">ALL_METHODS</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>

        <span class="n">haiku</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">add_resource</span><span class="p">(</span><span class="s">"haiku"</span><span class="p">)</span>
        <span class="n">haiku</span><span class="o">.</span><span class="n">add_method</span><span class="p">(</span>
            <span class="s">"GET"</span><span class="p">,</span>
            <span class="n">apigw</span><span class="o">.</span><span class="n">LambdaIntegration</span><span class="p">(</span><span class="n">get_haiku_lambda</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">haiku</span><span class="o">.</span><span class="n">add_method</span><span class="p">(</span>
            <span class="s">"POST"</span><span class="p">,</span>
            <span class="n">apigw</span><span class="o">.</span><span class="n">LambdaIntegration</span><span class="p">(</span><span class="n">post_haiku_lambda</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="n">haiku_item_id</span> <span class="o">=</span> <span class="n">haiku</span><span class="o">.</span><span class="n">add_resource</span><span class="p">(</span><span class="s">"{item_id}"</span><span class="p">)</span>
        <span class="n">haiku_item_id</span><span class="o">.</span><span class="n">add_method</span><span class="p">(</span>
            <span class="s">"PATCH"</span><span class="p">,</span>
            <span class="n">apigw</span><span class="o">.</span><span class="n">LambdaIntegration</span><span class="p">(</span><span class="n">patch_haiku_lambda</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">haiku_item_id</span><span class="o">.</span><span class="n">add_method</span><span class="p">(</span>
            <span class="s">"DELETE"</span><span class="p">,</span>
            <span class="n">apigw</span><span class="o">.</span><span class="n">LambdaIntegration</span><span class="p">(</span><span class="n">delete_haiku_lambda</span><span class="p">)</span>
        <span class="p">)</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>ここで，俳句の情報を記録しておくための DynamoDB テーブルを定義している．</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>続いて，静的コンテンツを配信するための S3 バケットを用意している．
また，スタックのデプロイ時に，必要なファイル群を自動的にアップロードするような設定を行っている．</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>続いて，それぞれの API で実行される Lambda 関数を定義している．
関数は Python3.7 で書かれており，コードは <a href="https://gitlab.com/tomomano/intro-aws/-/tree/master/handson/05-bashoutter/api/api.py">/handson/05-bashoutter/api/api.py</a> にある．</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>次に，2で定義された Lambda 関数に対し，データベースへの読み書きのアクセス権限を付与している．</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>ここで，API Gateway により，各APIパスとそこで実行されるべき Lambda 関数を紐付けている．</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>それぞれについて，もう少し詳しく説明しよう．</p>
</div>
</div>
<div class="sect3">
<h4 id="_public_access_mode_の_s3_バケット">13.2.3. Public access mode の S3 バケット</h4>
<div class="paragraph">
<p>S3 のバケットを作成しているコードを見てみよう．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="python"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="code"><pre><span class="n">bucket</span> <span class="o">=</span> <span class="n">s3</span><span class="o">.</span><span class="n">Bucket</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="s">"Bashoutter-Bucket"</span><span class="p">,</span>
    <span class="n">website_index_document</span><span class="o">=</span><span class="s">"index.html"</span><span class="p">,</span>
    <span class="n">public_read_access</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
    <span class="n">removal_policy</span><span class="o">=</span><span class="n">core</span><span class="o">.</span><span class="n">RemovalPolicy</span><span class="o">.</span><span class="n">DESTROY</span>
<span class="p">)</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>ここで注目してほしいのは <code>public_read_access=True</code> の部分だ．</p>
</div>
<div class="paragraph">
<p>前章で， S3 について説明を行った時には触れなかったが， S3 には <strong>Public access mode</strong> という機能がある．
Public access mode をオンにしておくと，バケットの中のファイルは基本的にすべて認証無しで (i.e. インターネット上の誰でも) 閲覧できるようになる．
この設定は，ウェブサイトの静的なコンテンツを置いておくのに最適であり，多くのサーバーレスによるウェブサービスでこのような設計が行われる．
public access mode を設定しておくと， <code><a href="http://XXXX.s3-website-ap-northeast-1.amazonaws.com/" class="bare">http://XXXX.s3-website-ap-northeast-1.amazonaws.com/</a></code> のような固有の URL がバケットに対して付与される．
そして，クライアントがこの URL にアクセスをすると，バケットの中にある <code>index.html</code> がクライアントに返され，ページがロードされる．
(どのページがサーブされるかは， <code>website_index_document="index.html"</code> の部分で設定している．)</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>より本格的なウェブページを運用する際には， public access mode の S3 バケットに， <a href="https://aws.amazon.com/cloudfront/">CloudFront</a> という機能を追加することが一般的である．</p>
</div>
<div class="paragraph">
<p>CloudFront はいくつかの役割を担っているのだが，最も重要な機能が <strong>Content Delivery Nework (CDN)</strong> である．
CDN とは，頻繁にアクセスされるデータをメモリーなどの高速記録媒体にキャッシュしておくことで，クライアントがより高速にデータをダウンロードすることを可能にする仕組みである．
また，世界各地のデータセンターにそのようなキャッシュを配置することで，クライアントと地理的に最も近いデータセンターからデータが配信する，というような設定も可能である．</p>
</div>
<div class="paragraph">
<p>また，CloudFront を配置することで， HTTPS 通信を設定することができる．
(逆に言うと， S3 単体では HTTP 通信しか行うことができない．)
現代的なウェブサービスでは，秘匿情報を扱う扱わないに関わらず， HTTPS を用いることが標準となっている．</p>
</div>
<div class="paragraph">
<p>今回のハンズオンでは説明の簡略化のため CloudFront の設定を行わなかったが，興味のある読者は以下のリンクのプログラムが参考になるだろう．</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://github.com/aws-samples/aws-cdk-examples/tree/master/typescript/static-site" class="bare">https://github.com/aws-samples/aws-cdk-examples/tree/master/typescript/static-site</a></p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>今回の S3 バケットには， AWS によって付与されたランダムな URL がついている．
これを． <code>example.com</code> のような自分のドメインでホストしたければ， AWS によって付与された URL を自分のドメインの DNS レコードに追加すればよい．</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Public access mode の S3 バケットを作成した後，バケットの中に配置するウェブサイトコンテンツを，以下のコードによりアップロードしている．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="python"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="code"><pre><span class="n">s3_deploy</span><span class="o">.</span><span class="n">BucketDeployment</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="s">"BucketDeployment"</span><span class="p">,</span>
    <span class="n">destination_bucket</span><span class="o">=</span><span class="n">bucket</span><span class="p">,</span>
    <span class="n">sources</span><span class="o">=</span><span class="p">[</span><span class="n">s3_deploy</span><span class="o">.</span><span class="n">Source</span><span class="o">.</span><span class="n">asset</span><span class="p">(</span><span class="s">"./gui/dist"</span><span class="p">)],</span>
    <span class="n">retain_on_delete</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
<span class="p">)</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>ウェブサイトのコンテンツは <a href="https://gitlab.com/tomomano/intro-aws/-/tree/master/handson/05-bashoutter/gui/">/handson/05-bashoutter/gui/</a> にある (特に，ビルド済みのものが <code>/dist/</code> 以下にある)．
興味のある読者は中身を確認してみるとよい．</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>今回のウェブサイトは <a href="https://vuejs.org/">Vue.js</a> と <a href="https://vuetifyjs.com/">Vuetify</a> という UI フレームワークを使って作成した．
ソースコードは <a href="https://gitlab.com/tomomano/intro-aws/-/tree/master/handson/05-bashoutter/gui/">/handson/05-bashoutter/gui/src/</a> にあるので，見てみるとよい．</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_api_のハンドラ関数">13.2.4. API のハンドラ関数</h4>
<div class="paragraph">
<p>API リクエストが来たときに，リクエストされた処理を行う関数のことを特にハンドラ (handler) 関数と呼ぶ．
Lambda を使って <code>GET /haiku</code> の API に対してのハンドラ関数を定義している部分を見てみよう．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="python"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="code"><pre><span class="n">get_haiku_lambda</span> <span class="o">=</span> <span class="n">_lambda</span><span class="o">.</span><span class="n">Function</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="s">"GetHaiku"</span><span class="p">,</span>
    <span class="n">code</span><span class="o">=</span><span class="n">_lambda</span><span class="o">.</span><span class="n">Code</span><span class="o">.</span><span class="n">from_asset</span><span class="p">(</span><span class="s">"api"</span><span class="p">),</span>
    <span class="n">handler</span><span class="o">=</span><span class="s">"api.get_haiku"</span><span class="p">,</span>
    <span class="o">...</span>
<span class="p">)</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p><code>code=_lambda.Code.from_asset("api"), handler="api.get_haiku"</code>
のところで，外部のディレクトリ (<code>api/</code>) にある <code>api.py</code> というファイルの， <code>get_haiku()</code> という関数をハンドラ関数として実行せよ，と指定している．
この <code>get_haiku()</code> のコードを見てみよう (<a href="https://gitlab.com/tomomano/intro-aws/-/tree/master/handson/05-bashoutter/api/api.py">/handson/05-bashoutter/api/api.py</a>)．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="python"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
</pre></td><td class="code"><pre><span class="n">ddb</span> <span class="o">=</span> <span class="n">boto3</span><span class="o">.</span><span class="n">resource</span><span class="p">(</span><span class="s">"dynamodb"</span><span class="p">)</span>
<span class="n">table</span> <span class="o">=</span> <span class="n">ddb</span><span class="o">.</span><span class="n">Table</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s">"TABLE_NAME"</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">get_haiku</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
    <span class="s">"""
    handler for GET /haiku
    """</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">scan</span><span class="p">()</span>

        <span class="n">status_code</span> <span class="o">=</span> <span class="mi">200</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">"Items"</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">status_code</span> <span class="o">=</span> <span class="mi">500</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="p">{</span><span class="s">"description"</span><span class="p">:</span> <span class="n">f</span><span class="s">"Internal server error. {str(e)}"</span><span class="p">}</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="s">"statusCode"</span><span class="p">:</span> <span class="n">status_code</span><span class="p">,</span>
        <span class="s">"headers"</span><span class="p">:</span> <span class="n">HEADERS</span><span class="p">,</span>
        <span class="s">"body"</span><span class="p">:</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">resp</span><span class="p">,</span> <span class="n">cls</span><span class="o">=</span><span class="n">DecimalEncoder</span><span class="p">)</span>
    <span class="p">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p><code>response = table.scan()</code> で，俳句の格納された DynamoDB テーブルから，全ての要素を取り出している．
もしなにもエラーが起きなければステータスコード200が返され，もしなにかエラーが起こればステータスコード500が返されるようになっている．</p>
</div>
<div class="paragraph">
<p>上記のような操作を，他の API についても繰り返すことで，すべての API のハンドラ関数が定義されている．</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p><code>GET /haiku</code> のハンドラ関数で， <code>response = table.scan()</code> という部分があるが，実はこれは最善の書き方ではない．
DynamoDB の <code>scan()</code> メソッドは，最大で 1MB までのデータしか返さない．
データベースのサイズが大きく， 1MB 以上のデータがある場合には，再帰的に <code>scan()</code> メソッドを呼ぶ必要がある．
詳しくは <a href="https://boto3.amazonaws.com/v1/documentation/api/latest/reference/services/dynamodb.html#DynamoDB.Table.scan">boto3 ドキュメンテーション</a> を参照．</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_aws_における権限の管理_iam">13.2.5. AWS における権限の管理 (IAM)</h4>
<div class="paragraph">
<p>以下の部分のコードに注目してほしい．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="python"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno">1
2
3
4
</pre></td><td class="code"><pre><span class="n">table</span><span class="o">.</span><span class="n">grant_read_data</span><span class="p">(</span><span class="n">get_haiku_lambda</span><span class="p">)</span>
<span class="n">table</span><span class="o">.</span><span class="n">grant_read_write_data</span><span class="p">(</span><span class="n">post_haiku_lambda</span><span class="p">)</span>
<span class="n">table</span><span class="o">.</span><span class="n">grant_read_write_data</span><span class="p">(</span><span class="n">patch_haiku_lambda</span><span class="p">)</span>
<span class="n">table</span><span class="o">.</span><span class="n">grant_read_write_data</span><span class="p">(</span><span class="n">delete_haiku_lambda</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>これまでは説明の簡略化のため敢えて触れてこなかったが， AWS には <a href="https://aws.amazon.com/iam/">IAM (Identity and Access Management)</a> という重要な概念がある．
IAM は基本的に，あるリソースが他のリソースに対してどのような権限を持っているか，を規定するものである．
Lambdaは，デフォルトの状態では他のリソースにアクセスする権限をなにも有していない．
したがって， Lambda 関数が DynamoDB のデータを読み書きするためには，それを許可するような IAM が Lambda 関数に付与されていなければならない．</p>
</div>
<div class="paragraph">
<p>CDK による <code>dynamodb.Table</code> オブジェクトには <code>grant_read_write_data()</code> という便利なメソッドが備わっており，アクセスを許可したい Lambda 関数を引数としてこのメソッドを呼ぶことで，データベースへの読み書きを許可する IAM を付与することができる．</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>各リソースに付与する IAM は，<strong>必要最低限の権限を与えるにとどめる</strong>というのが基本方針である．
これにより，セキュリティを向上させるだけでなく，意図していないプログラムからのデータベースへの読み書きを防止するという点で，バグを未然に防ぐことができる．</p>
</div>
<div class="paragraph">
<p>そのような理由により，上のコードでは <code>GET</code> のハンドラー関数に対しては <code>grant_read_data()</code> によって， read 権限のみを付与している．</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_api_gateway">13.2.6. API Gateway</h4>
<div class="paragraph">
<p><a href="https://aws.amazon.com/api-gateway/">API Gateway</a> とは， API の"入り口"として，APIのリクエストパスに従って Lambda 関数などに接続を行うという機能を担う．
このような API のリソースパスに応じて接続先を振り分けるようなサーバーを<strong>ルーター</strong>と呼んだりする．
従来的には，ルーターにはそれ専用の仮想サーバーが置かれることが一般的であったが， API Gateway はその機能をサーバーレスで担ってくれる．
すなわち， API のリクエストが来たときのみ起動し，API が来ていない間は完全にシャットダウンしている．
一方で，アクセスが大量に来た場合はそれに比例してルーティングの処理能力を増大してくれる．</p>
</div>
<div class="paragraph">
<p>API Gateway を配置することで，大量　(1秒間に数千から数万件) の API リクエストに対応することのできるシステムを容易に構築することができる．
API Gateway の料金は <a href="#tab_handson_05_apigateway_price">Table 9</a> のように設定されている．
また，無料利用枠により，月ごとに100万件までのリクエストは0円で使用できる．</p>
</div>
<table id="tab_handson_05_apigateway_price" class="tableblock frame-all grid-all stretch">
<caption class="title">Table 9. API Gateway の利用料金設定 (<a href="https://aws.amazon.com/api-gateway/pricing/">参照</a>)</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Number of Requests (per month)</th>
<th class="tableblock halign-left valign-top">Price (per million)</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">First 333 million</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">$4.25</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Next 667 million</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">$3.53</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Next 19 billion</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">$3.00</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Over 20 billion</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">$1.91</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>ソースコードの該当箇所を見てみよう．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="python"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
</pre></td><td class="code"><pre><span class="n">api</span> <span class="o">=</span> <span class="n">apigw</span><span class="o">.</span><span class="n">RestApi</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="s">"BashoutterApi"</span><span class="p">,</span>
    <span class="n">default_cors_preflight_options</span><span class="o">=</span><span class="n">apigw</span><span class="o">.</span><span class="n">CorsOptions</span><span class="p">(</span>
        <span class="n">allow_origins</span><span class="o">=</span><span class="n">apigw</span><span class="o">.</span><span class="n">Cors</span><span class="o">.</span><span class="n">ALL_ORIGINS</span><span class="p">,</span>
        <span class="n">allow_methods</span><span class="o">=</span><span class="n">apigw</span><span class="o">.</span><span class="n">Cors</span><span class="o">.</span><span class="n">ALL_METHODS</span><span class="p">,</span>
    <span class="p">)</span>
<span class="p">)</span>

<span class="n">haiku</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">add_resource</span><span class="p">(</span><span class="s">"haiku"</span><span class="p">)</span>
<span class="n">haiku</span><span class="o">.</span><span class="n">add_method</span><span class="p">(</span>
    <span class="s">"GET"</span><span class="p">,</span>
    <span class="n">apigw</span><span class="o">.</span><span class="n">LambdaIntegration</span><span class="p">(</span><span class="n">get_haiku_lambda</span><span class="p">)</span>
<span class="p">)</span>
<span class="n">haiku</span><span class="o">.</span><span class="n">add_method</span><span class="p">(</span>
    <span class="s">"POST"</span><span class="p">,</span>
    <span class="n">apigw</span><span class="o">.</span><span class="n">LambdaIntegration</span><span class="p">(</span><span class="n">post_haiku_lambda</span><span class="p">)</span>
<span class="p">)</span>

<span class="n">haiku_item_id</span> <span class="o">=</span> <span class="n">haiku</span><span class="o">.</span><span class="n">add_resource</span><span class="p">(</span><span class="s">"{item_id}"</span><span class="p">)</span>
<span class="n">haiku_item_id</span><span class="o">.</span><span class="n">add_method</span><span class="p">(</span>
    <span class="s">"PATCH"</span><span class="p">,</span>
    <span class="n">apigw</span><span class="o">.</span><span class="n">LambdaIntegration</span><span class="p">(</span><span class="n">patch_haiku_lambda</span><span class="p">)</span>
<span class="p">)</span>
<span class="n">haiku_item_id</span><span class="o">.</span><span class="n">add_method</span><span class="p">(</span>
    <span class="s">"DELETE"</span><span class="p">,</span>
    <span class="n">apigw</span><span class="o">.</span><span class="n">LambdaIntegration</span><span class="p">(</span><span class="n">delete_haiku_lambda</span><span class="p">)</span>
<span class="p">)</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p><code>api = apigw.RestApi()</code> により，空の API Gateway を作成している．</p>
</li>
<li>
<p>次に， <code>api.root.add_resource()</code> のメソッドを呼ぶことで， <code>/haiku</code> という API パスを追加している．</p>
</li>
<li>
<p>続いて， <code>add_method()</code> を呼ぶことで， <code>GET</code>, <code>POST</code> のメソッドを <code>/haiku</code> のパスに定義している．</p>
</li>
<li>
<p>さらに， <code>haiku.add_resource("{item_id}")</code> により， <code>/haiku/{item_id}</code> という API パスを追加している．</p>
</li>
<li>
<p>最後に， <code>add_method()</code> を呼ぶことにより， <code>PATCH</code>, <code>DELETE</code> のメソッドを <code>/haiku/{item_id}</code> のパスに定義している．</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>このように， 逐次的に API パスとそこで実行されるメソッド・Lambda を記述していくだけでよい．</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>上記のプログラムで 新規 API を作成すると， AWS からランダムな URL がその API のエンドポイントとして割り当てられる．
これを． <code>api.example.com</code> のような自分のドメインでホストしたければ， AWS によって付与された URL を自分のドメインの DNS レコードに追加すればよい．</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>API Gateway で新規 API を作成したとき， <code>default_cors_preflight_options=</code> というパラメータで <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/CORS">Cross Origin Resource Sharing (CORS)</a> の設定を行っている．
これは，ブラウザで走る Web アプリケーションと API を接続する際に必要な設定である．
興味のある読者は各自 CORS について調べてもらいたい．</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_アプリケーションのデプロイ">13.3. アプリケーションのデプロイ</h3>
<div class="paragraph">
<p>アプリケーションの中身が理解できたところで，早速デプロイを行ってみよう．</p>
</div>
<div class="paragraph">
<p>デプロイの手順は，これまでのハンズオンとほとんど共通である．
ここでは，コマンドのみ列挙する (<code>#</code> で始まる行はコメントである)．
それぞれの意味を忘れてしまった場合は，ハンズオン1, 2に戻って復習していただきたい．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="c"># プロジェクトのディレクトリに移動</span>
<span class="nv">$ </span><span class="nb">cd </span>intro-aws/handson/05-bashoutter

<span class="c"># venv を作成し，依存ライブラリのインストールを行う</span>
<span class="nv">$ </span>python3 <span class="nt">-m</span> venv .env
<span class="nv">$ </span><span class="nb">source</span> .env/bin/activate
<span class="nv">$ </span>pip <span class="nb">install</span> <span class="nt">-r</span> requirements.txt

<span class="c"># AWS の認証情報をセットする</span>
<span class="c"># 自分自身の認証情報に置き換えること！</span>
<span class="nb">export </span><span class="nv">AWS_ACCESS_KEY_ID</span><span class="o">=</span>XXXXXX
<span class="nb">export </span><span class="nv">AWS_SECRET_ACCESS_KEY</span><span class="o">=</span>YYYYYY
<span class="nb">export </span><span class="nv">AWS_DEFAULT_REGION</span><span class="o">=</span>ap-northeast-1

<span class="c"># デプロイを実行</span>
<span class="nv">$ </span>cdk deploy</code></pre>
</div>
</div>
<div class="paragraph">
<p>デプロイのコマンドが無事に実行されれば， <a href="#handson_05_cdk_output">Figure 84</a> のような出力が得られるはずである．
ここで表示されている <code>Bashoutter.BashoutterApiEndpoint = XXXX</code>, <code>Bashoutter.BucketUrl = YYYY</code> の二つ文字列は次に使うのでメモしておこう．</p>
</div>
<div id="handson_05_cdk_output" class="imageblock text-center">
<div class="content">
<img src="imgs/handson-05/cdk_output.png" alt="cdk output" width="700">
</div>
<div class="title">Figure 84. CDKデプロイ実行後の出力</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p><code>$ cdk bootstrap</code> のコマンドを実行していないと，上記のデプロイはエラーを出力する．</p>
</div>
<div class="paragraph">
<p><code>bootstrap</code> のコマンドは1アカウントにつき1度実行されていればよい．
<a href="#aws_cdk_install">Section 15.3</a> も参照のこと．</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>上記のデプロイで得られた API のエンドポイントは API Gateway によりランダムに作成されたアドレスである．
このアドレスを DNS に登録することで，自分の好きなドメイン名 (例: api.example.com) と結びつけることが可能である．</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>AWS コンソールにログインして，デプロイされたスタックを確認してみよう．
コンソールから， API Gateway のページに行くと， <a href="#handson_05_apigw_console_list">Figure 85</a> のような画面が表示され，デプロイ済みの API エンドポイントの一覧が確認できる．</p>
</div>
<div id="handson_05_apigw_console_list" class="imageblock text-center">
<div class="content">
<img src="imgs/handson-05/apigw_console_list.png" alt="apigw_console_list" width="700">
</div>
<div class="title">Figure 85. API Gateway コンソール画面 (1)</div>
</div>
<div class="paragraph">
<p>今回デプロイした "BashoutterApi" という名前の API をクリックすることで <a href="#handson_05_apigw_console_detail">Figure 86</a> のような画面に遷移し，詳細情報を閲覧できる．
<code>GET /haiku</code>, <code>POST /haiku</code> などが定義されていることが確認できる．</p>
</div>
<div class="paragraph">
<p>それぞれのメソッドをクリックすると，そのメソッドの詳細情報を確認できる．
API Gateway は，上で説明したルーティングの機能だけでなく，認証機能などを追加することも可能であり，そのような理由で
<a href="#handson_05_apigw_console_detail">Figure 86</a> で画面右端赤色で囲った部分に，この API で呼ばれる Lambda 関数が指定されている．
関数名をクリックすることで，関数の中身を閲覧することが可能である．</p>
</div>
<div id="handson_05_apigw_console_detail" class="imageblock text-center">
<div class="content">
<img src="imgs/handson-05/apigw_console_detail.png" alt="apigw_console_detail" width="700">
</div>
<div class="title">Figure 86. API Gateway コンソール画面 (2)</div>
</div>
<div class="paragraph">
<p>次に， S3 のコンソール画面に移ってみよう．
"bashouter-XXXXX" という名前のバケットが見つかるはずである (<a href="#handson_05_s3_console">Figure 87</a>)．</p>
</div>
<div id="handson_05_s3_console" class="imageblock text-center">
<div class="content">
<img src="imgs/handson-05/s3_console.png" alt="s3_console" width="700">
</div>
<div class="title">Figure 87. S3 コンソール画面</div>
</div>
<div class="paragraph">
<p>バケットの名前をクリックすることで，バケットの中身を確認してみよう．
<code>index.html</code> のほか， <code>css/</code>, <code>js/</code> などのディレクトリがあるのが確認できるだろう (<a href="#handson_05_s3_contents">Figure 88</a>)．
これらが，ウェブページの"枠"を定義している静的コンテンツである．</p>
</div>
<div id="handson_05_s3_contents" class="imageblock text-center">
<div class="content">
<img src="imgs/handson-05/s3_contents.png" alt="s3_contents" width="700">
</div>
<div class="title">Figure 88. S3 バケットの中身</div>
</div>
</div>
<div class="sect2">
<h3 id="_api_を送信する">13.4. API を送信する</h3>
<div class="paragraph">
<p>それでは，デプロイしたアプリケーションに対し，実際に API を送信してみよう
(ひとまずは， S3 にあるGUIの方はおいておく．今回のアプリケーションでより本質的なのは API の方だからである)．</p>
</div>
<div class="paragraph">
<p>ここではコマンドラインから API を送信するためのシンプルなHTTPクライアントである <a href="https://httpie.org/">HTTPie</a> を使ってみよう．
HTTPie は，スタックをデプロイするときに Python 仮想環境を作成した際，一緒にインストールした．
コマンドラインに <code>http</code> と打ってみて，コマンドの使い方が出力されることを確認しよう．</p>
</div>
<div class="paragraph">
<p>まず最初に，先ほどデプロイを実行した際に得られた API のエンドポイントの URL (<code>Bashoutter.BashoutterApiEndpoint = XXXX</code> で得られた <code>XXXX</code> の文字列) をコマンドラインの変数に設定しておく．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span><span class="nb">export </span><span class="nv">ENDPOINT_URL</span><span class="o">=</span><span class="s2">"https://OOOO.execute-api.ap-northeast-1.amazonaws.com/prod/"</span></code></pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>上のコマンドで，URLは自分のデプロイしたスタックのURLに置き換える．</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>次に，俳句の一覧を取得するため， <code>GET /haiku</code> の API を送信してみよう．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>http GET <span class="s2">"</span><span class="k">${</span><span class="nv">ENDPOINT_URL</span><span class="k">}</span><span class="s2">/haiku"</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>現時点では，まだだれも俳句を投稿していないので，空の配列 (<code>[]</code>) が返ってくる．</p>
</div>
<div class="paragraph">
<p>それでは次に，俳句を投稿してみよう．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>http POST <span class="s2">"</span><span class="k">${</span><span class="nv">ENDPOINT_URL</span><span class="k">}</span><span class="s2">/haiku"</span> <span class="se">\</span>
<span class="nv">username</span><span class="o">=</span><span class="s2">"松尾芭蕉"</span> <span class="se">\</span>
<span class="nv">first</span><span class="o">=</span><span class="s2">"閑さや"</span> <span class="se">\</span>
<span class="nv">second</span><span class="o">=</span><span class="s2">"岩にしみ入る"</span> <span class="se">\</span>
<span class="nv">third</span><span class="o">=</span><span class="s2">"蝉の声"</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>以下のような出力が得られるだろう．</p>
</div>
<div class="listingblock">
<div class="content">
<pre>HTTP/1.1 201 Created
Connection: keep-alive
Content-Length: 49
Content-Type: application/json
....
{
    "description": "Successfully added a new haiku"
}</pre>
</div>
</div>
<div class="paragraph">
<p>新しい俳句を投稿することに成功したようである．
本当に俳句が追加されたか，再び GET リクエストを呼ぶことで確認してみよう．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>http GET <span class="s2">"</span><span class="k">${</span><span class="nv">ENDPOINT_URL</span><span class="k">}</span><span class="s2">/haiku"</span>

HTTP/1.1 200 OK
Connection: keep-alive
Content-Length: 258
Content-Type: application/json
...
<span class="o">[</span>
    <span class="o">{</span>
        <span class="s2">"created_at"</span>: <span class="s2">"2020-07-06T02:46:04+00:00"</span>,
        <span class="s2">"first"</span>: <span class="s2">"閑さや"</span>,
        <span class="s2">"item_id"</span>: <span class="s2">"7e91c5e4d7ad47909e0ac14c8bbab05b"</span>,
        <span class="s2">"likes"</span>: 0.0,
        <span class="s2">"second"</span>: <span class="s2">"岩にしみ入る"</span>,
        <span class="s2">"third"</span>: <span class="s2">"蝉の声"</span>,
        <span class="s2">"username"</span>: <span class="s2">"松尾芭蕉"</span>
    <span class="o">}</span>
<span class="o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>素晴らしい！</p>
</div>
<div class="paragraph">
<p>次に， <code>PATCH /haiku/{item_id}</code> を呼ぶことでこの俳句にいいねを追加してみよう．
上のコマンドで取得した俳句の <code>item_id</code> を，下のコマンドの <code>XXXX</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>http PATCH <span class="s2">"</span><span class="k">${</span><span class="nv">ENDPOINT_URL</span><span class="k">}</span><span class="s2">/haiku/XXXX"</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>再び GET リクエストを送ることで，いいね (<code>likes</code>) が1増えたことを確認しよう．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>http GET <span class="s2">"</span><span class="k">${</span><span class="nv">ENDPOINT_URL</span><span class="k">}</span><span class="s2">/haiku"</span>
...
<span class="o">[</span>
    <span class="o">{</span>
        ...
        <span class="s2">"likes"</span>: 1.0,
        ...
    <span class="o">}</span>
<span class="o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>最後に， DELETE リクエストを送ることで俳句をデータベースから削除しよう．
<code>XXXX</code> は <code>item_id</code> の値で置き換えた上で以下のコマンドを実行する．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>http DELETE <span class="s2">"</span><span class="k">${</span><span class="nv">ENDPOINT_URL</span><span class="k">}</span><span class="s2">/haiku/XXXX"</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>再び GET リクエストを送ることで，返り値が空 (<code>[]</code>) になっていることを確認しよう．</p>
</div>
<div class="paragraph">
<p>以上のように， SNS に必要な基本的な API がきちんと動作していることが確認できた．</p>
</div>
</div>
<div class="sect2">
<h3 id="_大量の_api_リクエストをシミュレートする">13.5. 大量の API リクエストをシミュレートする</h3>
<div class="paragraph">
<p>さて，前節ではマニュアルでひとつづづ俳句を投稿した．
多数のユーザーがいるような SNS では，一秒間に数千件以上の投稿がされている．
今回はサーバーレスアーキテクチャを採用したことで，そのような瞬間的な大量アクセスにも容易に対応できるようなシステムが構築できている！</p>
</div>
<div class="paragraph">
<p>その点をデモンストレートするため，ここでは大量の API が送信された状況をシミュレートしてみよう．</p>
</div>
<div class="paragraph">
<p><a href="https://gitlab.com/tomomano/intro-aws/-/tree/master/handson/05-bashoutter/client.py">/handson/05-bashoutter/client.py</a> に，大量のAPIリクエストをシミュレートするためのプログラムが書かれている．
このプログラムは基本的に <code>POST /haiku</code> の API リクエストを指定された回数だけ実行する．</p>
</div>
<div class="paragraph">
<p>テストとして， API を300回送ってみよう．
以下のコマンドを実行する．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>python client.py <span class="nv">$ENDPOINT_URL</span> post_many 300</code></pre>
</div>
</div>
<div class="paragraph">
<p>数秒のうちに実行が完了するだろう．
これがもし，単一のサーバーからなる API だったとしたら，このような大量のリクエストの処理にはもっと時間がかかっただろう．
最悪の場合には，サーバーダウンにもつながっていたかもしれない．
従って，今回作成したサーバーレスアプリケーションは，とてもシンプルながらも一秒間に数百件の処理を行えるような，スケーラブルなクラウドシステムであることがわかる．
サーバーレスでクラウドを設計することの利点を垣間見ることができただろうか？</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>上記のコマンドにより，大量の俳句を投稿するとデータベースに無駄なデータがどんどん溜まってしまう．
データベースを完全に空にするには，以下のコマンドを使用する．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>python client.py <span class="nv">$ENDPOINT_URL</span> clear_database</code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_bashoutter_gui_を動かしてみる">13.6. Bashoutter GUI を動かしてみる</h3>
<div class="paragraph">
<p>前節ではコマンドラインから API を送信する演習を行った．
ウェブアプリケーションでは，これらの API はウェブブラウザ上のウェブページから送信され，コンテンツが表示されている (<a href="#web_server">Figure 69</a> 参照)．
最後に， API が GUI と統合されるとどうなるのか，見てみよう．</p>
</div>
<div class="paragraph">
<p>デプロイを実行したときにコマンドラインで出力された， <code>ashoutter.BucketUrl=</code> に続く URL を確認しよう (<a href="#handson_05_cdk_output">Figure 84</a>)．
これは，先述したとおり， Public access mode の S3 バケットの URL である．</p>
</div>
<div class="paragraph">
<p>ウェブブラウザを開き，そのURLへアクセスをしてみよう．
すると， <a href="#handson_05_bashoutter_2">Figure 89</a> のようなページが表示されるはずである．</p>
</div>
<div id="handson_05_bashoutter_2" class="imageblock text-center">
<div class="content">
<img src="imgs/handson-05/bashoutter_2.png" alt="bashoutter" width="700">
</div>
<div class="title">Figure 89. "Bashoutter" の GUI 画面</div>
</div>
<div class="paragraph">
<p>ページが表示されたら，一番上の "API Endpoint URL" と書いてあるテキストボックスに，今回デプロイした API Gateway の URL を入力する
(今回のアプリケーションでは，API Gateway の URL はランダムに割り当てられるのでこのような仕様になっている)．
そうしたら，画面の "REFRESH" と書いてあるボタンを押してみよう．
データベースに俳句が登録済みであれば，俳句の一覧が表示されるはずである．
各俳句の左下にあるハートのアイコンをクリックすることで， "like" の票を入れることができる．</p>
</div>
<div class="paragraph">
<p>新しい俳句を投稿するには，五七五と投稿者の名前を入力して， "POST" を押す．
"POST" を押した後は，再び "REFRESH" ボタンを押すことで最新の俳句のリストをデータベースから取得する．</p>
</div>
<div class="paragraph">
<p>今回は，どうやって GUI を作成したかは触れないが，基本的にページの背後では <code>GET /haiku</code>, <code>POST /haiku</code> などの API がクラウドに送信されることで，コンテンツが表示されている．
興味のある読者は GUI のソースコードも読んでみるとよい (<a href="https://gitlab.com/tomomano/intro-aws/-/tree/master/handson/05-bashoutter/gui/">/handson/05-bashoutter/gui/</a>)．</p>
</div>
</div>
<div class="sect2">
<h3 id="_アプリケーションの削除">13.7. アプリケーションの削除</h3>
<div class="paragraph">
<p>これにて，第五回ハンズオンは終了である．最後にスタックを削除しよう．</p>
</div>
<div class="paragraph">
<p>スタックを削除するには，まず最初に S3 バケットの中身をすべて削除しなければならない．
コンソールから実行するには， S3 コンソールに行き，バケットの中身を開いた上で，全てのファイルを選択し， "Actions" &#8594; "Delete" を実行すれば良い．</p>
</div>
<div class="paragraph">
<p>コマンドラインから実行するには， 次のコマンドを使う．
&lt;BUCKET NAME&gt; のところは，自分の バケットの名前 ("BashoutterBucketXXXX" というパターンの名前がついているはずである) に置き換えることを忘れずに．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>aws s3 <span class="nb">rm</span> &lt;BUCKET NAME&gt; <span class="nt">--recursive</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>S3 バケットを空にしたら，次のコマンドを実行してスタックを削除する．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>cdk destroy</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_講義第三回目のまとめ">13.8. 講義第三回目のまとめ</h3>
<div class="paragraph">
<p>ここまでが，講義第三回目の内容である．</p>
</div>
<div class="paragraph">
<p>今回は，クラウドの応用として，一般の人に使ってもらうようなウェブアプリケーション・データベースをどのようにして作るのか，という点に焦点を当てて，講義を行った．
その中で，従来的なクラウドシステムの設計と，ここ数年の最新の設計方法であるサーバーレスアーキテクチャについて解説した．
特に， AWS でのサーバーレスの実践として， Lambda, S3, DynamoDB のハンズオンを行った．
最後に，ハンズオン第五回目では，これらの技術を統合することで，完全サーバーレスなウェブアプリケーション "Bashoutter" を作成した．</p>
</div>
<div class="paragraph">
<p>今回の講義を通じて，世の中のウェブサービスがどのようにして出来上がっているのか，少し理解が深まっただろうか？
また，そのようなウェブアプリケーションを自分が作りたいと思ったときの，出発点となることができたならば幸いである．</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_まとめ">14. まとめ</h2>
<div class="sectionbody">

</div>
</div>
<div class="sect1">
<h2 id="_appendix">15. Appendix</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="aws_secrets">15.1. AWS のシークレットキーの作成</h3>
<div class="paragraph">
<p>AWS シークレットキーとは， AWS CLI や AWS CDK から AWS の API を操作する際に，ユーザー認証を行うための鍵のことである．
AWS CLI/CDK を使うには，最初にシークレットキーを発行する必要がある．
AWS シークレットキーの詳細は <a href="https://docs.aws.amazon.com/ja_jp/general/latest/gr/managing-aws-access-keys.html">公式ドキュメンテーション</a> を参照．</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>AWS コンソールにログインする．</p>
</li>
<li>
<p>画面右上のアカウント名をクリックし，表示されるプルダウンメニューから "My Security Credentials" を選択 (<a href="#aws_secret_key_1">Figure 90</a>)</p>
</li>
<li>
<p>"Access keys for CLI, SDK, &amp; API access" の下にある "Create accesss key" のボタンをクリックする (<a href="#aws_secret_key_1">Figure 90</a>)</p>
</li>
<li>
<p>表示された Access key ID, Secret access key を記録しておく (画面を閉じると以降は表示されない)．</p>
</li>
<li>
<p>鍵を忘れてしまった場合などは，何度でも発行が可能である．</p>
</li>
<li>
<p>発行したシークレットキーは， <code>~/.aws/credentials</code> のファイルに書き込むか，環境変数に設定するなどして使う (詳しくは <a href="#aws_cli_install">Section 15.2</a>)．</p>
</li>
</ol>
</div>
<div id="aws_secret_key_1" class="imageblock text-center">
<div class="content">
<img src="imgs/aws_secret_key_1.png" alt="aws_secret_key_1" width="400">
</div>
<div class="title">Figure 90. AWS シークレットキーの発行1</div>
</div>
<div id="aws_secret_key_2" class="imageblock text-center">
<div class="content">
<img src="imgs/aws_secret_key_2.png" alt="aws_secret_key_2" width="700">
</div>
<div class="title">Figure 91. AWS シークレットキーの発行2</div>
</div>
</div>
<div class="sect2">
<h3 id="aws_cli_install">15.2. AWS CLI のインストール</h3>
<div class="paragraph">
<p>読者のために，執筆時点におけるインストールの手順 (Linux 向け) を簡単に記述する．
将来のバージョンでは変更される可能性があるので，常に <a href="https://docs.aws.amazon.com/cli/latest/userguide/install-cliv2.html">公式のドキュメンテーション</a> で最新の情報をチェックすることを忘れずに．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>curl <span class="s2">"https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip"</span> <span class="nt">-o</span> <span class="s2">"awscliv2.zip"</span>
<span class="nv">$ </span>unzip awscliv2.zip
<span class="nv">$ </span><span class="nb">sudo</span> ./aws/install</code></pre>
</div>
</div>
<div class="paragraph">
<p>インストールできたか確認するため，以下のコマンドを打ってバージョン情報が出力されることを確認する．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>aws <span class="nt">--version</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>インストールができたら，以下のコマンドにより初期設定を行う (<a href="https://docs.aws.amazon.com/cli/latest/userguide/cli-chap-configure.html">参照</a>)．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>aws configure</code></pre>
</div>
</div>
<div class="paragraph">
<p>コマンドを実行すると， <code>AWS Access Key ID</code>, <code>AWS Secret Access Key</code> を入力するよう指示される．
シークレットキーの発行については <a href="#aws_secrets">Section 15.1</a> を参照．
コマンドは加えて，<code>Default region name</code> を訊いてくる．
ここには自分の好きな地域 (例えば <code>ap-northeast-1</code> =東京リージョン) を指定すればよい．
最後の <code>Default output format</code> は <code>JSON</code> としておくとよい．</p>
</div>
<div class="paragraph">
<p>上記のコマンドを完了すると， <code>~/.aws/credentials</code> と <code>~/.aws/config</code>　という名前のファイルが生成されているはずである．
念の為，中身をしてみるとよい．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span><span class="nb">cat</span> ~/.aws/credentials
<span class="o">[</span>default]
aws_access_key_id <span class="o">=</span> XXXXXXXXXXXXXXXXXX
aws_secret_access_key <span class="o">=</span> YYYYYYYYYYYYYYYYYYY

<span class="nv">$ </span><span class="nb">cat</span> ~/.aws/config
<span class="o">[</span>profile default]
region <span class="o">=</span> ap-northeast-1
output <span class="o">=</span> json</code></pre>
</div>
</div>
<div class="paragraph">
<p>上記のような出力が得られるはずである．</p>
</div>
<div class="paragraph">
<p><code>~/.aws/credentials</code> には認証鍵の情報が， <code>~/.aws/config</code> には AWS CLI の設定が記録されている．</p>
</div>
<div class="paragraph">
<p>デフォルトでは， <code>[default]</code> という名前でプロファイルが保存される．
いくつかのプロファイルを使い分けたければ， default の例に従って，例えば <code>[myprofile]</code> などという名前でプロファイルを追加すればよい．</p>
</div>
<div class="paragraph">
<p>AWS CLI でコマンドを打つときに，プロファイルを使い分けるには，</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>aws s3 <span class="nb">ls</span> <span class="nt">--profile</span> myprofile</code></pre>
</div>
</div>
<div class="paragraph">
<p>のように， <code>--profile</code> というオプションをつけてコマンドを実行する．</p>
</div>
<div class="paragraph">
<p>いちいち <code>--profile</code> オプションをつけるのが面倒だと感じる場合は， <code>AWS_PROFILE</code> という環境変数を設定するとよい．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span><span class="nb">export </span><span class="nv">AWS_PROFILE</span><span class="o">=</span>myprofile</code></pre>
</div>
</div>
<div class="paragraph">
<p>あるいは，認証情報などを環境変数に設定するテクニックもある．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nb">export </span><span class="nv">AWS_ACCESS_KEY_ID</span><span class="o">=</span>XXXXXX
<span class="nb">export </span><span class="nv">AWS_SECRET_ACCESS_KEY</span><span class="o">=</span>YYYYYY
<span class="nb">export </span><span class="nv">AWS_DEFAULT_REGION</span><span class="o">=</span>ap-northeast-1</code></pre>
</div>
</div>
<div class="paragraph">
<p>上の環境変数は， <code>~/.aws/credentials</code> よりも高い優先度を持つので，環境変数が設定されていればそちらの情報が使用される (<a href="https://docs.aws.amazon.com/cli/latest/userguide/cli-chap-configure.html">参照</a>)．</p>
</div>
</div>
<div class="sect2">
<h3 id="aws_cdk_install">15.3. AWS CDK のインストール</h3>
<div class="paragraph">
<p>読者のために，執筆時点におけるインストールの手順 (Linux 向け) を簡単に記述する．
将来のバージョンでは変更される可能性があるので，常に <a href="https://docs.aws.amazon.com/cdk/latest/guide/getting_started.html">公式のドキュメンテーション</a> で最新の情報をチェックすることを忘れずに．</p>
</div>
<div class="paragraph">
<p>Node.js がインストールされていれば，基本的に以下のコマンドを実行すれば良い．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span><span class="nb">sudo </span>npm <span class="nb">install</span> <span class="nt">-g</span> aws-cdk</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>本書のハンズオンはAWS CDK version 1.100.0 で開発した．
CDK は開発途上のライブラリなので，将来的にAPIが変更される可能性がある．
APIの変更によりエラーが生じた場合は， version 1.100.0 を使用することを推奨する．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>npm <span class="nb">install</span> <span class="nt">-g</span> aws-cdk@1.100</code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>インストールできたか確認するため，以下のコマンドを打って正しくバージョンが表示されることを確認する．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>cdk <span class="nt">--version</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>インストールができたら，以下のコマンドによりAWS側の初期設定を行う．これは一度実行すればOK．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>cdk bootstrap</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p><code>cdk bootstrap</code> を実行するときは，AWSの認証情報とリージョンが正しく設定されていることを確認する．
デフォルトでは <code>~/.aws/config</code> にあるデフォルトのプロファイルが使用される．
デフォルト以外のプロファイルを用いるときは <a href="#aws_cli_install">Section 15.2</a> で紹介したテクニックを使って切り替える．</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>AWS CDK の認証情報の設定は AWS CLI と基本的に同じである．詳しくは <a href="#aws_cli_install">Section 15.2</a> を参照．</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="venv_quick_guide">15.4. Python <code>venv</code> クイックガイド</h3>
<div class="paragraph">
<p>他人からもらったプログラムで， numpy や scipy のバージョンが違う！などの理由で，プログラムが動かない，という経験をしたことがある人は多いのではないだろうか．
もし，自分の計算機の中に一つしか Python 環境がないとすると，プロジェクトを切り替えるごとに正しいバージョンをインストールし直さなければならず，これは大変な手間である．</p>
</div>
<div class="paragraph">
<p>コードのシェアをよりスムーズにするためには，ライブラリのバージョンはプロジェクトごとに管理されるべきである．
それを可能にするのが Python 仮想環境と呼ばれるツールであり， <a href="https://docs.python.org/3/tutorial/venv.html">venv</a>, <a href="https://github.com/pyenv/pyenv">pyenv</a>, <a href="https://docs.conda.io/en/latest/">conda</a> などがよく使われる．</p>
</div>
<div class="paragraph">
<p>そのなかでも， <code>venv</code> は Python に標準搭載されているので，とても便利である．
<code>pyenv</code> や <code>conda</code> は，別途インストールの必要があるが，それぞれの長所もある．</p>
</div>
<div class="paragraph">
<p><code>venv</code> を使って仮想環境を作成するには，</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>python <span class="nt">-m</span> venv .env</code></pre>
</div>
</div>
<div class="paragraph">
<p>と実行する．
これにより <code>.env/</code> というディレクトリが作られ，このディレクトリに依存するライブラリが保存されることになる．</p>
</div>
<div class="paragraph">
<p>この新たな仮想環境を起動するには</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span><span class="nb">source</span> .env/bin/activate</code></pre>
</div>
</div>
<div class="paragraph">
<p>と実行する．</p>
</div>
<div class="paragraph">
<p>シェルのプロンプトに <code>(.env)</code> という文字が追加されていることを確認しよう (<a href="#fig_venv_prompt">Figure 92</a>)．
これが， "いまあなたは venv の中にいますよ" というしるしになる．</p>
</div>
<div id="fig_venv_prompt" class="imageblock text-center">
<div class="content">
<img src="imgs/venv_shell.png" alt="venv shell" width="500">
</div>
<div class="title">Figure 92. venv を起動したときのプロンプト</div>
</div>
<div class="paragraph">
<p>仮想環境を起動すると，それ以降実行する <code>pip</code> コマンドは， <code>.env/</code> 以下にインストールされる．このようにして，プロジェクトごとに使うライブラリのバージョンを切り分けることができる．</p>
</div>
<div class="paragraph">
<p>Python では <code>requirements.txt</code> というファイルにに依存ライブラリを記述するのが一般的な慣例である．他人からもらったプログラムに， <code>requirements.txt</code> が定義されていれば，</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>pip <span class="nb">install</span> <span class="nt">-r</span> requirements.txt</code></pre>
</div>
</div>
<div class="paragraph">
<p>と実行することで，必要なライブラリをインストールし，瞬時に Python 環境を再現することができる．</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>venv による仮想環境を保存するディレクトリの名前は任意に選べることができるが， <code>.env</code> という名前を用いるのが一般的である．</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_謝辞">16. 謝辞</h2>
<div class="sectionbody">
<div class="paragraph">
<p>本原稿の執筆にあたり，以下の方々からの協力を得た．この場を借りて，感謝を表したい．</p>
</div>
<div class="ulist">
<ul>
<li>
<p>勝俣敬寛氏 - Docker イメージの作成</p>
</li>
<li>
<p>香取真知子氏 - ハンズオンプログラムの動作確認</p>
</li>
<li>
<p><a href="https://gitlab.com/shuuji3">@shuuji3</a> - MR <a href="https://gitlab.com/tomomano/intro-aws/-/merge_requests/15">!15</a></p>
</li>
<li>
<p><a href="https://gitlab.com/takatama_jp">@takatama_jp</a> - MR <a href="https://gitlab.com/tomomano/intro-aws/-/merge_requests/14">!14</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>本書の執筆には <a href="https://asciidoctor.org/">Asciidoctor</a> を使用した．</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_著者紹介">17. 著者紹介</h2>
<div class="sectionbody">
<div class="paragraph">
<p>真野 智之 (Tomoyuki Mano)</p>
</div>
<div class="paragraph">
<p>情報理工学博士 (東京大学大学院情報理工学系研究科システム情報学専攻)．
2021年より日本学術振興会特別研究員 (PD) として沖縄科学技術大学院大学 (OIST) でポスドク研究員として働く．
研究分野は神経科学・神経情報学．
趣味は料理・ランニング・鉄道・アニメ・村上春樹．</p>
</div>
<div class="paragraph">
<p>連絡先　<a href="mailto:tomoyukimano@gmail.com">tomoyukimano@gmail.com</a></p>
</div>
<div class="paragraph">
<p>GitLab <a href="https://gitlab.com/tomomano" class="bare">https://gitlab.com/tomomano</a></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_ライセンス">18. ライセンス</h2>
<div class="sectionbody">
<div class="paragraph">
<p>本教科書およびハンズオンのソースコードは <a href="https://creativecommons.org/licenses/by-nc-nd/4.0/">CC BY-NC-ND 4.0</a> に従うライセンスで公開しています．</p>
</div>
<div class="paragraph">
<p>教育など非商用の目的での本教科書の使用や再配布は自由に行うことが可能です．
商用目的で本書の全体またはその一部を無断で転載する行為は，これを固く禁じます．</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="imgs/cc_by_nc_nd.png" alt="cc_by_nc_nd" width="400">
</div>
</div>
<style>
  .imageblock > .title {
    text-align: inherit;
  }
</style>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Version 1.0<br>
Last updated 2021-06-15 01:26:15 UTC
</div>
</div>
<style>
pre.rouge table td { padding: 5px; }
pre.rouge table pre { margin: 0; }
pre.rouge .cm {
  color: #999988;
  font-style: italic;
}
pre.rouge .cp {
  color: #999999;
  font-weight: bold;
}
pre.rouge .c1 {
  color: #999988;
  font-style: italic;
}
pre.rouge .cs {
  color: #999999;
  font-weight: bold;
  font-style: italic;
}
pre.rouge .c, pre.rouge .ch, pre.rouge .cd, pre.rouge .cpf {
  color: #999988;
  font-style: italic;
}
pre.rouge .err {
  color: #a61717;
  background-color: #e3d2d2;
}
pre.rouge .gd {
  color: #000000;
  background-color: #ffdddd;
}
pre.rouge .ge {
  color: #000000;
  font-style: italic;
}
pre.rouge .gr {
  color: #aa0000;
}
pre.rouge .gh {
  color: #999999;
}
pre.rouge .gi {
  color: #000000;
  background-color: #ddffdd;
}
pre.rouge .go {
  color: #888888;
}
pre.rouge .gp {
  color: #555555;
}
pre.rouge .gs {
  font-weight: bold;
}
pre.rouge .gu {
  color: #aaaaaa;
}
pre.rouge .gt {
  color: #aa0000;
}
pre.rouge .kc {
  color: #000000;
  font-weight: bold;
}
pre.rouge .kd {
  color: #000000;
  font-weight: bold;
}
pre.rouge .kn {
  color: #000000;
  font-weight: bold;
}
pre.rouge .kp {
  color: #000000;
  font-weight: bold;
}
pre.rouge .kr {
  color: #000000;
  font-weight: bold;
}
pre.rouge .kt {
  color: #445588;
  font-weight: bold;
}
pre.rouge .k, pre.rouge .kv {
  color: #000000;
  font-weight: bold;
}
pre.rouge .mf {
  color: #009999;
}
pre.rouge .mh {
  color: #009999;
}
pre.rouge .il {
  color: #009999;
}
pre.rouge .mi {
  color: #009999;
}
pre.rouge .mo {
  color: #009999;
}
pre.rouge .m, pre.rouge .mb, pre.rouge .mx {
  color: #009999;
}
pre.rouge .sb {
  color: #d14;
}
pre.rouge .sc {
  color: #d14;
}
pre.rouge .sd {
  color: #d14;
}
pre.rouge .s2 {
  color: #d14;
}
pre.rouge .se {
  color: #d14;
}
pre.rouge .sh {
  color: #d14;
}
pre.rouge .si {
  color: #d14;
}
pre.rouge .sx {
  color: #d14;
}
pre.rouge .sr {
  color: #009926;
}
pre.rouge .s1 {
  color: #d14;
}
pre.rouge .ss {
  color: #990073;
}
pre.rouge .s, pre.rouge .sa, pre.rouge .dl {
  color: #d14;
}
pre.rouge .na {
  color: #008080;
}
pre.rouge .bp {
  color: #999999;
}
pre.rouge .nb {
  color: #0086B3;
}
pre.rouge .nc {
  color: #445588;
  font-weight: bold;
}
pre.rouge .no {
  color: #008080;
}
pre.rouge .nd {
  color: #3c5d5d;
  font-weight: bold;
}
pre.rouge .ni {
  color: #800080;
}
pre.rouge .ne {
  color: #990000;
  font-weight: bold;
}
pre.rouge .nf, pre.rouge .fm {
  color: #990000;
  font-weight: bold;
}
pre.rouge .nl {
  color: #990000;
  font-weight: bold;
}
pre.rouge .nn {
  color: #555555;
}
pre.rouge .nt {
  color: #000080;
}
pre.rouge .vc {
  color: #008080;
}
pre.rouge .vg {
  color: #008080;
}
pre.rouge .vi {
  color: #008080;
}
pre.rouge .nv, pre.rouge .vm {
  color: #008080;
}
pre.rouge .ow {
  color: #000000;
  font-weight: bold;
}
pre.rouge .o {
  color: #000000;
  font-weight: bold;
}
pre.rouge .w {
  color: #bbbbbb;
}
pre.rouge {
  background-color: #f8f8f8;
}
</style>
</body>
</html>